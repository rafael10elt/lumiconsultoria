<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumi Consultoria</title>
    <script src="https://cdn.tailwindcss.com"></script>
     <link rel="icon" href="LogoLumi.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
:root {
  --brand-gold: #BFA16A;
  --brand-dark: #373737;
  
}

body {
  font-family: 'Inter', sans-serif;
  background-color: #f3f4f6;
  color: var(--brand-dark);
  transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out;
  .logo-symbol { width: 50px; height: 50px; background: linear-gradient(135deg, var(--dark-overlay), var(--dark-overlay)); border-radius: 10px; margin-right: 15px; display: flex; align-items: center; justify-content: center; position: relative; animation: glow 2s ease-in-out infinite alternate; }
        @keyframes glow { from { box-shadow: 0 0 20px var(--accent-orange); } to { box-shadow: 0 0 30px var(--electric-blue), 0 0 40px var(--electric-blue); } }
}

.bg-brand-gold { background-color: var(--brand-gold); }
.text-brand-gold { color: var(--brand-gold); }
.border-brand-gold { border-color: var(--brand-gold); }
.hover\:bg-brand-gold-dark:hover { background-color: #a68a5a; }
.bg-brand-dark { background-color: var(--brand-dark); }
.text-brand-dark { color: var(--brand-dark); }

.focus\:ring-brand-gold:focus {
  --tw-ring-color: var(--brand-gold);
}
.focus\:border-brand-gold:focus {
  --tw-border-opacity: 1;
  border-color: var(--brand-gold);
}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.modal-bg-animate { animation: fadeIn 0.3s ease-out forwards; }
.modal-content-animate { animation: slideIn 0.3s ease-out forwards; }

.kanban-column { 
    min-height: 400px; 
    background-color: #e5e7eb;
}
.dark .kanban-column {
    background-color: #1f2937;
}

.dark .fc-daygrid-day-number, 
.dark .fc-col-header-cell-cushion, 
.dark .fc-list-day-text, 
.dark .fc-list-day-side-text { 
  color: #e5e7eb; 
}
.dark .fc-theme-standard .fc-list-day-cushion { 
  background-color: #1f2937; 
}
.dark .fc-theme-standard td, 
.dark .fc-theme-standard th { 
  border-color: #374151; 
}

.filter-btn-active {
  background-color: var(--brand-gold) !important;
  color: white !important;
}
/* Adicione este CSS para tornar os rankings roláveis */
        #dash-top-consultants-hours,
        #dash-top-consultants-count,
        #dash-top-clients-list,
        #dash-top-clients-hours-list,
        #dash-top-clients-receitas-list,
        #dash-top-credores-custos-list { /* <-- ID ADICIONADO AQUI */
            max-height: 250px;
            overflow-y: auto;
        }
/* Adicione este novo código no final da sua tag <style> */
        @media (max-width: 1023px) {
            /* 
              Esta classe é adicionada via JS ao contêiner .flex-col.flex-1
              quando as visualizações de lista ou calendário estão ativas no mobile.
              Isso impede que o container principal se alargue, corrigindo o
              posicionamento de modais com `position: fixed`.
            */
            .is-overflowing-view {
                overflow-x: hidden;
            }
        }
        /* Adicione este código para ocultar o botão do calendário no mobile */
        @media (max-width: 1023px) {
            .view-toggle-btn[data-view="calendar-view"] {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-300 transition-colors duration-300">

    <!-- Tela de Login -->
    <div id="login-screen" class="flex items-center justify-center min-h-screen px-4">
        <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-xl shadow-lg dark:bg-gray-800">
            <div class="flex flex-col items-center">
               <div class="flex items-center mb-4">
  <div class="logo-symbol">
    <img src="/images/LogoLumi.png" alt="Logo Lumitech" class="w-20 h-20 object-contain mr-3" />
  </div>
  <div class="text-center">
    <h1 class="text-3xl font-bold text-brand-dark dark:text-gray-200">LUMI</h1>
    <p class="text-sm text-gray-500 dark:text-gray-400 -mt-1">CONSULTORIA</p>
  </div>
</div>
                <h2 class="text-2xl font-bold text-center text-gray-900 dark:text-white">Acesse o sistema</h2>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div><input id="username" name="username" type="text" value="Admin" autocomplete="username" class="relative block w-full px-3 py-2 text-gray-900 placeholder-gray-500 border border-gray-300 rounded-t-md focus:outline-none focus:ring-brand-gold focus:border-brand-gold focus:z-10 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-500 dark:text-white" placeholder="Usuário"></div>
                <div><input id="password" name="password" type="password" value="123" autocomplete="current-password" class="relative block w-full px-3 py-2 text-gray-900 placeholder-gray-500 border border-gray-300 rounded-b-md focus:outline-none focus:ring-brand-gold focus:border-brand-gold focus:z-10 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-500 dark:text-white" placeholder="Senha"></div>
                <div><button type="submit" class="relative flex justify-center w-full px-4 py-2 text-sm font-medium text-white border border-transparent rounded-md group bg-brand-dark hover:bg-brand-gold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-gold transition-colors">Entrar</button></div>
            </form>
        </div>
    </div>

    <!-- Sistema Principal -->
    <div id="main-app" class="hidden">
        <div class="flex h-screen bg-gray-100 dark:bg-gray-900">
            <aside id="sidebar" class="absolute z-30 flex-col items-center w-20 text-white transform -translate-x-full lg:relative lg:flex lg:translate-x-0 transition-transform duration-200 ease-in-out bg-brand-dark dark:bg-gray-800">
                <div class="logo-symbol">
                <img src="/images/LogoLumi.png" alt="Logo Lumitech" style="width: 58px; height: 50px; object-fit: contain; position: absolute; left: 12px; top: 15px; z-index: 2; pointer-events: none;" />
               </div>
                <nav class="flex-1 mt-6">
                    <a href="#" class="nav-link flex items-center justify-center w-12 h-12 mb-4 rounded-lg bg-brand-gold text-white" data-target="dashboard" title="Dashboard"><i class="fas fa-chart-pie"></i></a>
                    <a href="#" class="nav-link flex items-center justify-center w-12 h-12 mb-4 rounded-lg text-gray-400 hover:bg-brand-gold hover:text-white" data-target="visitas" title="Visitas"><i class="fas fa-calendar-check"></i></a>
                    <a href="#" class="nav-link flex items-center justify-center w-12 h-12 mb-4 rounded-lg text-gray-400 hover:bg-brand-gold hover:text-white" data-target="requisicao" title="Requisição"><i class="fas fa-clipboard-list"></i></a>
                    <a href="#" class="nav-link flex items-center justify-center w-12 h-12 mb-4 rounded-lg text-gray-400 hover:bg-brand-gold hover:text-white" data-target="financeiro" title="Financeiro"><i class="fas fa-wallet"></i></a>
                    <a href="#" class="nav-link flex items-center justify-center w-12 h-12 mb-4 rounded-lg text-gray-400 hover:bg-brand-gold hover:text-white" data-target="clientes" title="Clientes"><i class="fas fa-handshake"></i></a>
                    <a href="#" class="nav-link flex items-center justify-center w-12 h-12 mb-4 rounded-lg text-gray-400 hover:bg-brand-gold hover:text-white" data-target="rh" title="RH"><i class="fas fa-briefcase"></i></a>
                </nav>
            </aside>
            <!-- Overlay for mobile sidebar -->
            <div id="sidebar-overlay" class="fixed inset-0 z-20 bg-black bg-opacity-50 hidden lg:hidden"></div>

            <div class="flex flex-col flex-1">
                <header class="flex items-center justify-between h-20 px-6 bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                    <div class="flex items-center">
                        <button id="sidebar-toggle" class="text-gray-500 dark:text-gray-400 focus:outline-none lg:hidden"><i class="fas fa-bars fa-lg"></i></button>
                        <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 dark:text-white ml-4 lg:ml-0">Lumi Consultoria</h1>
                    </div>
                    <div class="flex items-center space-x-2 sm:space-x-4">
                        <div class="text-right">
                             <p id="logged-user-name" class="text-sm font-semibold text-gray-700 dark:text-gray-200"></p>
                             <p class="text-xs text-gray-500 dark:text-gray-400 hidden sm:block">Administrador</p>
                        </div>
                        <img class="w-10 h-10 rounded-full" src="https://i.pravatar.cc/150?u=admin" alt="Avatar">
                        
                                               <button id="logout-button" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700" title="Sair"><i class="fas fa-sign-out-alt fa-lg"></i></button>
                    </div>
                </header>
                <main class="flex-1 p-6 overflow-y-auto">
                    
                    <div id="dashboard" class="page">
                        <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                            <div>
                                <h2 class="text-3xl font-bold text-gray-800 dark:text-white">Dashboard</h2>
                                <p class="text-gray-600 dark:text-gray-300">Visão geral e métricas chave do sistema.</p>
                            </div>
                            <div class="flex space-x-2 w-full sm:w-auto">
                                <button id="show-insights-btn" class="bg-yellow-500 text-white px-4 py-2 rounded-lg shadow hover:bg-yellow-600 transition-colors"><i class="fas fa-lightbulb mr-2"></i>Gerar Insights</button>
                                <button id="show-report-modal-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 transition-colors"><i class="fas fa-file-pdf mr-2"></i>Gerar Relatório</button>
                            </div>
                        </div>

                         <div class="mb-6 border-b border-gray-200 dark:border-gray-700">
                            <ul class="flex flex-wrap -mb-px text-sm font-medium text-center">
                                <li class="mr-2"><button class="dashboard-nav-btn inline-block p-4 border-b-2 rounded-t-lg border-brand-gold text-brand-gold" data-target="dashboard-balanco">Balanço</button></li>
                                <li class="mr-2"><button class="dashboard-nav-btn inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 dark:hover:text-gray-300 hover:border-gray-300" data-target="dashboard-receitas">Receitas</button></li>
                                <li class="mr-2"><button class="dashboard-nav-btn inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 dark:hover:text-gray-300 hover:border-gray-300" data-target="dashboard-custos">Custos</button></li>
                                <li class="mr-2"><button class="dashboard-nav-btn inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 dark:hover:text-gray-300 hover:border-gray-300" data-target="dashboard-visitas">Visitas</button></li>
                            </ul>
                        </div>

                        <div id="dashboard-balanco" class="dashboard-content">
                            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow mb-6">
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                                    <div><label for="dash-fin-status" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Status</label><select id="dash-fin-status" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white"><option value="">Todos</option><option value="Pago">Pago</option><option value="Pendente">Pendente</option></select></div>
                                    <div><label for="dash-fin-start" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">De</label><input type="date" id="dash-fin-start" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></div>
                                    <div><label for="dash-fin-end" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Até</label><input type="date" id="dash-fin-end" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></div>
                                    <div class="flex items-center justify-start sm:justify-end space-x-2">
                                        <button class="dash-fin-quick-filter px-3 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200" data-period="week">Semana</button>
                                        <button class="dash-fin-quick-filter px-3 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200" data-period="month">Mês</button>
                                        <button class="dash-fin-quick-filter px-3 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200" data-period="year">Ano</button>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow"><div class="flex items-center"><div class="p-3 rounded-full bg-green-100 dark:bg-green-900 mr-4"><i class="fas fa-balance-scale fa-2x text-green-500"></i></div><div><p class="text-sm font-medium text-gray-600 dark:text-gray-300">Balanço Financeiro</p><p id="dash-balance" class="text-3xl font-bold text-gray-900 dark:text-white">R$ 0,00</p></div></div></div>
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow"><div class="flex items-center"><div class="p-3 rounded-full bg-blue-100 dark:bg-blue-900 mr-4"><i class="fas fa-arrow-up fa-2x text-blue-500"></i></div><div><p class="text-sm font-medium text-gray-600 dark:text-gray-300">Total de Receitas</p><p id="dash-revenue" class="text-3xl font-bold text-gray-900 dark:text-white">R$ 0,00</p></div></div></div>
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow"><div class="flex items-center"><div class="p-3 rounded-full bg-red-100 dark:bg-red-900 mr-4"><i class="fas fa-arrow-down fa-2x text-red-500"></i></div><div><p class="text-sm font-medium text-gray-600 dark:text-gray-300">Total de Custos</p><p id="dash-costs" class="text-3xl font-bold text-gray-900 dark:text-white">R$ 0,00</p></div></div></div>
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow lg:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div><div class="flex items-center"><div class="p-3 rounded-full bg-yellow-100 dark:bg-yellow-900 mr-4"><i class="fas fa-hourglass-half fa-2x text-yellow-500"></i></div><div><p class="text-sm font-medium text-gray-600 dark:text-gray-300">Receitas Pendentes</p><p id="dash-revenue-pending" class="text-2xl font-bold text-gray-900 dark:text-white">R$ 0,00</p></div></div></div>
                                    <div><div class="flex items-center"><div class="p-3 rounded-full bg-orange-100 dark:bg-orange-900 mr-4"><i class="fas fa-exclamation-circle fa-2x text-orange-500"></i></div><div><p class="text-sm font-medium text-gray-600 dark:text-gray-300">Custos Pendentes</p><p id="dash-costs-pending" class="text-2xl font-bold text-gray-900 dark:text-white">R$ 0,00</p></div></div></div>
                                </div>
                            </div>
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                                <h4 class="font-bold text-lg text-gray-800 dark:text-white mb-4">Receitas vs. Custos por Mês</h4>
                                <canvas id="finance-chart"></canvas>
                            </div>
                        </div>
<div id="dashboard-receitas" class="dashboard-content hidden">
                            <!-- Filtros da Aba Receitas -->
                            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow mb-6">
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                                    <div><label for="dash-rec-status" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Status</label><select id="dash-rec-status" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white"><option value="">Todos</option><option value="Pago">Pago</option><option value="Pendente">Pendente</option></select></div>
                                    <div><label for="dash-rec-cliente" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Cliente</label><select id="dash-rec-cliente" class="cliente-select bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select></div>
                                    <div><label for="dash-rec-start" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">De</label><input type="date" id="dash-rec-start" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></div>
                                    <div><label for="dash-rec-end" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Até</label><input type="date" id="dash-rec-end" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></div>
                                </div>
                            </div>
                            <!-- Cards de Métricas de Receitas -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow"><div class="flex items-center"><div class="p-3 rounded-full bg-blue-100 dark:bg-blue-900 mr-4"><i class="fas fa-arrow-up fa-2x text-blue-500"></i></div><div><p class="text-sm font-medium text-gray-600 dark:text-gray-300">Total de Receitas (período)</p><p id="dash-rec-total" class="text-3xl font-bold text-gray-900 dark:text-white">R$ 0,00</p></div></div></div>
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow"><div class="flex items-center"><div class="p-3 rounded-full bg-yellow-100 dark:bg-yellow-900 mr-4"><i class="fas fa-hourglass-half fa-2x text-yellow-500"></i></div><div><p class="text-sm font-medium text-gray-600 dark:text-gray-300">Receitas Pendentes (período)</p><p id="dash-rec-pending" class="text-3xl font-bold text-gray-900 dark:text-white">R$ 0,00</p></div></div></div>
                            </div>
                            <!-- Gráfico e Ranking de Clientes -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                                    <h4 class="font-bold text-lg text-gray-800 dark:text-white mb-4">Receitas por Cliente</h4>
                                    <canvas id="receitas-by-cliente-chart"></canvas>
                                </div>
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                                    <h4 class="font-bold text-lg text-gray-800 dark:text-white mb-4">Ranking de Clientes (por Receita)</h4>
                                    <ul id="dash-top-clients-receitas-list" class="space-y-3">
                                        <!-- Ranking será inserido aqui -->
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- NOVO PAINEL DA ABA CUSTOS (Placeholder) -->
                         <div id="dashboard-custos" class="dashboard-content hidden">
                            <!-- Filtros da Aba Custos -->
                            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow mb-6">
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                                    <div><label for="dash-cos-status" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Status</label><select id="dash-cos-status" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white"><option value="">Todos</option><option value="Pago">Pago</option><option value="Pendente">Pendente</option></select></div>
                                    <div><label for="dash-cos-credor" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Credor</label><input type="text" id="dash-cos-credor" placeholder="Nome do credor..." class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div>
                                    <div><label for="dash-cos-start" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">De</label><input type="date" id="dash-cos-start" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></div>
                                    <div><label for="dash-cos-end" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Até</label><input type="date" id="dash-cos-end" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></div>
                                </div>
                            </div>
                            <!-- Cards de Métricas de Custos -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow"><div class="flex items-center"><div class="p-3 rounded-full bg-red-100 dark:bg-red-900 mr-4"><i class="fas fa-arrow-down fa-2x text-red-500"></i></div><div><p class="text-sm font-medium text-gray-600 dark:text-gray-300">Total de Custos (período)</p><p id="dash-cos-total" class="text-3xl font-bold text-gray-900 dark:text-white">R$ 0,00</p></div></div></div>
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow"><div class="flex items-center"><div class="p-3 rounded-full bg-orange-100 dark:bg-orange-900 mr-4"><i class="fas fa-exclamation-circle fa-2x text-orange-500"></i></div><div><p class="text-sm font-medium text-gray-600 dark:text-gray-300">Custos Pendentes (período)</p><p id="dash-cos-pending" class="text-3xl font-bold text-gray-900 dark:text-white">R$ 0,00</p></div></div></div>
                            </div>
                            <!-- Gráfico e Ranking de Credores -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                                    <h4 class="font-bold text-lg text-gray-800 dark:text-white mb-4">Custos por Credor</h4>
                                    <canvas id="custos-by-credor-chart"></canvas>
                                </div>
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                                    <h4 class="font-bold text-lg text-gray-800 dark:text-white mb-4">Ranking de Credores (por Custo)</h4>
                                    <ul id="dash-top-credores-custos-list" class="space-y-3">
                                        <!-- Ranking será inserido aqui -->
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div id="dashboard-visitas" class="dashboard-content hidden">
                            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow mb-6">
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                                    <div><label for="dash-visit-start" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">De</label><input type="date" id="dash-visit-start" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></div>
                                    <div><label for="dash-visit-end" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Até</label><input type="date" id="dash-visit-end" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></div>
                                    
                                    <!-- FILTROS ADICIONADOS (inicialmente ocultos) -->
                                    <div id="dash-visit-consultor-wrapper" class="hidden">
                                        <label for="dash-visit-consultor" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Consultor</label>
                                        <select id="dash-visit-consultor" class="consultor-select bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select>
                                    </div>
                                    <div id="dash-visit-cliente-wrapper" class="hidden">
                                        <label for="dash-visit-cliente" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Cliente</label>
                                        <select id="dash-visit-cliente" class="cliente-select bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select>
                                    </div>
                                    <!-- FIM DOS FILTROS ADICIONADOS -->

                                    <div class="col-span-full flex items-center justify-start sm:justify-end space-x-2">
                                        <button class="dash-visit-quick-filter px-3 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200" data-period="week">Semana</button>
                                        <button class="dash-visit-quick-filter px-3 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200" data-period="month">Mês</button>
                                        <button class="dash-visit-quick-filter px-3 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200" data-period="year">Ano</button>
                                    </div>
                                </div>
                            </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow"><div class="flex items-center"><div class="p-3 rounded-full bg-green-100 dark:bg-green-900 mr-4"><i class="fas fa-clock fa-2x text-green-500"></i></div><div><p class="text-sm font-medium text-gray-600 dark:text-gray-300">Horas Concluídas</p><p id="dash-hours-completed" class="text-3xl font-bold text-gray-900 dark:text-white">0h 0m</p></div></div></div>
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow"><div class="flex items-center"><div class="p-3 rounded-full bg-blue-100 dark:bg-blue-900 mr-4"><i class="far fa-clock fa-2x text-blue-500"></i></div><div><p class="text-sm font-medium text-gray-600 dark:text-gray-300">Horas Agendadas</p><p id="dash-hours-scheduled" class="text-3xl font-bold text-gray-900 dark:text-white">0h 0m</p></div></div></div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div class="lg:col-span-1 bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                                    <h4 class="font-bold text-lg text-gray-800 dark:text-white mb-4">Visitas por Status</h4>
                                    <canvas id="visits-status-chart"></canvas>
                                </div>
                                 <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                                     <h4 class="font-bold text-lg text-gray-800 dark:text-white mb-4">Ranking de Consultores (Visitas Concluídas)</h4>
                                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <h5 class="font-semibold text-gray-700 dark:text-gray-200 mb-2">Por Horas Trabalhadas</h5>
                                            <ul id="dash-top-consultants-hours" class="space-y-2"></ul>
                                        </div>
                                        <div>
                                            <h5 class="font-semibold text-gray-700 dark:text-gray-200 mb-2">Por Nº de Visitas</h5>
                                            <ul id="dash-top-consultants-count" class="space-y-2"></ul>
                                        </div>
                                     </div>
                                </div>
                            </div> <!-- Este é o fechamento do grid principal -->

                            <!-- Bloco de análise de clientes por Nº de Visitas -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                                    <h4 class="font-bold text-lg text-gray-800 dark:text-white mb-4">Visitas por Clientes</h4>
                                    <canvas id="clients-visits-chart"></canvas>
                                </div>
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                                    <h4 class="font-bold text-lg text-gray-800 dark:text-white mb-4">Ranking de Clientes (por Nº de Visitas)</h4>
                                    <ul id="dash-top-clients-list" class="space-y-3">
                                        <!-- Ranking por contagem será inserido aqui -->
                                    </ul>
                                </div>
                            </div>

                            <!-- NOVO Bloco de análise de clientes por Horas -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                                    <h4 class="font-bold text-lg text-gray-800 dark:text-white mb-4">Horas por Cliente</h4>
                                    <canvas id="clients-hours-chart"></canvas>
                                </div>
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                                    <h4 class="font-bold text-lg text-gray-800 dark:text-white mb-4">Ranking de Clientes (por Horas)</h4>
                                    <ul id="dash-top-clients-hours-list" class="space-y-3">
                                        <!-- Ranking por horas será inserido aqui -->
                                    </ul>
                                </div>
                            </div>       
                        </div>
                    </div>

                    <div id="rh" class="page hidden">
                         <div class="mb-4">
                            <h2 class="text-3xl font-bold text-gray-800 dark:text-white">Recursos Humanos</h2>
                            <p class="text-gray-600 dark:text-gray-300">Gerenciamento de consultores e equipe.</p>
                        </div>
                        <div class="mb-6 border-b border-gray-200 dark:border-gray-700">
                            <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="rh-tabs">
                                <li class="mr-2"><button class="rh-tab-btn inline-block p-4 border-b-2 rounded-t-lg border-brand-gold text-brand-gold" data-target="consultores-content">Consultores <span id="consultores-count-badge" class="ml-2 bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs font-semibold px-2 py-0.5 rounded-full">0</span></button></li>
                                <li class="mr-2"><button class="rh-tab-btn inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300" data-target="aniversariantes-content">Aniversariantes <span id="birthday-count-badge" class="ml-2 bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs font-semibold px-2 py-0.5 rounded-full">0</span></button></li>
                                <li class="mr-2"><button class="rh-tab-btn inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300" data-target="ferias-content">Férias <span id="ferias-count-badge" class="ml-2 bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs font-semibold px-2 py-0.5 rounded-full">0</span></button></li>
                                <li class="mr-2"><button class="rh-tab-btn inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300" data-target="atestados-content">Atestados <span id="atestados-count-badge" class="ml-2 bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs font-semibold px-2 py-0.5 rounded-full">0</span></button></li>
                                 <li class="mr-2"><button class="rh-tab-btn inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300" data-target="epis-content">EPIs <span id="epis-count-badge" class="ml-2 bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs font-semibold px-2 py-0.5 rounded-full">0</span></button></li>
                                <li class="mr-2"><button class="rh-tab-btn inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300" data-target="ativos-content">Ativos <span id="ativos-count-badge" class="ml-2 bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs font-semibold px-2 py-0.5 rounded-full">0</span></button></li>
                            </ul>
                        </div>
                        
                        <div id="consultores-content" class="rh-tab-content">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                                <div class="relative w-full max-w-xs">
                                    <input type="text" id="rh-search" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full pl-10 p-2.5  dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Buscar consultor...">
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none"><i class="fas fa-search text-gray-400"></i></div>
                                </div>                       
                                <div class="p-1 bg-gray-200 dark:bg-gray-700 rounded-lg flex space-x-1" id="consultor-status-filters">
                                    <button class="consultor-status-filter-btn filter-btn-active px-3 py-1 rounded-md shadow-sm" data-status="Todos">Todos</button>
                                    <button class="consultor-status-filter-btn px-3 py-1 rounded-md" data-status="Ativo">Ativos</button>
                                    <button class="consultor-status-filter-btn px-3 py-1 rounded-md" data-status="Inativo">Inativos</button>
                                </div>
                                <button id="show-rh-form" class="bg-brand-gold text-white px-4 py-2 rounded-lg shadow hover:bg-brand-gold-dark transition-colors w-full sm:w-auto">Novo Consultor</button>
                            </div>
                            <div id="rh-cards-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
                            <div id="rh-form-container" class="hidden mt-6">
                                <div class="p-6 bg-white rounded-lg shadow-md dark:bg-gray-800">
                                <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Cadastro de Consultor</h3>
                                <form id="rh-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    <div class="md:col-span-2 lg:col-span-3 flex items-center space-x-4">
                                        <img id="rh-foto-preview" src="https://placehold.co/100x100/e2e8f0/cbd5e0?text=Foto" class="w-24 h-24 rounded-full object-cover">
                                        <input type="file" id="rh-foto" class="text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-brand-gold file:text-white hover:file:bg-brand-gold-dark">
                                    </div>
                                    <div><label for="rh-nome" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Nome Completo</label><input type="text" id="rh-nome" name="name" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" required></div>
                                    <div><label for="rh-nasc" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Data de Nascimento</label><input type="date" id="rh-nasc" name="nascimento" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div>
                                    <div><label for="rh-tel" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Telefone</label><input type="tel" id="rh-tel" name="telefone" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div>
                                    <div><label for="rh-email" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">E-mail</label><input type="email" id="rh-email" name="email" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div>
                                    <div><label for="rh-login" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Login</label><input type="text" id="rh-login" name="login" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div>
                                    <div><label for="rh-senha" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Senha</label><input type="password" id="rh-senha" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div>
                                    <div><label for="rh-inicio" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Data Início Vínculo</label><input type="date" id="rh-inicio" name="inicio" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div>
                                    <div><label for="rh-fim" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Data Fim Vínculo</label><input type="date" id="rh-fim" name="fim" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div>
                                    <div><label for="rh-cnpj" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">CNPJ</label><input type="text" id="rh-cnpj" name="cnpj" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div>
                                    <div><label for="rh-razao" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Razão Social</label><input type="text" id="rh-razao" name="razao" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div>
                                    <div><label for="rh-valor" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Valor por Hora</label><input type="number" id="rh-valor" name="valor" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div>
                                    <div>
                                        <label for="rh-status" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Status</label>
                                        <select id="rh-status" name="status" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                                            <option value="Ativo">Ativo</option>
                                            <option value="Inativo">Inativo</option>
                                        </select>
                                    </div>
                                    <div>
    <label for="rh-role" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Função</label>
    <select id="rh-role" name="role" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
        <option value="Consultor">Consultor</option>
        <option value="Gestor">Gestor</option>
        <option value="Admin">Admin</option>
    </select>
</div>
                                    <div class="md:col-span-2 lg:col-span-3"><label for="rh-endereco" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Endereço</label><input type="text" name="endereco" id="rh-endereco" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div>
                                    <div class="md:col-span-2 lg:col-span-3"><label for="rh-obs" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Observação</label><textarea id="rh-obs" name="obs" rows="4" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-brand-gold focus:border-brand-gold dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></textarea></div>
                                    <div class="md:col-span-2 lg:col-span-3 flex justify-end space-x-4">
                                        <button type="button" id="cancel-rh-form" class="px-6 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">Cancelar</button>
                                        <button type="submit" class="px-6 py-2 text-sm font-medium text-white bg-brand-gold rounded-md hover:bg-brand-gold-dark">Salvar</button>
                                    </div>
                                </form>
                                </div>
                            </div>
                        </div>
                        <div id="aniversariantes-content" class="rh-tab-content hidden"><h3 class="text-2xl font-semibold mb-4 text-gray-800 dark:text-white">Aniversariantes do Mês</h3><div id="birthday-cards-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div></div>
                        <div id="ferias-content" class="rh-tab-content hidden"><div class="flex justify-between items-center mb-4"><h3 class="text-2xl font-semibold text-gray-800 dark:text-white">Controle de Férias</h3><button id="show-ferias-form" class="bg-brand-gold text-white px-4 py-2 rounded-lg shadow hover:bg-brand-gold-dark transition-colors">Agendar Férias</button></div><div id="ferias-history-container"><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 p-4 bg-white dark:bg-gray-800 rounded-lg shadow"><div><label for="ferias-filter-name" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Consultor</label><input type="text" id="ferias-filter-name" placeholder="Buscar por nome..." class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div><div><label for="ferias-filter-start" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Período De</label><input type="date" id="ferias-filter-start" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600"></div><div><label for="ferias-filter-end" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Período Até</label><input type="date" id="ferias-filter-end" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600"></div></div><div class="relative overflow-x-auto shadow-md sm:rounded-lg hidden md:block"><table class="w-full text-sm text-left text-gray-500 dark:text-gray-400"><thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"><tr><th scope="col" class="px-6 py-3">Consultor</th><th scope="col" class="px-6 py-3">Início</th><th scope="col" class="px-6 py-3">Retorno</th><th scope="col" class="px-6 py-3">Dias</th><th scope="col" class="px-6 py-3">Ações</th></tr></thead><tbody id="ferias-table-body"></tbody></table></div>
<div id="ferias-cards-container" class="grid grid-cols-1 gap-4 md:hidden"></div></div><div id="ferias-form-container" class="hidden mt-6 p-6 bg-white rounded-lg shadow-md dark:bg-gray-800"><h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Agendar Novas Férias</h3><form id="ferias-form" class="grid grid-cols-1 md:grid-cols-3 gap-6"><div><label for="ferias-consultor" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Consultor</label><select id="ferias-consultor" class="consultor-select bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select></div><div><label for="ferias-inicio" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Data de Início</label><input type="date" id="ferias-inicio" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600"></div><div><label for="ferias-retorno" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Data de Retorno</label><input type="date" id="ferias-retorno" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600"></div><div class="md:col-span-3 flex justify-end space-x-4"><button type="button" class="cancel-sub-form px-6 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600" data-form="ferias-form-container" data-history="ferias-history-container">Cancelar</button><button type="submit" class="px-6 py-2 text-sm font-medium text-white bg-brand-gold rounded-md hover:bg-brand-gold-dark">Salvar</button></div></form></div></div>
                        <div id="atestados-content" class="rh-tab-content hidden"><div class="flex justify-between items-center mb-4"><h3 class="text-2xl font-semibold text-gray-800 dark:text-white">Atestados Médicos</h3><button id="show-atestados-form" class="bg-brand-gold text-white px-4 py-2 rounded-lg shadow hover:bg-brand-gold-dark transition-colors">Novo Atestado</button></div><div id="atestados-history-container"><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 p-4 bg-white dark:bg-gray-800 rounded-lg shadow"><div><label for="atestados-filter-name" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Consultor</label><input type="text" id="atestados-filter-name" placeholder="Buscar por nome..." class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div><div><label for="atestados-filter-start" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Período De</label><input type="date" id="atestados-filter-start" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600"></div><div><label for="atestados-filter-end" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Período Até</label><input type="date" id="atestados-filter-end" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600"></div></div><div class="relative overflow-x-auto shadow-md sm:rounded-lg hidden md:block"><table class="w-full text-sm text-left text-gray-500 dark:text-gray-400"><thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"><tr><th scope="col" class="px-6 py-3">Consultor</th><th scope="col" class="px-6 py-3">Início</th><th scope="col" class="px-6 py-3">Retorno</th><th scope="col" class="px-6 py-3">Anexo</th><th scope="col" class="px-6 py-3">Ações</th></tr></thead><tbody id="atestados-table-body"></tbody></table></div>
<div id="atestados-cards-container" class="grid grid-cols-1 gap-4 md:hidden"></div></div><div id="atestados-form-container" class="hidden mt-6 p-6 bg-white rounded-lg shadow-md dark:bg-gray-800"><h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Lançar Atestado</h3><form id="atestados-form" class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label for="atestados-consultor" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Consultor</label><select id="atestados-consultor" class="consultor-select bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600"></select></div><div><label for="atestados-inicio" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Data de Início</label><input type="date" id="atestados-inicio" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600"></div><div><label for="atestados-retorno" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Data de Retorno</label><input type="date" id="atestados-retorno" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600"></div><div><label for="atestados-anexo" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Anexar Documento</label><input type="file" id="atestados-anexo" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 dark:text-gray-400 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400"></div><div class="md:col-span-2 flex justify-end space-x-4"><button type="button" class="cancel-sub-form px-6 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600" data-form="atestados-form-container" data-history="atestados-history-container">Cancelar</button><button type="submit" class="px-6 py-2 text-sm font-medium text-white bg-brand-gold rounded-md hover:bg-brand-gold-dark">Salvar</button></div></form></div></div>
                        <div id="epis-content" class="rh-tab-content hidden"><div class="flex justify-between items-center mb-4"><h3 class="text-2xl font-semibold text-gray-800 dark:text-white">Controle de EPIs</h3><button id="show-epis-form" class="bg-brand-gold text-white px-4 py-2 rounded-lg shadow hover:bg-brand-gold-dark transition-colors">Nova Entrega</button></div><div id="epis-history-container"><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 p-4 bg-white dark:bg-gray-800 rounded-lg shadow"><div><label for="epis-filter-name" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Consultor</label><input type="text" id="epis-filter-name" placeholder="Buscar por nome..." class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div><div><label for="epis-filter-start" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Período De</label><input type="date" id="epis-filter-start" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600"></div><div><label for="epis-filter-end" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Período Até</label><input type="date" id="epis-filter-end" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600"></div></div><div class="relative overflow-x-auto shadow-md sm:rounded-lg hidden md:block"><table class="w-full text-sm text-left text-gray-500 dark:text-gray-400"><thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"><tr><th scope="col" class="px-6 py-3">Consultor</th><th scope="col" class="px-6 py-3">Item</th><th scope="col" class="px-6 py-3">Qtd</th><th scope="col" class="px-6 py-3">Data</th><th scope="col" class="px-6 py-3">Ações</th></tr></thead><tbody id="epis-table-body"></tbody></table></div>
<div id="epis-cards-container" class="grid grid-cols-1 gap-4 md:hidden"></div></div><div id="epis-form-container" class="hidden mt-6 p-6 bg-white rounded-lg shadow-md dark:bg-gray-800"><h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Registrar Entrega de EPI</h3><form id="epis-form" class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label for="epis-consultor" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Consultor</label><select id="epis-consultor" class="consultor-select bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600"></select></div><div><label for="epis-item" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Item</label><select id="epis-item" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600"><option>Camisa</option><option>Botina</option><option>Óculos de Segurança</option></select></div><div><label for="epis-qtd" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Quantidade</label><input type="number" id="epis-qtd" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600" value="1" min="1"></div><div><label for="epis-data" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Data de Entrega</label><input type="date" id="epis-data" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600"></div><div class="md:col-span-2"><label for="epis-obs" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Observação</label><textarea id="epis-obs" rows="3" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-brand-gold focus:border-brand-gold dark:bg-gray-700 dark:border-gray-600"></textarea></div><div class="md:col-span-2 flex justify-end space-x-4"><button type="button" class="cancel-sub-form px-6 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600" data-form="epis-form-container" data-history="epis-history-container">Cancelar</button><button type="submit" class="px-6 py-2 text-sm font-medium text-white bg-brand-gold rounded-md hover:bg-brand-gold-dark">Salvar</button></div></form></div></div>
                        <div id="ativos-content" class="rh-tab-content hidden"><div class="flex justify-between items-center mb-4"><h3 class="text-2xl font-semibold text-gray-800 dark:text-white">Controle de Ativos</h3><button id="show-ativos-form" class="bg-brand-gold text-white px-4 py-2 rounded-lg shadow hover:bg-brand-gold-dark transition-colors">Novo Ativo</button></div><div id="ativos-history-container"><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 p-4 bg-white dark:bg-gray-800 rounded-lg shadow"><div><label for="ativos-filter-name" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Consultor</label><input type="text" id="ativos-filter-name" placeholder="Buscar por nome..." class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div><div><label for="ativos-filter-start" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Período De</label><input type="date" id="ativos-filter-start" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600"></div><div><label for="ativos-filter-end" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Período Até</label><input type="date" id="ativos-filter-end" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600"></div></div><div class="relative overflow-x-auto shadow-md sm:rounded-lg hidden md:block"><table class="w-full text-sm text-left text-gray-500 dark:text-gray-400"><thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"><tr><th scope="col" class="px-6 py-3">Consultor</th><th scope="col" class="px-6 py-3">Item</th><th scope="col" class="px-6 py-3">Entrega</th><th scope="col" class="px-6 py-3">Devolução</th><th scope="col" class="px-6 py-3">Ações</th></tr></thead><tbody id="ativos-table-body"></tbody></table></div>
<div id="ativos-cards-container" class="grid grid-cols-1 gap-4 md:hidden"></div></div><div id="ativos-form-container" class="hidden mt-6 p-6 bg-white rounded-lg shadow-md dark:bg-gray-800"><h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Registrar Ativo</h3><form id="ativos-form" class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label for="ativos-consultor" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Consultor</label><select id="ativos-consultor" class="consultor-select bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600"></select></div><div><label for="ativos-item" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Item</label><select id="ativos-item" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600"><option>Notebook</option><option>Celular</option><option>Tablet</option></select></div><div><label for="ativos-entrega" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Data de Entrega</label><input type="date" id="ativos-entrega" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600"></div><div><label for="ativos-devolucao" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Data de Devolução</label><input type="date" id="ativos-devolucao" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600"></div><div class="md:col-span-2"><label for="ativos-obs" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Observação</label><textarea id="ativos-obs" rows="3" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-brand-gold focus:border-brand-gold dark:bg-gray-700 dark:border-gray-600"></textarea></div><div class="md:col-span-2 flex justify-end space-x-4"><button type="button" class="cancel-sub-form px-6 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600" data-form="ativos-form-container" data-history="ativos-history-container">Cancelar</button><button type="submit" class="px-6 py-2 text-sm font-medium text-white bg-brand-gold rounded-md hover:bg-brand-gold-dark">Salvar</button></div></form></div></div>
                    </div>
                    
                    <div id="clientes" class="page hidden">
                       <div class="mb-4">
                            <h2 class="text-3xl font-bold text-gray-800 dark:text-white">Clientes</h2>
                            <p class="text-gray-600 dark:text-gray-300">Gerenciamento de clientes e parceiros.</p>
                        </div>
                         <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                            <div class="relative w-full max-w-xs">
                                <input type="text" id="cliente-search" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full pl-10 p-2.5  dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Buscar cliente...">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none"><i class="fas fa-search text-gray-400"></i></div>
                            </div>
                            <!-- INÍCIO DA ALTERAÇÃO: Botões de filtro de status -->
                            <div class="p-1 bg-gray-200 dark:bg-gray-700 rounded-lg flex space-x-1" id="cliente-status-filters">
                                <button class="cliente-status-filter-btn filter-btn-active px-3 py-1 rounded-md shadow-sm" data-status="Todos">Todos</button>
                                <button class="cliente-status-filter-btn px-3 py-1 rounded-md" data-status="Ativo">Ativos</button>
                                <button class="cliente-status-filter-btn px-3 py-1 rounded-md" data-status="Inativo">Inativos</button>
                            </div>
                            <!-- FIM DA ALTERAÇÃO -->
                            <button id="show-cliente-form" class="bg-brand-gold text-white px-4 py-2 rounded-lg shadow hover:bg-brand-gold-dark transition-colors w-full sm:w-auto">Novo Cliente</button>
                        </div>
                         <div id="cliente-cards-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
                        <div id="cliente-form-container" class="hidden mt-6">
                            <div class="p-6 bg-white rounded-lg shadow-md dark:bg-gray-800">
                            <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Cadastro de Cliente</h3>
                            <form id="cliente-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div class="md:col-span-2 lg:col-span-3 flex items-center space-x-4">
                                    <img id="cliente-foto-preview" src="https://placehold.co/100x100/e2e8f0/cbd5e0?text=Foto" class="w-24 h-24 rounded-lg object-cover">
                                    <input type="file" id="cliente-foto" class="text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-brand-gold file:text-white hover:file:bg-brand-gold-dark">
                                </div>
                                <div><label for="cliente-nome" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Nome do Cliente</label><input type="text" id="cliente-nome" name="name" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" required></div>
                                <div><label for="cliente-razao" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Razão Social</label><input type="text" id="cliente-razao" name="razao" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div>
                                <div><label for="cliente-cnpj" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">CNPJ</label><input type="text" id="cliente-cnpj" name="cnpj" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div>
                                <div><label for="cliente-tel" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Telefone</label><input type="tel" id="cliente-tel" name="telefone" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div>
                                <div><label for="cliente-email" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">E-mail</label><input type="email" id="cliente-email" name="email" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div>
                                <div><label for="cliente-horas" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Horas Contratadas</label><input type="number" id="cliente-horas" name="horas" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div>
                                <!-- INÍCIO DA ALTERAÇÃO: Campo de Status -->
                                <div>
                                    <label for="cliente-status" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Status</label>
                                    <select id="cliente-status" name="status" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                                        <option value="Ativo">Ativo</option>
                                        <option value="Inativo">Inativo</option>
                                    </select>
                                </div>
                                <!-- FIM DA ALTERAÇÃO -->
                                <div><label for="cliente-responsavel" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Responsável</label><input type="text" id="cliente-responsavel" name="responsavel" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div>
                                <div><label for="cliente-cpf" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">CPF do Responsável</label><input type="text" id="cliente-cpf" name="cpf" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div>
                                <div><label for="cliente-iptu" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">IPTU</label><input type="text" id="cliente-iptu" name="iptu" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div>
                                <div><label for="cliente-senha-portal" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Senha do Portal</label><input type="text" id="cliente-senha-portal" name="senhaPortal" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div>
                                <div class="md:col-span-2 lg:col-span-3"><label for="cliente-endereco" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Endereço</label><input type="text" id="cliente-endereco" name="endereco" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div>
                                 <div class="md:col-span-2 lg:col-span-3"><label for="cliente-obs" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Observação</label><textarea id="cliente-obs" rows="4" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-brand-gold focus:border-brand-gold dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></textarea></div>
                                <div class="md:col-span-2 lg:col-span-3 flex justify-end space-x-4">
                                    <button type="button" id="cancel-cliente-form" class="px-6 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">Cancelar</button>
                                    <button type="submit" class="px-6 py-2 text-sm font-medium text-white bg-brand-gold rounded-md hover:bg-brand-gold-dark">Salvar</button>
                                </div>
                            </form>
                            </div>
                        </div>
                    </div>

                    <div id="visitas" class="page hidden">
                        <div class="flex flex-col md:flex-row justify-between md:items-center mb-4">
                            <div>
                                <h2 class="text-3xl font-bold text-gray-800 dark:text-white">Visitas</h2>
                                <p class="text-gray-600 dark:text-gray-300">Agenda, histórico e status das visitas.</p>
                            </div>
                            <div class="flex items-center space-x-2 mt-4 md:mt-0">
                                <div class="p-1 bg-gray-200 dark:bg-gray-700 rounded-lg">
                                    <button class="view-toggle-btn bg-white dark:bg-gray-800 px-3 py-1 rounded-md shadow-sm" data-view="kanban-view"><i class="fas fa-columns"></i></button>
                                    <button class="view-toggle-btn px-3 py-1 rounded-md" data-view="list-view"><i class="fas fa-list"></i></button>
                                    <button class="view-toggle-btn px-3 py-1 rounded-md" data-view="calendar-view"><i class="fas fa-calendar-alt"></i></button>
                                </div>
                                <button id="generate-agenda-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg shadow hover:bg-green-600 transition-colors">Gerar Agenda</button>
                                <button id="show-visita-form" class="bg-brand-gold text-white px-4 py-2 rounded-lg shadow hover:bg-brand-gold-dark transition-colors">Nova Visita</button>
                            </div>
                        </div>
                        
                        <div id="visitas-filters" class="grid grid-cols-2 lg:grid-cols-5 gap-x-4 gap-y-3 mb-4 p-3 bg-white dark:bg-gray-800 rounded-lg shadow">
                            <div>
                                <label for="filter-start-date" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">De</label>
                                <input type="date" id="filter-start-date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            </div>
                            <div>
                                <label for="filter-end-date" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Até</label>
                                <input type="date" id="filter-end-date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            </div>
                            <div>
                                <label for="filter-consultor" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Consultor</label>
                                <select id="filter-consultor" class="consultor-select bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select>
                            </div>
                            <div>
                                <label for="filter-cliente" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Cliente</label>
                                <select id="filter-cliente" class="cliente-select bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select>
                            </div>
                            <div>
                                <label for="filter-status" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Status</label>
                                <select id="filter-status" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    <option value="">Todos</option>
                                    <option value="Agendada">Agendada</option>
                                    <option value="Em Andamento">Em Andamento</option>
                                    <option value="Concluída">Concluída</option>
                                </select>
                            </div>
                            <div class="lg:col-span-5 flex justify-end space-x-2">
                                <button id="clear-filters-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">Limpar Filtros</button>
                                <button id="apply-filters-btn" class="px-4 py-2 text-sm font-medium text-white bg-brand-gold rounded-md hover:bg-brand-gold-dark">Filtrar</button>
                            </div>
                        </div>


                        <div id="kanban-view" class="visitas-view">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div class="kanban-column bg-gray-200 dark:bg-gray-800 rounded-lg p-4" data-status="Agendada">
                                    <h3 class="font-bold text-lg mb-4 text-gray-800 dark:text-white">Agendada</h3>
                                    <div class="space-y-4" id="kanban-agendada"></div>
                                </div>
                                <div class="kanban-column bg-gray-200 dark:bg-gray-800 rounded-lg p-4" data-status="Em Andamento">
                                    <h3 class="font-bold text-lg mb-4 text-gray-800 dark:text-white">Em Andamento</h3>
                                    <div class="space-y-4" id="kanban-em-andamento"></div>
                                </div>
                                <div class="kanban-column bg-gray-200 dark:bg-gray-800 rounded-lg p-4" data-status="Concluída">
                                    <h3 class="font-bold text-lg mb-4 text-gray-800 dark:text-white">Concluída</h3>
                                    <div class="space-y-4" id="kanban-concluida"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="list-view" class="visitas-view hidden">
                            <div class="relative overflow-x-auto shadow-md sm:rounded-lg">
                                <table class="w-full text-sm text-left text-gray-500 dark:text-gray-300">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"><tr><th scope="col" class="px-6 py-3">Cliente</th><th scope="col" class="px-6 py-3">Consultor</th><th scope="col" class="px-6 py-3">Data</th><th scope="col" class="px-6 py-3">Horário</th><th scope="col" class="px-6 py-3">Status</th><th scope="col" class="px-6 py-3">Ações</th></tr></thead>
                                    <tbody id="visitas-table-body"></tbody>
                                </table>
                            </div>
                        </div>

                        <div id="calendar-view" class="visitas-view hidden">
                            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                                <div id="calendar"></div>
                            </div>
                        </div>

                    </div>

                    <div id="requisicao" class="page hidden">
                        <div class="mb-4">
                            <h2 class="text-3xl font-bold text-gray-800 dark:text-white">Requisições</h2>
                            <p class="text-gray-600 dark:text-gray-300">Gerenciamento de requisições de materiais.</p>
                        </div>

                        <div class="mb-6 border-b border-gray-200 dark:border-gray-700">
                            <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="requisicao-tabs">
                                <li class="mr-2"><button class="requisicao-tab-btn inline-block p-4 border-b-2 rounded-t-lg border-brand-gold text-brand-gold" data-target="requisicoes-content">Requisições</button></li>
                                <li class="mr-2"><button class="requisicao-tab-btn inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300" data-target="itens-requisicao-content">Itens de Requisição</button></li>
                            </ul>
                        </div>

                        <div id="requisicoes-content" class="requisicao-tab-content">
                           <div id="requisicoes-filters" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-4 p-4 bg-white dark:bg-gray-800 rounded-lg shadow">
                                <div>
                                    <label for="filter-req-start-date" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">De</label>
                                    <input type="date" id="filter-req-start-date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                </div>
                                <div>
                                    <label for="filter-req-end-date" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Até</label>
                                    <input type="date" id="filter-req-end-date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                </div>
                                <div>
                                    <label for="filter-req-consultor" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Consultor</label>
                                    <select id="filter-req-consultor" class="consultor-select bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select>
                                </div>
                                 <div>
                                    <label for="filter-req-status" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Status</label>
                                    <select id="filter-req-status" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                        <option value="">Todos</option>
                                        <option value="Pendente">Pendente</option>
                                        <option value="Entregue">Entregue</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="filter-req-item" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Item</label>
                                    <input type="text" id="filter-req-item" placeholder="Buscar item..." class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                                </div>
                                <div class="col-span-1 sm:col-span-2 lg:col-span-3 xl:col-span-5 flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-2">
    <button id="clear-req-filters-btn" class="w-full sm:w-auto px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">Limpar Filtros</button>
    <button id="apply-req-filters-btn" class="w-full sm:w-auto px-4 py-2 text-sm font-medium text-white bg-brand-gold rounded-md hover:bg-brand-gold-dark">Filtrar</button>
</div>
                            </div>

                             <div class="flex justify-end items-center mb-4">
                                <button id="show-requisicao-form" class="bg-brand-gold text-white px-4 py-2 rounded-lg shadow hover:bg-brand-gold-dark transition-colors">Nova Requisição</button>
                            </div>
                            <!-- Tabela para Desktop (Visível a partir de telas 'md') -->
<div class="relative overflow-x-auto shadow-md sm:rounded-lg hidden md:block">
    <table class="w-full text-sm text-left text-gray-500 dark:text-gray-300">
        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
            <tr>
                <th scope="col" class="px-6 py-3">Consultor</th>
                <th scope="col" class="px-6 py-3">Data/Hora</th>
                <th scope="col" class="px-6 py-3">Status</th>
                <th scope="col" class="px-6 py-3">Ações</th>
            </tr>
        </thead>
        <tbody id="requisicoes-table-body"></tbody>
    </table>
</div>

<!-- Container de Cards para Mobile (Visível apenas em telas pequenas) -->
<div id="requisicoes-cards-container" class="grid grid-cols-1 gap-4 md:hidden">
    <!-- Cards serão inseridos aqui via JS -->
</div>
                        </div>

                        <div id="itens-requisicao-content" class="requisicao-tab-content hidden">
                           <!-- Container principal alterado para empilhar em telas pequenas (flex-col) e adicionar um espaçamento (gap-4) -->
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 gap-4">
                                <!-- Container dos filtros alterado para permitir quebra de linha (flex-wrap) e usar gap -->
                                <div class="p-2 bg-gray-200 dark:bg-gray-700 rounded-lg flex flex-wrap gap-2" id="item-category-filters">
                                    <!-- Os botões de filtro são inseridos aqui pelo JavaScript -->
                                </div>
                                <!-- Botão "Novo Item" agora ocupa a largura total em telas pequenas (w-full). O ID e o texto foram atualizados para corresponder ao que o seu JS já faz. -->
                                <button id="show-new-item-btn" class="bg-brand-gold text-white px-4 py-2 rounded-lg shadow hover:bg-brand-gold-dark transition-colors w-full sm:w-auto" style="display: none;">Novo Item</button>
                            </div>
                            <div id="item-management-container" class="space-y-6"></div>
                        </div>

                    </div>
                    
                     <div id="financeiro" class="page hidden">
                        <div class="mb-4">
                            <h2 class="text-3xl font-bold text-gray-800 dark:text-white">Financeiro</h2>
                            <p class="text-gray-600 dark:text-gray-300">Gerenciamento de Receitas e Custos.</p>
                        </div>
                        <div class="mb-6 border-b border-gray-200 dark:border-gray-700">
                            <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="financeiro-tabs">
                                <li class="mr-2"><button class="financeiro-tab-btn inline-block p-4 border-b-2 rounded-t-lg border-brand-gold text-brand-gold" data-target="receitas-content">Receitas</button></li>
                                <li class="mr-2"><button class="financeiro-tab-btn inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300" data-target="custos-content">Custos</button></li>
                            </ul>
                        </div>
                        <div id="receitas-content" class="financeiro-tab-content">
                             <div class="flex justify-end items-center mb-4">
                                <button id="show-receita-form" class="bg-brand-gold text-white px-4 py-2 rounded-lg shadow hover:bg-brand-gold-dark transition-colors">Nova Receita</button>
                            </div>
                            <div id="receitas-history-container">
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4 p-4 bg-white dark:bg-gray-800 rounded-lg shadow">
                                <div>
                                        <label for="filter-receita-start-date" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Venc. De</label>
                                        <input type="date" id="filter-receita-start-date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div>
                                        <label for="filter-receita-end-date" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Venc. Até</label>
                                        <input type="date" id="filter-receita-end-date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div>
                                        <label for="filter-receita-cliente" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Cliente</label>
                                        <select id="filter-receita-cliente" class="cliente-select bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select>
                                    </div>
                                    <div>
                                        <label for="filter-receita-status" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Status</label>
                                        <select id="filter-receita-status" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                            <option value="">Todos</option>
                                            <option value="Pendente">Pendente</option>
                                            <option value="Pago">Pago</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="relative overflow-x-auto shadow-md sm:rounded-lg hidden md:block">
    <table class="w-full text-sm text-left text-gray-500 dark:text-gray-300">
        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
            <tr>
                <th scope="col" class="px-6 py-3">Cliente</th>
                <th scope="col" class="px-6 py-3">Vencimento</th>
                <th scope="col" class="px-6 py-3">Valor</th>
                <th scope="col" class="px-6 py-3">Status</th>
                <th scope="col" class="px-6 py-3">Ações</th>
            </tr>
        </thead>
        <tbody id="receitas-table-body"></tbody>
    </table>
</div>
<div id="receitas-cards-container" class="grid grid-cols-1 gap-4 md:hidden"></div>
                            </div>
                            <div id="receita-form-container" class="hidden mt-6 p-6 bg-white rounded-lg shadow-md dark:bg-gray-800">
                                <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Lançar Nova Receita</h3>
                                <form id="receita-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="receita-cliente-form" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Cliente</label>
                                        <select id="receita-cliente-form" class="cliente-select bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required></select>
                                    </div>
                                    <div>
                                        <label for="receita-vencimento" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Data de Vencimento</label>
                                        <input type="date" id="receita-vencimento" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600" required>
                                    </div>
                                    <div>
                                        <label for="receita-valor" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Valor</label>
                                        <input type="number" id="receita-valor" step="0.01" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600" required>
                                    </div>
                                    <div>
                                        <label for="receita-status-form" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Status</label>
                                        <select id="receita-status-form" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                            <option value="Pendente">Pendente</option>
                                            <option value="Pago">Pago</option>
                                        </select>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="receita-obs" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Observação</label>
                                        <textarea id="receita-obs" rows="3" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-brand-gold focus:border-brand-gold dark:bg-gray-700 dark:border-gray-600"></textarea>
                                    </div>
                                    <div class="md:col-span-2 flex justify-end space-x-4">
                                        <button type="button" id="cancel-receita-form" class="px-6 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">Cancelar</button>
                                        <button type="submit" class="px-6 py-2 text-sm font-medium text-white bg-brand-gold rounded-md hover:bg-brand-gold-dark">Salvar</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div id="custos-content" class="financeiro-tab-content hidden">
                            <div class="flex justify-end items-center mb-4">
                                <button id="show-custo-form" class="bg-brand-gold text-white px-4 py-2 rounded-lg shadow hover:bg-brand-gold-dark transition-colors">Novo Custo</button>
                            </div>
                            <div id="custos-history-container">
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4 p-4 bg-white dark:bg-gray-800 rounded-lg shadow">
                                <div>
                                        <label for="filter-custo-start-date" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Venc. De</label>
                                        <input type="date" id="filter-custo-start-date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div>
                                        <label for="filter-custo-end-date" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Venc. Até</label>
                                        <input type="date" id="filter-custo-end-date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div>
                                        <label for="filter-custo-credor" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Credor</label>
                                        <input type="text" id="filter-custo-credor" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                                    </div>
                                    <div>
                                        <label for="filter-custo-status" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Status</label>
                                        <select id="filter-custo-status" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                            <option value="">Todos</option>
                                            <option value="Pendente">Pendente</option>
                                            <option value="Pago">Pago</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="relative overflow-x-auto shadow-md sm:rounded-lg hidden md:block">
    <table class="w-full text-sm text-left text-gray-500 dark:text-gray-300">
        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
            <tr>
                <th scope="col" class="px-6 py-3">Credor</th>
                <th scope="col" class="px-6 py-3">Vencimento</th>
                <th scope="col" class="px-6 py-3">Valor</th>
                <th scope="col" class="px-6 py-3">Status</th>
                <th scope="col" class="px-6 py-3">Ações</th>
            </tr>
        </thead>
        <tbody id="custos-table-body"></tbody>
    </table>
</div>
<div id="custos-cards-container" class="grid grid-cols-1 gap-4 md:hidden"></div>
                            </div>
                            <div id="custo-form-container" class="hidden mt-6 p-6 bg-white rounded-lg shadow-md dark:bg-gray-800">
                                <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Lançar Novo Custo</h3>
                                <form id="custo-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="custo-credor" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Credor / Fornecedor</label>
                                        <input type="text" id="custo-credor" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600" required>
                                    </div>
                                    <div>
                                        <label for="custo-vencimento" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Data de Vencimento</label>
                                        <input type="date" id="custo-vencimento" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600" required>
                                    </div>
                                    <div>
                                        <label for="custo-valor" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Valor</label>
                                        <input type="number" id="custo-valor" step="0.01" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600" required>
                                    </div>
                                    <div>
                                        <label for="custo-status-form" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Status</label>
                                        <select id="custo-status-form" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                            <option value="Pendente">Pendente</option>
                                            <option value="Pago">Pago</option>
                                        </select>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="custo-obs" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Observação</label>
                                        <textarea id="custo-obs" rows="3" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-brand-gold focus:border-brand-gold dark:bg-gray-700 dark:border-gray-600"></textarea>
                                    </div>
                                    <div class="md:col-span-2 flex justify-end space-x-4">
                                        <button type="button" id="cancel-custo-form" class="px-6 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">Cancelar</button>
                                        <button type="submit" class="px-6 py-2 text-sm font-medium text-white bg-brand-gold rounded-md hover:bg-brand-gold-dark">Salvar</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                </main>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="insights-modal" class="fixed inset-0 z-50 items-center justify-center hidden bg-black bg-opacity-60 modal-bg-animate">
        <div class="w-full max-w-lg p-6 mx-4 bg-white rounded-lg shadow-lg dark:bg-gray-800 modal-content-animate">
            <div class="flex justify-between items-center border-b pb-3 dark:border-gray-700">
                 <h2 class="text-2xl font-bold text-gray-900 dark:text-white"><i class="fas fa-lightbulb text-yellow-400 mr-2"></i>Insights Valiosos</h2>
                 <button id="close-insights-modal" class="text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div id="insights-content" class="mt-4 space-y-3 text-gray-700 dark:text-gray-300 max-h-96 overflow-y-auto"></div>
        </div>
    </div>

     <div id="report-modal" class="fixed inset-0 z-50 items-center justify-center hidden bg-black bg-opacity-60 modal-bg-animate">
        <div class="w-full max-w-lg p-6 mx-4 bg-white rounded-lg shadow-lg dark:bg-gray-800 modal-content-animate">
             <div class="flex justify-between items-center border-b pb-3 dark:border-gray-700">
                 <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Gerar Relatório PDF</h2>
                 <button id="close-report-modal" class="text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <form id="report-form" class="mt-4 space-y-4">
                <div>
                    <label for="report-type" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Tipo de Relatório</label>
                    <select id="report-type" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <option value="financeiro">Financeiro</option>
                        <option value="visitas">Visitas</option>
                    </select>
                </div>
                <div>
                    <label for="report-subtype" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Detalhes</label>
                    <select id="report-subtype" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select>
                </div>
                 <div id="report-visits-filters" class="hidden space-y-4">
                    <div>
                        <label for="report-consultor" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Consultor</label>
                        <select id="report-consultor" class="consultor-select bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select>
                    </div>
                     <div>
                        <label for="report-cliente" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Cliente</label>
                        <select id="report-cliente" class="cliente-select bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="report-start-date" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Período (De)</label>
                        <input type="date" id="report-start-date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                    <div>
                        <label for="report-end-date" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Período (Até)</label>
                        <input type="date" id="report-end-date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                </div>
                <div class="flex justify-end pt-4">
                    <button type="submit" class="w-full bg-brand-gold text-white px-4 py-2 rounded-lg shadow hover:bg-brand-gold-dark transition-colors">Baixar PDF</button>
                </div>
            </form>
        </div>
    </div>

    <div id="details-modal" class="fixed inset-0 z-40 items-center justify-center hidden bg-black bg-opacity-60 modal-bg-animate">
        <div class="w-full max-w-lg p-6 mx-4 bg-white rounded-lg shadow-lg dark:bg-gray-800 modal-content-animate">
            <div class="flex justify-between items-center border-b pb-3 dark:border-gray-700">
                 <h2 id="modal-title" class="text-2xl font-bold text-gray-900 dark:text-white">Detalhes</h2>
                 <button id="close-modal" class="text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div id="modal-content" class="mt-4 space-y-2 text-gray-700 dark:text-gray-300 max-h-96 overflow-y-auto"></div>
             <div id="details-modal-actions" class="flex justify-end mt-6 space-x-4">
                <button id="delete-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Apagar</button>
                <button id="edit-btn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">Editar</button>
            </div>
        </div>
    </div>
    <div id="delete-confirm-modal" class="fixed inset-0 z-50 items-center justify-center hidden bg-black bg-opacity-60 modal-bg-animate">
        <div class="w-full max-w-sm p-6 mx-4 bg-white rounded-lg shadow-lg dark:bg-gray-800 modal-content-animate">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white">Confirmar Exclusão</h2>
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Você tem certeza que deseja apagar este registro? Esta ação não pode ser desfeita.</p>
            <div class="flex justify-end mt-6 space-x-4">
                <button id="cancel-delete-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">Cancelar</button>
                <button id="confirm-delete-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Apagar</button>
            </div>
        </div>
    </div>
    <div id="logout-confirm-modal" class="fixed inset-0 z-50 items-center justify-center hidden bg-black bg-opacity-60 modal-bg-animate">
        <div class="w-full max-w-sm p-6 mx-4 bg-white rounded-lg shadow-lg dark:bg-gray-800 modal-content-animate">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white">Confirmar Saída</h2>
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Você tem certeza que deseja sair do sistema?</p>
            <div class="flex justify-end mt-6 space-x-4">
                <button id="cancel-logout-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">Cancelar</button>
                <button id="confirm-logout-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Sair</button>
            </div>
        </div>
    </div>
    <div id="visita-form-modal" class="fixed inset-0 z-40 items-center justify-center hidden bg-black bg-opacity-60 modal-bg-animate">
        <div class="w-full max-w-lg p-6 mx-4 bg-white rounded-lg shadow-lg dark:bg-gray-800 modal-content-animate">
            <h2 id="visita-modal-title" class="text-xl font-bold text-gray-900 dark:text-white mb-4">Agendar Nova Visita</h2>
            <form id="visita-form">
    <input type="hidden" id="visita-id">
    <input type="hidden" id="is-rescheduling" value="false">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label for="visita-consultor" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Consultor</label><select id="visita-consultor" class="consultor-select bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required></select></div>
        <div><label for="visita-cliente" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Cliente</label><select id="visita-cliente" class="cliente-select bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required></select></div>
        <div><label for="visita-data" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Data da Visita</label><input type="date" id="visita-data" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required></div>
        <div><label for="visita-inicio" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Hora Início</label><input type="time" id="visita-inicio" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required></div>
        <div><label for="visita-fim" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Hora Fim</label><input type="time" id="visita-fim" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required></div>
        <div class="md:col-span-2"><label for="visita-atividades" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Atividades</label><textarea id="visita-atividades" rows="3" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-brand-gold focus:border-brand-gold dark:bg-gray-700 dark:border-gray-600" required></textarea></div>
    </div>
    <div class="flex justify-end mt-6 space-x-4">
        <button type="button" id="cancel-visita-form" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">Cancelar</button>
        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-brand-gold rounded-md hover:bg-brand-gold-dark">Salvar</button>
    </div>
</form>
        </div>
    </div>
    
    <div id="requisicao-form-modal" class="fixed inset-0 z-40 items-center justify-center hidden bg-black bg-opacity-60 modal-bg-animate">
        <div class="w-full max-w-2xl p-6 mx-4 bg-white rounded-lg shadow-lg dark:bg-gray-800 modal-content-animate max-h-[90vh] flex flex-col">
            <h2 id="requisicao-modal-title" class="text-xl font-bold text-gray-900 dark:text-white mb-4">Nova Requisição</h2>
            <form id="requisicao-form" class="flex-grow overflow-y-auto">
                <input type="hidden" id="requisicao-id">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="requisicao-tipo" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Tipo de Requisição</label>
                        <select id="requisicao-tipo" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                            <option value="">Selecione...</option>
                            <option value="EPIs">EPIs</option>
                            <option value="Consumo">Consumo</option>
                        </select>
                    </div>
                     <div>
                        <label for="requisicao-consultor" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Consultor</label>
                        <select id="requisicao-consultor" class="consultor-select bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required></select>
                    </div>
                     <div>
                        <label for="requisicao-data" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Data/Hora</label>
                        <input type="text" id="requisicao-data" class="bg-gray-200 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600" readonly>
                    </div>
                </div>

                <div id="epis-fields" class="hidden mt-4 space-y-4">
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="epis-item" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Item</label>
                            <select id="epis-item" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600"></select>
                        </div>
                        <div>
                            <label for="epis-quantidade" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Quantidade</label>
                            <input type="number" id="epis-quantidade" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600" min="1" value="1">
                        </div>
                    </div>
                </div>

                <div id="consumo-fields" class="hidden mt-4 space-y-4">
                    <div id="consumo-categories-container" class="space-y-4"></div>
                    <button type="button" id="add-consumo-category-btn" class="text-sm text-brand-gold hover:underline"><i class="fas fa-plus mr-1"></i> Adicionar Categoria de Consumo</button>
                </div>
            </form>
            <div class="flex justify-end mt-6 space-x-4 pt-4 border-t dark:border-gray-700">
                <button type="button" id="cancel-requisicao-form" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">Cancelar</button>
                <button type="submit" form="requisicao-form" class="px-4 py-2 text-sm font-medium text-white bg-brand-gold rounded-md hover:bg-brand-gold-dark">Salvar</button>
            </div>
        </div>
    </div>

    <div id="item-form-modal" class="fixed inset-0 z-50 items-center justify-center hidden bg-black bg-opacity-60 modal-bg-animate">
        <div class="w-full max-w-lg p-6 mx-4 bg-white rounded-lg shadow-lg dark:bg-gray-800 modal-content-animate">
            <h2 id="item-modal-title" class="text-xl font-bold text-gray-900 dark:text-white mb-4">Novo Item</h2>
            <form id="item-form">
                <input type="hidden" id="item-original-name">
                <input type="hidden" id="item-category-name">
                <div class="space-y-4">
                    <div>
                        <label for="item-name" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Nome do Item</label>
                        <input type="text" id="item-name" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600" required>
                    </div>
                    <div>
                        <label for="item-foto" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Foto do Item</label>
                        <input type="file" id="item-foto" accept="image/*" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 dark:text-gray-400 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400">
                        <img id="item-foto-preview" src="" alt="Pré-visualização da foto" class="mt-2 rounded-lg h-24 w-24 object-cover hidden">
                    </div>
                </div>
                 <div class="flex justify-end mt-6 space-x-4">
                    <button type="button" id="cancel-item-form" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">Cancelar</button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-brand-gold rounded-md hover:bg-brand-gold-dark">Salvar Item</button>
                </div>
            </form>
        </div>
    </div>
<div id="requisicao-item-form-modal" class="fixed inset-0 z-50 items-center justify-center hidden bg-black bg-opacity-60 modal-bg-animate">
        <div class="w-full max-w-3xl p-6 mx-4 bg-white rounded-lg shadow-lg dark:bg-gray-800 modal-content-animate max-h-[90vh] flex flex-col">
            <h2 id="requisicao-item-modal-title" class="text-xl font-bold text-gray-900 dark:text-white mb-4">Adicionar Itens à Requisição</h2>
            
            <div class="flex-grow overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Coluna da Esquerda: Seleção de Itens -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Catálogo de Itens</h3>
                    <div id="modal-item-category-filters" class="p-1 bg-gray-200 dark:bg-gray-700 rounded-lg flex space-x-1 mb-2 overflow-x-auto">
                    <!-- Os botões de filtro serão inseridos aqui pelo JavaScript -->
                </div>
                    <!-- INÍCIO DA ALTERAÇÃO: Container para os cards visuais dos itens -->
                    <div id="requisicao-item-catalogo-visual" class="grid grid-cols-2 sm:grid-cols-3 gap-4 p-2 border rounded-lg h-64 overflow-y-auto bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                        <!-- Os cards dos itens serão inseridos aqui pelo JavaScript -->
                    </div>
                    <!-- FIM DA ALTERAÇÃO -->
                    
                    <div class="mt-4">
                        <label for="requisicao-item-qtd" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Quantidade</label>
                        <input type="number" id="requisicao-item-qtd" value="1" min="1" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" required>
                    </div>
                    <button type="button" id="incluir-item-btn" class="mt-4 w-full bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 transition-colors">Incluir Item</button>
                </div>

                <!-- Coluna da Direita: Lista de Itens a Adicionar -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Itens a Adicionar</h3>
                    <!-- INÍCIO DA ALTERAÇÃO: Container para a lista de itens selecionados -->
                    <div id="itens-para-adicionar-container" class="border rounded-lg p-2 h-80 overflow-y-auto bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                        <ul id="itens-para-adicionar-list" class="space-y-2">
                            <!-- A lista de itens será inserida aqui pelo JavaScript -->
                        </ul>
                    </div>
                    <!-- FIM DA ALTERAÇÃO -->
                </div>
            </div>

            <!-- Botões de Ação do Modal -->
            <div class="flex justify-end mt-6 space-x-4 pt-4 border-t dark:border-gray-700">
                <button type="button" id="cancel-requisicao-item-form" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">Cancelar</button>
                <!-- INÍCIO DA ALTERAÇÃO: Botão para salvar a lista final -->
                <button type="button" id="salvar-conteudo-requisicao-btn" class="px-4 py-2 text-sm font-medium text-white bg-brand-gold rounded-md hover:bg-brand-gold-dark">Salvar Conteúdo</button>
                <!-- FIM DA ALTERAÇÃO -->
            </div>
        </div>
    </div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Configuração da API NocoDB ---

    const API_URL = '/.netlify/functions/api';
    const API_TOKEN = null; 
    const NocoDB_BaseURL = 'https://lumitechia-nocodb.aeenwc.easypanel.host'; 
    const logoBase64 = 'data:image/png;base64,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';
    // --- Variáveis Globais de Dados ---
    let consultoresData = [];
    let clientesData = [];
    let receitasData = [];
    let custosData = [];
    let visitsData = [];
    let requisicoesData = [];
    let itemData = { epis: [], consumo: {} };
    let allItems = [];
    let feriasData = [];
    let atestadosData = [];
    let episEntreguesData = [];
    let ativosData = [];
    let loggedInUser = null;
    let requisicoesItensData = []; 
    let itemsParaAdicionar = [];

    // --- Variáveis de Estado da UI ---
    let activeCard = null;
    let activeTableRow = null;
    let calendar;
    let financeChart, visitsStatusChart, clientsVisitsChart, clientsHoursChart, receitasByClienteChart, custosByCredorChart;
    let activeDeleteItem = { id: null, type: null, element: null };

    // --- Seletores Globais ---
    const allElements = {
        loginScreen: document.getElementById('login-screen'),
        mainApp: document.getElementById('main-app'),
        loginForm: document.getElementById('login-form'),
        sidebar: document.getElementById('sidebar'),
        sidebarOverlay: document.getElementById('sidebar-overlay'),
        sidebarToggle: document.getElementById('sidebar-toggle'),
        pages: document.querySelectorAll('.page'),
        pageTitle: document.getElementById('page-title'),
        detailsModal: document.getElementById('details-modal'),
        deleteConfirmModal: document.getElementById('delete-confirm-modal'),
        logoutConfirmModal: document.getElementById('logout-confirm-modal'),
        insightsModal: document.getElementById('insights-modal'),
        reportModal: document.getElementById('report-modal'),
        visitaFormModal: document.getElementById('visita-form-modal'),
        visitaForm: document.getElementById('visita-form'),
        requisicaoFormModal: document.getElementById('requisicao-form-modal'),
        requisicaoForm: document.getElementById('requisicao-form'),
        itemFormModal: document.getElementById('item-form-modal'),
        itemForm: document.getElementById('item-form'),
        requisicaoItemFormModal: document.getElementById('requisicao-item-form-modal'),
    };

    // --- Funções Auxiliares para Chamadas à API ---
    async function nocoFetch(endpoint, options = {}) {
        try {
            const response = await fetch(`${API_URL}/${endpoint}`, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'xc-token': API_TOKEN,
                    ...options.headers,
                },
            });
            if (!response.ok) {
                const errorData = await response.json();
                const errorMessage = errorData.msg || (Array.isArray(errorData) && errorData[0] ? errorData[0].msg : response.statusText);
                throw new Error(errorMessage);
            }
            if (options.method === 'DELETE' || response.status === 204) {
                return { success: true };
            }
            return await response.json();
        } catch (error) {
            const details = `Endpoint: ${options.method || 'GET'} /${endpoint}\nErro: ${error.message}`;
            console.error(`Falha no fetch para ${endpoint}:`, error);
            alert(`Ocorreu um erro de comunicação com o servidor. Por favor, tente novamente.\n\nDetalhes:\n${details}`);
            return null;
        }
    }

    async function uploadFile(tableName, columnName, file) {
        const formData = new FormData();
        formData.append('file', file);
        try {
            const projectPath = API_URL.substring(API_URL.indexOf('/noco/')).substring(1);
            const uploadUrl = `${NocoDB_BaseURL}/api/v1/db/storage/upload?path=${projectPath}/${tableName}/${columnName}`;

            const response = await fetch(uploadUrl, {
                method: 'POST',
                headers: { 'xc-token': API_TOKEN },
                body: formData,
            });
            if (!response.ok) {
                const errorData = await response.json();
                const errorText = typeof errorData === 'string' ? errorData : (errorData.msg || response.statusText);
                throw new Error(`Erro no upload: ${errorText}`);
            }
            const result = await response.json();
            return Array.isArray(result) ? result[0] : result;
        } catch (error) {
            console.error(`Falha no upload para ${tableName}:`, error);
            alert(`Ocorreu um erro ao enviar o arquivo.\nDetalhes: ${error.message}`);
            return null;
        }
    }
    function getCurrentLocation() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                reject(new Error('Geolocalização não é suportada por este navegador.'));
            } else {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        });
                    },
                    (error) => {
                        let errorMessage = 'Não foi possível obter a localização.';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "O usuário negou a permissão para geolocalização.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "A informação de localização está indisponível.";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "A requisição para obter a localização do usuário expirou.";
                                break;
                        }
                        reject(new Error(errorMessage));
                    },
                    { enableHighAccuracy: true }
                );
            }
        });
    }
    // Função principal para atualizar a aba de Receitas
    function updateReceitasDashboard() {
        const status = document.getElementById('dash-rec-status').value;
        const clienteId = document.getElementById('dash-rec-cliente').value;
        const startDate = document.getElementById('dash-rec-start').value;
        const endDate = document.getElementById('dash-rec-end').value;

        const filteredReceitas = receitasData.filter(r =>
            (!status || r.Status === status) &&
            (!clienteId || r.Clientes?.Id == clienteId) &&
            (!startDate || r.Vencimento >= startDate) &&
            (!endDate || r.Vencimento <= endDate)
        );

        const f = v => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        // Atualiza os cards de métricas
        const total = filteredReceitas.reduce((sum, r) => sum + (r.Valor || 0), 0);
        const pending = filteredReceitas.filter(r => r.Status === 'Pendente').reduce((sum, r) => sum + (r.Valor || 0), 0);

        document.getElementById('dash-rec-total').textContent = f(total);
        document.getElementById('dash-rec-pending').textContent = f(pending);

        // Chama a função para atualizar o gráfico e o ranking
        updateReceitasByClienteChart(filteredReceitas);
    }

    // Função para atualizar o gráfico e ranking de receitas por cliente
    function updateReceitasByClienteChart(data) {
        const stats = data.reduce((acc, r) => {
            const clientName = r.Clientes?.Nome || 'N/A';
            acc[clientName] = (acc[clientName] || 0) + (r.Valor || 0);
            return acc;
        }, {});

        const sortedClients = Object.entries(stats).sort((a, b) => b[1] - a[1]);
        const f = v => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        // Renderiza o ranking
        const listContainer = document.getElementById('dash-top-clients-receitas-list');
        listContainer.innerHTML = sortedClients.map(([name, value]) =>
            `<li class="flex justify-between items-center text-sm">
                <span>${name}</span>
                <span class="font-bold text-brand-gold">${f(value)}</span>
            </li>`
        ).join('') || '<li>Nenhum dado para exibir.</li>';

        // Renderiza o gráfico
        const top5 = sortedClients.slice(0, 5);
        const labels = top5.map(item => item[0]);
        const chartData = top5.map(item => item[1]);

        const ctx = document.getElementById('receitas-by-cliente-chart').getContext('2d');
        const isDark = document.documentElement.classList.contains('dark');
        const labelColor = isDark ? '#e5e7eb' : '#373737';

        if (receitasByClienteChart) {
            receitasByClienteChart.data.labels = labels;
            receitasByClienteChart.data.datasets[0].data = chartData;
            receitasByClienteChart.update();
        } else {
            receitasByClienteChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Valor Recebido',
                        data: chartData,
                        backgroundColor: '#3B82F6', // Azul para diferenciar
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: labelColor, callback: value => f(value) } },
                        y: { ticks: { color: labelColor } }
                    }
                }
            });
        }
    }
    // Função principal para atualizar a aba de Custos
    function updateCustosDashboard() {
        const status = document.getElementById('dash-cos-status').value;
        const credor = document.getElementById('dash-cos-credor').value.toLowerCase();
        const startDate = document.getElementById('dash-cos-start').value;
        const endDate = document.getElementById('dash-cos-end').value;

        const filteredCustos = custosData.filter(c =>
            (!status || c.Status === status) &&
            (!credor || c.Credor.toLowerCase().includes(credor)) &&
            (!startDate || c.Vencimento >= startDate) &&
            (!endDate || c.Vencimento <= endDate)
        );

        const f = v => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        // Atualiza os cards de métricas
        const total = filteredCustos.reduce((sum, c) => sum + (c.Valor || 0), 0);
        const pending = filteredCustos.filter(c => c.Status === 'Pendente').reduce((sum, c) => sum + (c.Valor || 0), 0);

        document.getElementById('dash-cos-total').textContent = f(total);
        document.getElementById('dash-cos-pending').textContent = f(pending);

        // Chama a função para atualizar o gráfico e o ranking
        updateCustosByCredorChart(filteredCustos);
    }

    // Função para atualizar o gráfico e ranking de custos por credor
    function updateCustosByCredorChart(data) {
        const stats = data.reduce((acc, c) => {
            const credorName = c.Credor || 'N/A';
            acc[credorName] = (acc[credorName] || 0) + (c.Valor || 0);
            return acc;
        }, {});

        const sortedCredores = Object.entries(stats).sort((a, b) => b[1] - a[1]);
        const f = v => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        // Renderiza o ranking
        const listContainer = document.getElementById('dash-top-credores-custos-list');
        listContainer.innerHTML = sortedCredores.map(([name, value]) =>
            `<li class="flex justify-between items-center text-sm">
                <span>${name}</span>
                <span class="font-bold text-brand-gold">${f(value)}</span>
            </li>`
        ).join('') || '<li>Nenhum dado para exibir.</li>';

        // Renderiza o gráfico
        const top5 = sortedCredores.slice(0, 5);
        const labels = top5.map(item => item[0]);
        const chartData = top5.map(item => item[1]);

        const ctx = document.getElementById('custos-by-credor-chart').getContext('2d');
        const isDark = document.documentElement.classList.contains('dark');
        const labelColor = isDark ? '#e5e7eb' : '#373737';

        if (custosByCredorChart) {
            custosByCredorChart.data.labels = labels;
            custosByCredorChart.data.datasets[0].data = chartData;
            custosByCredorChart.update();
        } else {
            custosByCredorChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Valor do Custo',
                        data: chartData,
                        backgroundColor: '#EF4444', // Vermelho para custos
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: labelColor, callback: value => f(value) } },
                        y: { ticks: { color: labelColor } }
                    }
                }
            });
        }
    }
function renderModalCatalogoGrid(category = 'Todos') {
    const catalogoContainer = document.getElementById('requisicao-item-catalogo-visual');
    catalogoContainer.innerHTML = ''; // Limpa o conteúdo anterior

    const itemsToRender = (category === 'Todos')
        ? allItems
        : allItems.filter(item => item.Categoria === category);

    itemsToRender.forEach(item => {
        const card = document.createElement('div');
        card.className = 'item-catalogo-card p-2 border dark:border-gray-600 rounded-lg cursor-pointer flex flex-col items-center hover:bg-gray-100 dark:hover:bg-gray-600';
        card.dataset.itemId = item.Id;
        card.innerHTML = `
            <img src="${item.Foto && item.Foto[0]?.signedPath ? `${NocoDB_BaseURL}/${item.Foto[0].signedPath}` : 'https://placehold.co/80x80/e2e8f0/cbd5e0?text=Item'}" alt="${item.Nome}" class="w-16 h-16 object-contain mb-1 rounded">
            <p class="text-xs text-center font-medium text-gray-800 dark:text-white">${item.Nome}</p>
        `;
        // Adiciona o evento de clique para seleção
        card.addEventListener('click', () => {
            catalogoContainer.querySelectorAll('.item-catalogo-card').forEach(c => c.classList.remove('border-brand-gold', 'border-2'));
            card.classList.add('border-brand-gold', 'border-2');
        });
        catalogoContainer.appendChild(card);
    });
}
    // --- Funções de Carregamento de Dados (Fetch) ---
async function fetchAllData() {
    showLoadingOverlay('Carregando dados...');
    await Promise.all([ fetchConsultores(), fetchClientes(), fetchCustos(), fetchItensCatalogo() ]);
    await Promise.all([ fetchVisitas(), fetchReceitas(), fetchRequisicoes(), fetchFerias(), fetchAtestados(), fetchEpis(), fetchAtivos(), fetchRequisicoesItens() ]);
    
    renderConsultores();
    applyClienteFilters();
    populateConsultantSelects();
    populateClientSelects();
    populateSelectWithOptions('#report-consultor', consultoresData, 'Id', 'Nome', true);
    populateSelectWithOptions('#report-cliente', clientesData, 'Id', 'Nome', true);

    // --- INÍCIO DA ALTERAÇÃO ---
    // Lógica movida para cá. É executada DEPOIS que populateConsultantSelects() já criou as opções.
    if (loggedInUser && loggedInUser.Role === 'Consultor') { 
        // Se NÃO for admin, pré-seleciona e desabilita os filtros.
        const consultorFilterVisitas = document.getElementById('filter-consultor');
        const consultorFilterReqs = document.getElementById('filter-req-consultor');

        if (consultorFilterVisitas) {
            consultorFilterVisitas.value = loggedInUser.Id;
            consultorFilterVisitas.disabled = true;
        }
        if (consultorFilterReqs) {
            consultorFilterReqs.value = loggedInUser.Id;
            consultorFilterReqs.disabled = true;
        }
    } else {
        // Se FOR admin, garante que os filtros estejam habilitados e sem valor selecionado.
        const consultorFilterVisitas = document.getElementById('filter-consultor');
        const consultorFilterReqs = document.getElementById('filter-req-consultor');

        if (consultorFilterVisitas) {
            consultorFilterVisitas.disabled = false;
            // A linha abaixo garante que, se um admin logar após um não-admin, o filtro seja limpo.
            consultorFilterVisitas.value = '';
        }
        if (consultorFilterReqs) {
            consultorFilterReqs.disabled = false;
            consultorFilterReqs.value = '';
        }
    }
    // --- FIM DA ALTERAÇÃO ---

    updateAllCounters();
    
    applyAndRenderReceitas();
    applyAndRenderCustos();
    applyAndRenderFerias();
    applyAndRenderAtestados();
    applyAndRenderEpis();
    applyAndRenderAtivos();

    updateAllDashboards();
    initializeCalendar();
    applyFilters();
    renderCategoryFilters();
    renderItensDeRequisicao();
    applyRequisicaoFilters();
    
    hideLoadingOverlay();
}

    async function fetchConsultores() { const result = await nocoFetch('Consultores?nested[all]=true'); if (result && result.list) consultoresData = result.list; }
    async function fetchClientes() { const result = await nocoFetch('Clientes?nested[all]=true'); if (result && result.list) clientesData = result.list; }
    async function fetchVisitas() { const result = await nocoFetch('Visitas?nested[all]=true'); if(result && result.list) { visitsData = result.list.map(v => ({...v, startTime: v.HoraInicio ? `${v.DataVisita}T${v.HoraInicio}`:null, endTime: v.HoraFim ? `${v.DataVisita}T${v.HoraFim}`:null })); } else { visitsData = []; }}
    async function fetchReceitas() { const result = await nocoFetch('Receitas?nested[all]=true'); if (result && result.list) receitasData = result.list; }
    async function fetchCustos() { const result = await nocoFetch('Custos?nested[all]=true'); if (result && result.list) custosData = result.list; }
   async function fetchRequisicoes() { 
        const result = await nocoFetch('Requisicoes?nested[all]=true'); // Busca com os relacionamentos aninhados
        if(result && result.list) requisicoesData = result.list; else requisicoesData = []; 
    }
async function fetchRequisicoesItens() { 
        const result = await nocoFetch('Requisicoes_Itens?nested[all]=true'); 
        if(result && result.list) requisicoesItensData = result.list; else requisicoesItensData = []; 
    }
     async function fetchItensCatalogo() {
         const result = await nocoFetch('Itens_Catalogo?nested[all]=true');
         if(result && result.list) {
            allItems = result.list;
            itemData.consumo = allItems.reduce((acc, item) => {
                const category = item.Categoria || 'Outros';
                if(!acc[category]) acc[category] = [];
                acc[category].push({ 
                    id: item.Id, 
                    nome: item.Nome, 
                    categoria: category,
                    foto: item.Foto && item.Foto[0]?.signedPath ? `${NocoDB_BaseURL}/${item.Foto[0].signedPath}` : null 
                });
                return acc;
            }, {});
         }
    }
    async function fetchFerias() { const result = await nocoFetch('Ferias?nested[all]=true'); if(result && result.list) feriasData = result.list; else feriasData = []; }
    async function fetchAtestados() { const result = await nocoFetch('Atestados?nested[all]=true'); if(result && result.list) atestadosData = result.list; else atestadosData = []; }
    async function fetchEpis() { const result = await nocoFetch('Epis_Entregues?nested[all]=true'); if(result && result.list) episEntreguesData = result.list; else episEntreguesData = []; }
    async function fetchAtivos() { const result = await nocoFetch('Ativos_Entregues?nested[all]=true'); if(result && result.list) ativosData = result.list; else ativosData = []; }
    
    // --- Lógica de Autenticação e Sessão ---
    async function handleLogin(e) { e.preventDefault(); const username = document.getElementById('username').value, password = document.getElementById('password').value; if (!username || !password) { alert('Por favor, preencha usuário e senha.'); return; } showLoadingOverlay('Autenticando...'); const user = await authenticateUser(username, password); if (user) { sessionStorage.setItem('loggedInUser', JSON.stringify(user)); await initializeUserSession(user); } else { hideLoadingOverlay(); alert('Usuário ou senha inválidos.'); } }
 async function initializeUserSession(user) {
    loggedInUser = user;
    document.getElementById('logged-user-name').textContent = loggedInUser.Nome;
    document.querySelector('#logged-user-name + p').textContent = loggedInUser.Role || 'Consultor';
    const userAvatar = document.querySelector('#logged-user-name').closest('div').nextElementSibling;
    const consultorFilterWrapper = document.getElementById('dash-visit-consultor-wrapper');
    const clienteFilterWrapper = document.getElementById('dash-visit-cliente-wrapper');
    // --- INÍCIO DA ALTERAÇÃO: Restringir abas do Dashboard para Gestor ---
    const balancoTab = document.querySelector('.dashboard-nav-btn[data-target="dashboard-balanco"]');
    const receitasTab = document.querySelector('.dashboard-nav-btn[data-target="dashboard-receitas"]');
    const custosTab = document.querySelector('.dashboard-nav-btn[data-target="dashboard-custos"]');
    // A aba de visitas já foi selecionada anteriormente, mas vamos pegá-la de novo para clareza
    const visitasTabGestor = document.querySelector('.dashboard-nav-btn[data-target="dashboard-visitas"]'); 

    // Conteúdos das abas
    const balancoContent = document.getElementById('dashboard-balanco');
    const receitasContent = document.getElementById('dashboard-receitas');
    const custosContent = document.getElementById('dashboard-custos');
    const visitasContentGestor = document.getElementById('dashboard-visitas');

    if (loggedInUser.Role === 'Gestor') {
        // Esconde as abas indesejadas
        if (balancoTab) balancoTab.parentElement.style.display = 'none';
        if (receitasTab) receitasTab.parentElement.style.display = 'none';
        if (custosTab) custosTab.parentElement.style.display = 'none';

        // Garante que a aba Visitas seja a única ativa
        if (visitasTabGestor) {
             // Remove a classe de ativa de todas as outras abas, caso alguma tenha
            document.querySelectorAll('.dashboard-nav-btn').forEach(btn => {
                btn.classList.remove('border-brand-gold', 'text-brand-gold');
            });
            visitasTabGestor.classList.add('border-brand-gold', 'text-brand-gold');
        }
        
        // Garante que apenas o conteúdo de Visitas seja exibido
        if (balancoContent) balancoContent.classList.add('hidden');
        if (receitasContent) receitasContent.classList.add('hidden');
        if (custosContent) custosContent.classList.add('hidden');
        if (visitasContentGestor) visitasContentGestor.classList.remove('hidden');

    } else if (loggedInUser.Role === 'Admin') {
        // Bloco ELSE para garantir que o Admin sempre veja tudo
        // Reverte as alterações caso um Admin faça login após um Gestor
        if (balancoTab) balancoTab.parentElement.style.display = '';
        if (receitasTab) receitasTab.parentElement.style.display = '';
        if (custosTab) custosTab.parentElement.style.display = '';
    }
    // --- FIM DA ALTERAÇÃO ---
    if (consultorFilterWrapper && clienteFilterWrapper) {
        if (loggedInUser && (loggedInUser.Role === 'Admin' || loggedInUser.Role === 'Gestor')) {
            consultorFilterWrapper.classList.remove('hidden');
            clienteFilterWrapper.classList.remove('hidden');
        } else {
            consultorFilterWrapper.classList.add('hidden');
            clienteFilterWrapper.classList.add('hidden');
        }
    }
    if (userAvatar && loggedInUser.Foto && loggedInUser.Foto[0]?.signedPath) {
        userAvatar.src = `${NocoDB_BaseURL}/${loggedInUser.Foto[0].signedPath}`;
    } else if(userAvatar) {
        userAvatar.src = `https://i.pravatar.cc/150?u=${loggedInUser.Login || loggedInUser.Nome}`;
    }
    allElements.loginScreen.classList.add('hidden');
    allElements.mainApp.classList.remove('hidden');

    // --- LÓGICA DE FILTROS REMOVIDA DAQUI ---
    // Apenas a lógica de visibilidade do menu permanece
    if (loggedInUser.Role === 'Admin') {
        // Admin vê todas as páginas, não precisa de filtro.
        document.querySelectorAll('.nav-link').forEach(link => {
            link.style.display = 'flex';
        });
    } else {
        if (loggedInUser.Role === 'Gestor') {
            allowedPages = ['dashboard', 'visitas', 'requisicao'];
        } else if (loggedInUser.Role === 'Consultor') {
            allowedPages = ['visitas', 'requisicao'];
        }

        // Aplica o filtro de páginas para Gestor e Consultor
        document.querySelectorAll('.nav-link').forEach(link => {
            const target = link.dataset.target;
            link.style.display = allowedPages.includes(target) ? 'flex' : 'none';
        });
    }
     const financeiroTab = document.querySelector('.dashboard-nav-btn[data-target="dashboard-financeiro"]');
    const visitasTab = document.querySelector('.dashboard-nav-btn[data-target="dashboard-visitas"]');
    const financeiroContent = document.getElementById('dashboard-financeiro');
    const visitasContent = document.getElementById('dashboard-visitas');

    if (financeiroTab && visitasTab && financeiroContent && visitasContent) {
        if (loggedInUser.Role === 'Gestor') {
            // 1. Esconde a aba "Financeiro"
            financeiroTab.parentElement.style.display = 'none';

            // 2. Garante que a aba "Visitas" seja a ativa por padrão
            financeiroTab.classList.remove('border-brand-gold', 'text-brand-gold');
            visitasTab.classList.add('border-brand-gold', 'text-brand-gold');

            // 3. Mostra o conteúdo de "Visitas" e esconde o de "Financeiro"
            financeiroContent.classList.add('hidden');
            visitasContent.classList.remove('hidden');
        } else {
            // Garante que para outros roles (Admin), a aba esteja visível e o dashboard volte ao padrão
            financeiroTab.parentElement.style.display = ''; // Reverte o 'display: none'
            visitasTab.classList.remove('border-brand-gold', 'text-brand-gold');
            financeiroTab.classList.add('border-brand-gold', 'text-brand-gold');
            visitasContent.classList.add('hidden');
            financeiroContent.classList.remove('hidden');
        }
    }
    await fetchAllData(); // Chamamos a função que agora contém a lógica correta

    let savedPage = sessionStorage.getItem('currentPage');
    
    savedPage = savedPage || (loggedInUser.Role === 'Admin' ? 'dashboard' : 'visitas');
    navigateTo(savedPage, true);
    restoreSubTabState();
    hideLoadingOverlay();
}
    async function checkSession() { const userString = sessionStorage.getItem('loggedInUser'); if (userString) { allElements.loginScreen.classList.add('hidden'); allElements.mainApp.classList.remove('hidden'); showLoadingOverlay('Restaurando sessão...'); await initializeUserSession(JSON.parse(userString)); } else { allElements.loginScreen.classList.remove('hidden'); } }
    async function authenticateUser(login, senha) { const endpoint = `Consultores?where=(Login,eq,${login})~and(Senha,eq,${senha})`; const result = await nocoFetch(endpoint); return (result && result.list && result.list.length > 0) ? result.list[0] : null; }
 function restoreSubTabState() {
        const currentPageId = sessionStorage.getItem('currentPage');
        if (!currentPageId) return;

        const subTabKey = `activeSubTab_${currentPageId}`;
        const savedSubTabId = sessionStorage.getItem(subTabKey);

        if (savedSubTabId) {
            // Encontra o botão da sub-aba correspondente na página que está sendo carregada
            const subTabButton = document.querySelector(`#${currentPageId} button[data-target="${savedSubTabId}"]`);
            
            if (subTabButton) {
                // Simula o clique no botão para ativar a aba e seu conteúdo corretamente
                handleTabClick(subTabButton);
            }
        }
    }
    // --- Funções de Renderização ---
    function renderConsultores(data = consultoresData) { 
        document.getElementById('rh-cards-container').innerHTML = data.map(c => createConsultorCard(c)).join(''); 
    }
    function createConsultorCard(c) {
        const fotoUrl = (c.Foto && c.Foto[0]?.signedPath) ? `${NocoDB_BaseURL}/${c.Foto[0].signedPath}` : `https://i.pravatar.cc/150?u=${c.Login || c.Nome}`;
        const dataset = Object.keys(c).map(k => `data-${k.toLowerCase()}="${c[k] && typeof c[k] === 'object' ? JSON.stringify(c[k]) : (c[k] || '')}"`).join(' ');
        const statusClass = c.Status === 'Ativo' ? 'bg-green-500' : 'bg-red-500';
        return `<div class="rh-card relative bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 flex flex-col items-center text-center cursor-pointer hover:shadow-xl transition-shadow" ${dataset} data-nome="${c.Nome}" data-status="${c.Status || 'Ativo'}">
                    <span class="absolute top-2 right-2 h-3 w-3 rounded-full ${statusClass}" title="Status: ${c.Status || 'Ativo'}"></span>
                    <img src="${fotoUrl}" class="w-24 h-24 rounded-full object-cover mb-4">
                    <h4 class="font-bold text-lg text-gray-800 dark:text-white">${c.Nome}</h4>
                    <p class="text-sm text-gray-500 dark:text-gray-400">${c.Email || ''}</p>
                    <div class="flex space-x-4 mt-4">
                        <a href="https://wa.me/${c.Telefone || ''}" target="_blank" class="text-green-500 hover:text-green-600"><i class="fab fa-whatsapp fa-2x"></i></a>
                    </div>
                </div>`;
    }
    function renderClientes(data = clientesData) { document.getElementById('cliente-cards-container').innerHTML = data.map(c => createClienteCard(c)).join(''); }
    function createClienteCard(c) { 
        const fotoUrl = (c.Foto && c.Foto[0]?.signedPath) ? `${NocoDB_BaseURL}/${c.Foto[0].signedPath}` : `https://picsum.photos/seed/${c.Nome.replace(/\s/g, '')}/100/100`; 
        const dataset = Object.keys(c).map(k => `data-${k.toLowerCase()}="${c[k] && typeof c[k] === 'object' ? JSON.stringify(c[k]) : (c[k] || '')}"`).join(' '); 
        const statusClass = c.Status === 'Ativo' ? 'bg-green-500' : 'bg-red-500';
        return `<div class="cliente-card relative bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 flex flex-col items-center text-center cursor-pointer hover:shadow-xl transition-shadow" ${dataset} data-nome="${c.Nome}" data-status="${c.Status || 'Ativo'}"> 
                    <span class="absolute top-2 right-2 h-3 w-3 rounded-full ${statusClass}" title="Status: ${c.Status || 'Ativo'}"></span>
                    <img src="${fotoUrl}" class="w-24 h-24 rounded-lg object-cover mb-4"> 
                    <h4 class="font-bold text-lg text-gray-800 dark:text-white">${c.Nome}</h4> 
                    <p class="text-sm text-gray-500 dark:text-gray-400">Responsável: ${c.Responsavel || ''}</p> 
                    <div class="flex space-x-4 mt-4"> 
                        <a href="https://wa.me/${c.Telefone || ''}" target="_blank" class="text-green-500 hover:text-green-600"><i class="fab fa-whatsapp fa-2x"></i></a> 
                        <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(c.Endereco || '')}" target="_blank" class="text-blue-500 hover:text-blue-600"><i class="fas fa-map-marker-alt fa-2x"></i></a> 
                    </div> 
                </div>`; 
    }
    
    function renderReceitas(data = receitasData) {
    const tbody = document.getElementById('receitas-table-body');
    const cardsContainer = document.getElementById('receitas-cards-container');
    if (!tbody || !cardsContainer) return;

    tbody.innerHTML = '';
    cardsContainer.innerHTML = '';

    data.forEach(r => {
        const statusClass = r.Status === 'Pago' ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800';
        const actionsHTML = `
            <button class="table-details-btn text-gray-500" data-type="receita"><i class="fas fa-eye"></i></button>
            <button class="table-edit-btn text-blue-500" data-type="receita"><i class="fas fa-edit"></i></button>
            <button class="table-delete-btn text-red-500" data-type="receita"><i class="fas fa-trash"></i></button>`;

        // Tabela Desktop
        tbody.innerHTML += `
            <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700" data-id="${r.Id}">
                <td class="px-6 py-4">${r.Clientes?.Nome || 'N/A'}</td>
                <td class="px-6 py-4">${new Date(r.Vencimento + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                <td class="px-6 py-4">${(r.Valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                <td class="px-6 py-4"><span class="text-xs font-semibold px-2 py-0.5 rounded-full ${statusClass}">${r.Status}</span></td>
                <td class="px-6 py-4 space-x-2">${actionsHTML}</td>
            </tr>`;

        // Card Mobile
        cardsContainer.innerHTML += `
            <div class="p-4 bg-white rounded-lg shadow dark:bg-gray-800 border dark:border-gray-700" data-id="${r.Id}">
                <div class="flex justify-between items-start">
                    <p class="text-lg font-semibold text-gray-900 dark:text-white">${r.Clientes?.Nome || 'N/A'}</p>
                    <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${statusClass}">${r.Status}</span>
                </div>
                <div class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                    <p><strong>Vencimento:</strong> ${new Date(r.Vencimento + 'T00:00:00').toLocaleDateString('pt-BR')}</p>
                    <p><strong>Valor:</strong> ${(r.Valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                </div>
                <div class="flex justify-end pt-2 mt-2 border-t dark:border-gray-600 space-x-2">${actionsHTML}</div>
            </div>`;
    });
}
function renderCustos(data = custosData) {
    const tbody = document.getElementById('custos-table-body');
    const cardsContainer = document.getElementById('custos-cards-container');
    if (!tbody || !cardsContainer) return;

    tbody.innerHTML = '';
    cardsContainer.innerHTML = '';

    data.forEach(c => {
        const statusClass = c.Status === 'Pago' ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800';
        const actionsHTML = `
            <button class="table-details-btn text-gray-500" data-type="custo"><i class="fas fa-eye"></i></button>
            <button class="table-edit-btn text-blue-500" data-type="custo"><i class="fas fa-edit"></i></button>
            <button class="table-delete-btn text-red-500" data-type="custo"><i class="fas fa-trash"></i></button>`;

        // Tabela Desktop
        tbody.innerHTML += `
            <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700" data-id="${c.Id}">
                <td class="px-6 py-4">${c.Credor}</td>
                <td class="px-6 py-4">${new Date(c.Vencimento + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                <td class="px-6 py-4">${(c.Valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                <td class="px-6 py-4"><span class="text-xs font-semibold px-2 py-0.5 rounded-full ${statusClass}">${c.Status}</span></td>
                <td class="px-6 py-4 space-x-2">${actionsHTML}</td>
            </tr>`;

        // Card Mobile
        cardsContainer.innerHTML += `
            <div class="p-4 bg-white rounded-lg shadow dark:bg-gray-800 border dark:border-gray-700" data-id="${c.Id}">
                <div class="flex justify-between items-start">
                    <p class="text-lg font-semibold text-gray-900 dark:text-white">${c.Credor}</p>
                    <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${statusClass}">${c.Status}</span>
                </div>
                <div class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                    <p><strong>Vencimento:</strong> ${new Date(c.Vencimento + 'T00:00:00').toLocaleDateString('pt-BR')}</p>
                    <p><strong>Valor:</strong> ${(c.Valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                </div>
                <div class="flex justify-end pt-2 mt-2 border-t dark:border-gray-600 space-x-2">${actionsHTML}</div>
            </div>`;
    });
}
    function renderFerias(data = feriasData) {
    const tbody = document.getElementById('ferias-table-body');
    const cardsContainer = document.getElementById('ferias-cards-container');
    if (!tbody || !cardsContainer) return;

    tbody.innerHTML = '';
    cardsContainer.innerHTML = '';

    data.forEach(f => {
        const inicio = new Date(f.DataInicio + 'T00:00:00');
        const retorno = new Date(f.DataRetorno + 'T00:00:00');
        const dias = Math.round((retorno - inicio) / (1000 * 60 * 60 * 24)) + 1;
        const actionsHTML = `
            <button class="table-details-btn text-gray-500" data-type="ferias"><i class="fas fa-eye"></i></button>
            <button class="table-edit-btn text-blue-500" data-type="ferias"><i class="fas fa-edit"></i></button>
            <button class="table-delete-btn text-red-500" data-type="ferias"><i class="fas fa-trash"></i></button>`;

        // Tabela Desktop
        tbody.innerHTML += `
            <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700" data-id="${f.Id}">
                <td class="px-6 py-4">${f.Consultores?.Nome || 'N/A'}</td>
                <td class="px-6 py-4">${inicio.toLocaleDateString('pt-BR')}</td>
                <td class="px-6 py-4">${retorno.toLocaleDateString('pt-BR')}</td>
                <td class="px-6 py-4">${dias}</td>
                <td class="px-6 py-4 space-x-2">${actionsHTML}</td>
            </tr>`;

        // Card Mobile
        cardsContainer.innerHTML += `
            <div class="p-4 bg-white rounded-lg shadow dark:bg-gray-800 border dark:border-gray-700" data-id="${f.Id}">
                <p class="text-lg font-semibold text-gray-900 dark:text-white">${f.Consultores?.Nome || 'N/A'}</p>
                <div class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                    <p><strong>Início:</strong> ${inicio.toLocaleDateString('pt-BR')}</p>
                    <p><strong>Retorno:</strong> ${retorno.toLocaleDateString('pt-BR')}</p>
                    <p><strong>Dias:</strong> ${dias}</p>
                </div>
                <div class="flex justify-end pt-2 mt-2 border-t dark:border-gray-600 space-x-2">${actionsHTML}</div>
            </div>`;
    });
}
function renderAtestados(data = atestadosData) {
    const tbody = document.getElementById('atestados-table-body');
    const cardsContainer = document.getElementById('atestados-cards-container');
    if (!tbody || !cardsContainer) return;

    tbody.innerHTML = '';
    cardsContainer.innerHTML = '';

    data.forEach(a => {
        const anexoUrl = a.Anexo && a.Anexo[0]?.signedPath ? `${NocoDB_BaseURL}/${a.Anexo[0].signedPath}` : '#';
        const anexoHTML = a.Anexo && a.Anexo[0] ? `<a href="${anexoUrl}" target="_blank" class="text-brand-gold hover:underline"><i class="fas fa-paperclip"></i> Ver</a>` : 'Nenhum';
        const actionsHTML = `
            <button class="table-details-btn text-gray-500" data-type="atestado"><i class="fas fa-eye"></i></button>
            <button class="table-edit-btn text-blue-500" data-type="atestado"><i class="fas fa-edit"></i></button>
            <button class="table-delete-btn text-red-500" data-type="atestado"><i class="fas fa-trash"></i></button>`;

        tbody.innerHTML += `
            <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700" data-id="${a.Id}">
                <td class="px-6 py-4">${a.Consultores?.Nome || 'N/A'}</td>
                <td class="px-6 py-4">${new Date(a.DataInicio + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                <td class="px-6 py-4">${new Date(a.DataRetorno + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                <td class="px-6 py-4">${anexoHTML}</td>
                <td class="px-6 py-4 space-x-2">${actionsHTML}</td>
            </tr>`;

        cardsContainer.innerHTML += `
            <div class="p-4 bg-white rounded-lg shadow dark:bg-gray-800 border dark:border-gray-700" data-id="${a.Id}">
                <p class="text-lg font-semibold text-gray-900 dark:text-white">${a.Consultores?.Nome || 'N/A'}</p>
                <div class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                    <p><strong>Início:</strong> ${new Date(a.DataInicio + 'T00:00:00').toLocaleDateString('pt-BR')}</p>
                    <p><strong>Retorno:</strong> ${new Date(a.DataRetorno + 'T00:00:00').toLocaleDateString('pt-BR')}</p>
                    <p><strong>Anexo:</strong> ${anexoHTML}</p>
                </div>
                <div class="flex justify-end pt-2 mt-2 border-t dark:border-gray-600 space-x-2">${actionsHTML}</div>
            </div>`;
    });
}
function renderEpis(data = episEntreguesData) {
    const tbody = document.getElementById('epis-table-body');
    const cardsContainer = document.getElementById('epis-cards-container');
    if (!tbody || !cardsContainer) return;

    tbody.innerHTML = '';
    cardsContainer.innerHTML = '';

    data.forEach(e => {
        const actionsHTML = `
            <button class="table-details-btn text-gray-500" data-type="epi"><i class="fas fa-eye"></i></button>
            <button class="table-edit-btn text-blue-500" data-type="epi"><i class="fas fa-edit"></i></button>
            <button class="table-delete-btn text-red-500" data-type="epi"><i class="fas fa-trash"></i></button>`;

        tbody.innerHTML += `
            <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700" data-id="${e.Id}">
                <td class="px-6 py-4">${e.Consultores?.Nome || 'N/A'}</td>
                <td class="px-6 py-4">${e.Item}</td>
                <td class="px-6 py-4">${e.Quantidade}</td>
                <td class="px-6 py-4">${new Date(e.DataEntrega + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                <td class="px-6 py-4 space-x-2">${actionsHTML}</td>
            </tr>`;

        cardsContainer.innerHTML += `
            <div class="p-4 bg-white rounded-lg shadow dark:bg-gray-800 border dark:border-gray-700" data-id="${e.Id}">
                <div class="flex justify-between items-start">
                    <p class="text-lg font-semibold text-gray-900 dark:text-white">${e.Consultores?.Nome || 'N/A'}</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">${new Date(e.DataEntrega + 'T00:00:00').toLocaleDateString('pt-BR')}</p>
                </div>
                <div class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                    <p><strong>Item:</strong> ${e.Item}</p>
                    <p><strong>Quantidade:</strong> ${e.Quantidade}</p>
                </div>
                <div class="flex justify-end pt-2 mt-2 border-t dark:border-gray-600 space-x-2">${actionsHTML}</div>
            </div>`;
    });
}
function renderAtivos(data = ativosData) {
    const tbody = document.getElementById('ativos-table-body');
    const cardsContainer = document.getElementById('ativos-cards-container');
    if (!tbody || !cardsContainer) return;

    tbody.innerHTML = '';
    cardsContainer.innerHTML = '';

    data.forEach(a => {
        const devolucaoStr = a.DataDevolucao ? new Date(a.DataDevolucao + 'T00:00:00').toLocaleDateString('pt-BR') : 'Em uso';
        const actionsHTML = `
            <button class="table-details-btn text-gray-500" data-type="ativo"><i class="fas fa-eye"></i></button>
            <button class="table-edit-btn text-blue-500" data-type="ativo"><i class="fas fa-edit"></i></button>
            <button class="table-delete-btn text-red-500" data-type="ativo"><i class="fas fa-trash"></i></button>`;

        tbody.innerHTML += `
            <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700" data-id="${a.Id}">
                <td class="px-6 py-4">${a.Consultores?.Nome || 'N/A'}</td>
                <td class="px-6 py-4">${a.Item}</td>
                <td class="px-6 py-4">${new Date(a.DataEntrega + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                <td class="px-6 py-4">${devolucaoStr}</td>
                <td class="px-6 py-4 space-x-2">${actionsHTML}</td>
            </tr>`;

        cardsContainer.innerHTML += `
            <div class="p-4 bg-white rounded-lg shadow dark:bg-gray-800 border dark:border-gray-700" data-id="${a.Id}">
                 <div class="flex justify-between items-start">
                    <p class="text-lg font-semibold text-gray-900 dark:text-white">${a.Consultores?.Nome || 'N/A'}</p>
                    <p class="text-sm font-semibold text-gray-800 dark:text-white">${a.Item}</p>
                </div>
                <div class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                    <p><strong>Entrega:</strong> ${new Date(a.DataEntrega + 'T00:00:00').toLocaleDateString('pt-BR')}</p>
                    <p><strong>Devolução:</strong> ${devolucaoStr}</p>
                </div>
                <div class="flex justify-end pt-2 mt-2 border-t dark:border-gray-600 space-x-2">${actionsHTML}</div>
            </div>`;
    });
}
        function applyConsultorFilters() {
        const searchTerm = document.getElementById('rh-search').value.toLowerCase();
        const statusFilterBtn = document.querySelector('#consultor-status-filters .filter-btn-active');
        const statusFilter = statusFilterBtn ? statusFilterBtn.dataset.status : 'Todos';

        const filteredData = consultoresData.filter(consultor => {
            const nameMatch = consultor.Nome.toLowerCase().includes(searchTerm);
            const statusMatch = (statusFilter === 'Todos') || (consultor.Status === statusFilter);
            return nameMatch && statusMatch;
        });

        renderConsultores(filteredData);
    }
    // --- Lógica de Submissão de Formulários (CRUD) ---
    async function handleFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        let endpoint = '', body = {}, id = null, callback = null;

        const rhSubFormIds = ['ferias-form', 'atestados-form', 'epis-form', 'ativos-form'];
        
        switch (form.id) {
            case 'item-form':
                id = form.dataset.id;
                endpoint = id ? `Itens_Catalogo/${id}` : 'Itens_Catalogo';
                const itemName = document.getElementById('item-name').value;
                const itemCategory = form.querySelector('#item-category-input').value;
                body = { Nome: itemName, Categoria: itemCategory, Tipo: 'Consumo' };
                const itemFotoInput = document.getElementById('item-foto');
                if (itemFotoInput && itemFotoInput.files[0]) {
                    showLoadingOverlay('Enviando imagem do item...');
                    const fotoData = await uploadFile('Itens_Catalogo', 'Foto', itemFotoInput.files[0]);
                    if(fotoData) body.Foto = [fotoData];
                }
                callback = async () => { await fetchItensCatalogo(); renderItensDeRequisicao(); renderCategoryFilters(); hideModal(allElements.itemFormModal); };
                break;
            
            case 'rh-form':
            case 'cliente-form': {
                const isConsultor = form.id === 'rh-form';
                const table = isConsultor ? 'Consultores' : 'Clientes';
                const fileInput = form.querySelector('input[type="file"]');
                let fileData = null;

                if (fileInput && fileInput.files[0]) {
                    showLoadingOverlay('Enviando imagem...');
                    fileData = await uploadFile(table, 'Foto', fileInput.files[0]);
                    if (!fileData) { hideLoadingOverlay(); return; }
                }

                id = form.querySelector(isConsultor ? '#rh-id' : '#cliente-id')?.value;
                endpoint = id ? `${table}/${id}` : table;
                
                if(isConsultor) {
                    body = { 
                        Nome: form.querySelector('#rh-nome').value, 
                        DataNascimento: form.querySelector('#rh-nasc').value || null, 
                        Telefone: form.querySelector('#rh-tel').value, 
                        Email: form.querySelector('#rh-email').value, 
                        Login: form.querySelector('#rh-login').value, 
                        InicioVinculo: form.querySelector('#rh-inicio').value || null, 
                        FimVinculo: form.querySelector('#rh-fim').value || null, 
                        CNPJ: form.querySelector('#rh-cnpj').value, 
                        RazaoSocial: form.querySelector('#rh-razao').value, 
                        ValorHora: parseFloat(form.querySelector('#rh-valor').value) || 0,
                        Status: form.querySelector('#rh-status').value, 
                        Role: form.querySelector('#rh-role').value, 
                        Endereco: form.querySelector('#rh-endereco').value, 
                        Observacao: form.querySelector('#rh-obs').value 
                    };
                    const senha = form.querySelector('#rh-senha').value; if (senha) body.Senha = senha;
                    callback = async () => { await fetchConsultores(); applyConsultorFilters(); };
                } else {
                    body = { 
                        Nome: form.querySelector('#cliente-nome').value, 
                        RazaoSocial: form.querySelector('#cliente-razao').value, 
                        CNPJ: form.querySelector('#cliente-cnpj').value, 
                        Telefone: form.querySelector('#cliente-tel').value, 
                        Email: form.querySelector('#cliente-email').value, 
                        HorasContratadas: parseInt(form.querySelector('#cliente-horas').value) || 0, 
                        Status: form.querySelector('#cliente-status').value, 
                        Responsavel: form.querySelector('#cliente-responsavel').value, 
                        CPFResponsavel: form.querySelector('#cliente-cpf').value, 
                        IPTU: form.querySelector('#cliente-iptu').value, 
                        SenhaPortal: form.querySelector('#cliente-senha-portal').value, 
                        Endereco: form.querySelector('#cliente-endereco').value, 
                        Observacao: form.querySelector('#cliente-obs').value 
                    };
                    callback = async () => { await fetchClientes(); applyClienteFilters(); };
                }

                if (fileData) body.Foto = [fileData];
                break;
            }
            case 'receita-form':
                id = form.dataset.id;
                endpoint = id ? `Receitas/${id}` : 'Receitas';
                body = { 
                    Vencimento: form.querySelector('#receita-vencimento').value, 
                    Valor: parseFloat(form.querySelector('#receita-valor').value), 
                    Status: form.querySelector('#receita-status-form').value, 
                    Observacao: form.querySelector('#receita-obs').value 
                };

                const clienteId = parseInt(form.querySelector('#receita-cliente-form').value);

                // Agora, adicionamos o campo de cliente no formato correto.
                if (id) { 
                    // Se 'id' existe, é uma EDIÇÃO (PATCH).
                    // Enviamos o ID da chave estrangeira diretamente.
                    body.Clientes_id = clienteId; 
                } else { 
                    // Se 'id' não existe, é uma CRIAÇÃO (POST).
                    // Enviamos o objeto de relacionamento.
                    body.Clientes = { "Id": clienteId }; 
                }
                callback = async () => { await fetchReceitas(); applyAndRenderReceitas(); };
                break;
            case 'custo-form':
                id = form.dataset.id;
                endpoint = id ? `Custos/${id}` : 'Custos';
                body = { Credor: form.querySelector('#custo-credor').value, Vencimento: form.querySelector('#custo-vencimento').value, Valor: parseFloat(form.querySelector('#custo-valor').value), Status: form.querySelector('#custo-status-form').value, Observacao: form.querySelector('#custo-obs').value };
                callback = async () => { await fetchCustos(); applyAndRenderCustos(); };
                break;
             case 'visita-form':
                id = form.querySelector('#visita-id').value;
                endpoint = id ? `Visitas/${id}` : 'Visitas';
                const isRescheduling = form.querySelector('#is-rescheduling').value === 'true';

                body = { 
                    DataVisita: form.querySelector('#visita-data').value, 
                    HoraInicio: form.querySelector('#visita-inicio').value, 
                    HoraFim: form.querySelector('#visita-fim').value, 
                    Atividades: form.querySelector('#visita-atividades').value 
                };

                const consultorIdVisita = parseInt(form.querySelector('#visita-consultor').value);
                const clienteIdVisita = parseInt(form.querySelector('#visita-cliente').value);

                if (id) {
                    // Se for uma EDIÇÃO (PATCH)
                    body.Consultores_id = consultorIdVisita;
                    body.Clientes_id = clienteIdVisita;

                    // --- INÍCIO DA ALTERAÇÃO 1: LÓGICA DE REMARCAÇÃO AUTOMÁTICA ---
                    // Pega a visita original para comparar as datas/horas
                    const originalVisit = visitsData.find(v => v.Id == id);
                    if (originalVisit) {
                        const newDate = form.querySelector('#visita-data').value;
                        const newStart = form.querySelector('#visita-inicio').value;
                        const newEnd = form.querySelector('#visita-fim').value;

                        // Compara se houve alguma alteração na data ou nos horários
                        if (originalVisit.DataVisita !== newDate || originalVisit.HoraInicio !== newStart || originalVisit.HoraFim !== newEnd) {
                            // Se mudou, marca como Remarcada e redefine o status para Agendada
                            body.Remarcada = true;
                            body.Status = 'Agendada';
                        }
                    }
                    // --- FIM DA ALTERAÇÃO 1 ---

                } else {
                    // Se for uma CRIAÇÃO (POST)
                    body.Consultores = { "Id": consultorIdVisita };
                    body.Clientes = { "Id": clienteIdVisita };
                }

                // Esta lógica original do botão "Remarcar" ainda funciona como um backup
                if(isRescheduling) { 
                    body.Status = 'Agendada'; 
                    body.Remarcada = true; 
                } else if (!id) { 
                    body.Status = 'Agendada'; 
                }
                
                callback = async () => { await fetchVisitas(); applyFilters(); hideModal(allElements.visitaFormModal); };
                break;
            case 'ferias-form':
                id = form.dataset.id;
                endpoint = id ? `Ferias/${id}` : 'Ferias';
                body = { 
                    DataInicio: form.querySelector('#ferias-inicio').value, 
                    DataRetorno: form.querySelector('#ferias-retorno').value 
                };
                const consultorIdFerias = parseInt(form.querySelector('#ferias-consultor').value);

                if (id) { // Se for edição
                    body.Consultores_id = consultorIdFerias;
                } else { // Se for criação
                    body.Consultores = { "Id": consultorIdFerias };
                }
                // --- FIM DA ALTERAÇÃO ---

                callback = async () => { await fetchFerias(); applyAndRenderFerias(); };
                break;
            case 'atestados-form':
                id = form.dataset.id;
                endpoint = id ? `Atestados/${id}` : 'Atestados';
                body = { 
                    DataInicio: form.querySelector('#atestados-inicio').value, 
                    DataRetorno: form.querySelector('#atestados-retorno').value 
                };
                const consultorIdAtestados = parseInt(form.querySelector('#atestados-consultor').value);

                if (id) { // Se for edição
                    body.Consultores_id = consultorIdAtestados;
                } else { // Se for criação
                    body.Consultores = { "Id": consultorIdAtestados };
                }
                // --- FIM DA ALTERAÇÃO ---
                
                const anexoInput = form.querySelector('#atestados-anexo');
                if (anexoInput && anexoInput.files[0]) {
                    showLoadingOverlay('Enviando anexo...');
                    const anexoData = await uploadFile('Atestados', 'Anexo', anexoInput.files[0]);
                    if (anexoData) { body.Anexo = [anexoData]; } 
                    else { hideLoadingOverlay(); return; }
                }
                callback = async () => { await fetchAtestados(); applyAndRenderAtestados(); };
                break;
            case 'epis-form':
                id = form.dataset.id;
                endpoint = id ? `Epis_Entregues/${id}` : 'Epis_Entregues';
                 body = { 
                    Item: form.querySelector('#epis-item').value, 
                    Quantidade: parseInt(form.querySelector('#epis-qtd').value), 
                    DataEntrega: form.querySelector('#epis-data').value, 
                    Observacao: form.querySelector('#epis-obs').value 
                };
                const consultorIdEpis = parseInt(form.querySelector('#epis-consultor').value);

                if (id) { // Se for edição
                    body.Consultores_id = consultorIdEpis;
                } else { // Se for criação
                    body.Consultores = { "Id": consultorIdEpis };
                }
                // --- FIM DA ALTERAÇÃO ---
                
                callback = async () => { await fetchEpis(); applyAndRenderEpis(); };
                break;
            case 'ativos-form':
                id = form.dataset.id;
                endpoint = id ? `Ativos_Entregues/${id}` : 'Ativos_Entregues';
                 body = { 
                    Item: form.querySelector('#ativos-item').value, 
                    DataEntrega: form.querySelector('#ativos-entrega').value, 
                    DataDevolucao: form.querySelector('#ativos-devolucao').value || null, 
                    Observacao: form.querySelector('#ativos-obs').value 
                };
                const consultorIdAtivos = parseInt(form.querySelector('#ativos-consultor').value);

                if (id) { // Se for edição
                    body.Consultores_id = consultorIdAtivos;
                } else { // Se for criação
                    body.Consultores = { "Id": consultorIdAtivos };
                }
                // --- FIM DA ALTERAÇÃO ---
                
                callback = async () => { await fetchAtivos(); applyAndRenderAtivos(); };
                break;
            default: return;
        }

        const method = id ? 'PATCH' : 'POST';
        showLoadingOverlay('Salvando...');
        const result = await nocoFetch(endpoint, { method, body: JSON.stringify(body) });
        
        hideLoadingOverlay();

        if (result) {
            if (callback) await callback();
            
            if(rhSubFormIds.includes(form.id)) {
                const historyContainerId = form.id.replace('-form', '-history-container');
                const formContainerId = form.id.replace('-form', '-form-container');
                hideSubFormToggle(historyContainerId, formContainerId);
            } else if (form.id === 'rh-form' || form.id === 'cliente-form'){
                const cardsContainerId = form.id.replace('-form', '-cards-container');
                const formContainerId = form.id.replace('-form', '-form-container');
                hideFormToggle(cardsContainerId, formContainerId);
            }

            form.reset();
            delete form.dataset.id;
            updateAllCounters();
            updateAllDashboards();
        }
    }
    
    async function handleDelete() {
        if (!activeDeleteItem || !activeDeleteItem.type) return;
        const { id, type } = activeDeleteItem;
        let endpoint = '', callback = null;
        switch(type) {
            case 'receita': endpoint = `Receitas/${id}`; callback = async () => { await fetchReceitas(); applyAndRenderReceitas(); }; break;
            case 'custo': endpoint = `Custos/${id}`; callback = async () => { await fetchCustos(); applyAndRenderCustos(); }; break;
            case 'visita': endpoint = `Visitas/${id}`; callback = async () => { await fetchVisitas(); applyFilters(); }; break;
            case 'consultor': endpoint = `Consultores/${id}`; callback = async () => { await fetchConsultores(); renderConsultores(); }; break;
            case 'cliente': endpoint = `Clientes/${id}`; callback = async () => { await fetchClientes(); renderClientes(); }; break;
            case 'ferias': endpoint = `Ferias/${id}`; callback = async () => { await fetchFerias(); applyAndRenderFerias(); }; break;
            case 'atestado': endpoint = `Atestados/${id}`; callback = async () => { await fetchAtestados(); applyAndRenderAtestados(); }; break;
            case 'epi': endpoint = `Epis_Entregues/${id}`; callback = async () => { await fetchEpis(); applyAndRenderEpis(); }; break;
            case 'ativo': endpoint = `Ativos_Entregues/${id}`; callback = async () => { await fetchAtivos(); applyAndRenderAtivos(); }; break;
            case 'item_catalogo': endpoint = `Itens_Catalogo/${id}`; callback = async () => { await fetchItensCatalogo(); renderItensDeRequisicao(); renderCategoryFilters(); }; break;
            case 'requisicao': endpoint = `Requisicoes/${id}`; callback = async () => { await fetchRequisicoes(); applyRequisicaoFilters(); }; break;
            default: hideModal(allElements.deleteConfirmModal); return;
        }
        showLoadingOverlay('Apagando...');
        const result = await nocoFetch(endpoint, { method: 'DELETE' });
        hideLoadingOverlay();
        if (result && result.success) {
            if (callback) await callback();
            activeDeleteItem.element?.remove();
            updateAllCounters();
            updateAllDashboards();
        }
        hideModal(allElements.detailsModal);
        hideModal(allElements.deleteConfirmModal);
        activeDeleteItem = { id: null, type: null, element: null };
    }
async function handleEditItemQuantity(itemJoinId, currentQty, itemName, requisicaoId) {
    const newQtyStr = prompt(`Qual a nova quantidade para o item "${itemName}"?`, currentQty);
    
    // Retorna se o usuário cancelar o prompt
    if (newQtyStr === null) {
        return; 
    }

    const newQty = parseInt(newQtyStr);

    if (isNaN(newQty) || newQty < 0) {
        alert("Por favor, insira um número válido para a quantidade.");
        return; // Retorna se a entrada for inválida
    }

    showLoadingOverlay('Atualizando quantidade...');
    const result = await nocoFetch(`Requisicoes_Itens/${itemJoinId}`, {
        method: 'PATCH',
        body: JSON.stringify({ "Quantidade": newQty })
    });
    hideLoadingOverlay();

    if (result) {
        // 1. Atualiza o array de dados local para consistência
        const itemInLocalData = requisicoesItensData.find(item => item.Id === itemJoinId);
        if (itemInLocalData) {
            itemInLocalData.Quantidade = newQty;
        }

        // 2. Atualiza a UI diretamente no modal aberto
        const tableQtyElement = document.getElementById(`item-qty-table-${itemJoinId}`);
        if (tableQtyElement) {
            tableQtyElement.textContent = newQty;
        }

        const cardQtyElement = document.getElementById(`item-qty-card-${itemJoinId}`);
        if (cardQtyElement) {
            cardQtyElement.textContent = `Quantidade: ${newQty}`;
        }
        
        // 3. Atualiza o atributo onclick do botão de edição para refletir a nova quantidade
        const safeItemName = itemName.replace(/'/g, "\\'").replace(/"/g, "&quot;");
        const editButtons = document.querySelectorAll(`button[onclick^="handleEditItemQuantity(${itemJoinId},"]`);
        editButtons.forEach(button => {
            button.setAttribute('onclick', `handleEditItemQuantity(${itemJoinId}, ${newQty}, '${safeItemName}', ${requisicaoId})`);
        });

    } else {
        alert('Falha ao atualizar a quantidade.');
    }
}

   async function handleDeleteItemFromRequisition(itemJoinId, requisicaoId) {
        if (confirm('Tem certeza que deseja remover este item da requisição?')) {
            showLoadingOverlay('Removendo item...');
            const result = await nocoFetch(`Requisicoes_Itens/${itemJoinId}`, { method: 'DELETE' });
            hideLoadingOverlay();

            if (result && result.success) {
                // --- INÍCIO DA ALTERAÇÃO ---

                // 1. Busca os dados mais recentes para garantir que a lista local esteja correta.
                await fetchRequisicoesItens();

                // 2. Fecha o modal de detalhes.
                hideModal(allElements.detailsModal);

                // 3. Atualiza a tabela principal de requisições.
                applyRequisicaoFilters();

                // --- FIM DA ALTERAÇÃO ---
            } else {
                alert('Falha ao remover o item.');
            }
        }
    }
    // --- Funções de UI, Eventos e Lógica Auxiliar ---
     function showImageModal(src) {
        const existingModal = document.getElementById('image-zoom-modal');
        if (existingModal) {
            document.body.removeChild(existingModal);
        }

        const overlay = document.createElement('div');
        overlay.id = 'image-zoom-modal';
        overlay.className = 'fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-80 cursor-pointer modal-bg-animate';
        
        const img = document.createElement('img');
        img.src = src;
        img.className = 'max-w-[90vw] max-h-[90vh] object-contain';
        
        overlay.appendChild(img);
        
        overlay.addEventListener('click', () => {
            document.body.removeChild(overlay);
        });
        
        document.body.appendChild(overlay);
    }

    function showLoadingOverlay(m) { let o = document.getElementById('loading-overlay'); if (!o) { o = document.createElement('div'); o.id = 'loading-overlay'; o.className = 'fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-60'; o.innerHTML = `<div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl flex items-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-brand-gold mr-3"></div><span class="text-gray-800 dark:text-white">${m}</span></div>`; document.body.appendChild(o); } o.querySelector('span').textContent = m; o.style.display = 'flex'; }
    function hideLoadingOverlay() { const o = document.getElementById('loading-overlay'); if (o) o.style.display = 'none'; }
    function updateAllCounters() { const curMonth = new Date().getMonth(); document.getElementById('birthday-count-badge').textContent = consultoresData.filter(c => c.DataNascimento && new Date(c.DataNascimento+'T00:00:00').getMonth()===curMonth).length; populateBirthdayCards(); document.getElementById('consultores-count-badge').textContent = consultoresData.length; document.getElementById('ferias-count-badge').textContent=feriasData.length; document.getElementById('atestados-count-badge').textContent=atestadosData.length; document.getElementById('epis-count-badge').textContent=episEntreguesData.length; document.getElementById('ativos-count-badge').textContent=ativosData.length; }
    function populateBirthdayCards() { const cont = document.getElementById('birthday-cards-container'); if (!cont) return; const curMonth = new Date().getMonth(); const bdayPpl = consultoresData.filter(c=>c.DataNascimento&&new Date(c.DataNascimento+'T00:00:00').getMonth()===curMonth); if(bdayPpl.length>0){ cont.innerHTML = bdayPpl.map(c=>{const cardHTML=createConsultorCard(c); const bDate=new Date(c.DataNascimento+'T00:00:00'); const dateStr=bDate.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'}); return cardHTML.replace('</p>',`</p><p class="text-brand-gold font-semibold mt-2">${dateStr}</p>`);}).join('');}else{cont.innerHTML=`<p class="col-span-full text-gray-500 dark:text-gray-400">Nenhum aniversariante este mês.</p>`;}}
    function populateSelectWithOptions(sel, data, valF, textF, addAll=true) { const selects=document.querySelectorAll(sel); let opts=addAll?'<option value="">Todos</option>':'<option value="">Selecione...</option>'; data.forEach(i=>{opts+=`<option value="${i[valF]}">${i[textF]}</option>`;}); selects.forEach(s=>{const curVal=s.value; s.innerHTML=opts; s.value=curVal;});}
    function populateConsultantSelects() { populateSelectWithOptions('.consultor-select', consultoresData, 'Id', 'Nome', false); }
    function populateClientSelects() { populateSelectWithOptions('.cliente-select', clientesData, 'Id', 'Nome', false); }
    
    function handleGlobalClick(e) { 
        const t = e.target; 
         const modalFilterBtn = t.closest('.item-modal-category-filter-btn');
    if (modalFilterBtn) {
        const category = modalFilterBtn.dataset.category;
        // Atualiza a classe 'ativa'
        document.querySelectorAll('.item-modal-category-filter-btn').forEach(b => b.classList.remove('filter-btn-active'));
        modalFilterBtn.classList.add('filter-btn-active');
        // Re-renderiza a grade de itens com a categoria selecionada
        renderModalCatalogoGrid(category);
        return; // Impede que o resto da função execute
    }
        if (t.closest('#incluir-item-btn')) {
            const selectedItemCard = document.querySelector('.item-catalogo-card.border-brand-gold');
            if (!selectedItemCard) {
                alert('Por favor, selecione um item do catálogo.');
                return;
            }
            const itemId = selectedItemCard.dataset.itemId;
            const item = allItems.find(i => i.Id == itemId);
            const quantidade = parseInt(document.getElementById('requisicao-item-qtd').value);

            if (item && quantidade > 0) {
                itemsParaAdicionar.push({ itemId: item.Id, itemName: item.Nome, quantidade: quantidade });
                renderItemsParaAdicionarList();
                // Limpa a seleção para o próximo item
                selectedItemCard.classList.remove('border-brand-gold', 'border-2');
                document.getElementById('requisicao-item-qtd').value = 1;
            }
            return;
        }

        if (t.closest('.remover-item-temp-btn')) {
            const indexToRemove = parseInt(t.closest('.remover-item-temp-btn').dataset.index);
            itemsParaAdicionar.splice(indexToRemove, 1);
            renderItemsParaAdicionarList();
            return;
        }

        if (t.closest('#salvar-conteudo-requisicao-btn')) {
            handleSaveRequisitionItems();
            return;
        }
        const clienteStatusBtn = t.closest('.cliente-status-filter-btn');
        if (clienteStatusBtn) {
            document.querySelectorAll('.cliente-status-filter-btn').forEach(b => b.classList.remove('filter-btn-active'));
            clienteStatusBtn.classList.add('filter-btn-active');
            applyClienteFilters();
            return;
        }

        if (t.closest('.add-content-btn')) {
            const reqId = t.closest('.add-content-btn').dataset.id;
            openRequisicaoItemModal(reqId);
            return;
        }

        const itemImage = t.closest('.item-card img, .req-form-img');
        const isActionButton = t.closest('.item-action-btn');

        if (itemImage && !isActionButton) {
            e.preventDefault();
            showImageModal(itemImage.src);
            return;
        }

        const kanbanButton = t.closest('.kanban-card .visit-actions button');
        if(kanbanButton) {
            const visitId = parseInt(kanbanButton.closest('.kanban-card').dataset.id);
            if(kanbanButton.classList.contains('iniciar-visita-btn')) { handleStartVisit(visitId); return; }
            if(kanbanButton.classList.contains('encerrar-visita-btn')) { handleEndVisit(visitId); return; }
            if(kanbanButton.classList.contains('remarcar-visita-btn')) { handleRescheduleVisit(visitId); return; }
        }

        const itemActionButton = t.closest('.item-action-btn');
        if (itemActionButton) {
            const card = itemActionButton.closest('.item-card');
            const itemId = parseInt(card.dataset.id);
            const itemCategory = card.dataset.category;
            const item = allItems.find(i => i.Id === itemId);

            if (itemActionButton.classList.contains('edit-item-btn')) {
                openItemModal(itemCategory, item);
            } else if (itemActionButton.classList.contains('delete-item-btn')) {
                activeDeleteItem = { id: itemId, type: 'item_catalogo', element: card };
                showModal(allElements.deleteConfirmModal);
            }
            return;
        }

        const nL=t.closest('.nav-link'); if(nL){e.preventDefault(); handleNavClick({currentTarget:nL}); return;} 
        const rhC=t.closest('.rh-card'); if(rhC&&!t.closest('a')){openDetailsModal(rhC); return;} 
        const clC=t.closest('.cliente-card'); if(clC&&!t.closest('a')){openDetailsModal(clC); return;} 
        const btn=t.closest('button'); if(!btn)return; 
        if(btn.classList.contains('view-toggle-btn')){handleViewToggle({currentTarget:btn});return;} 
        if(btn.classList.contains('dashboard-nav-btn')){handleDashboardNav(btn);return;}
        if(btn.classList.contains('cancel-sub-form')){ hideSubFormToggle(btn.dataset.history, btn.dataset.form); return; }
        if(btn.classList.contains('item-category-filter-btn')){ handleCategoryFilterClick(btn); return; }
        if (btn.classList.contains('add-item-btn')) { openItemModal(btn.dataset.category); return; }
        if(btn.classList.contains('change-status-btn')) { handleChangeRequisitionStatus(btn); return; }
async function handleSaveRequisitionItems() {
        const requisicaoId = document.getElementById('requisicao-item-form-modal').dataset.requisicaoId;
        if (!requisicaoId || itemsParaAdicionar.length === 0) {
            alert('Nenhum item para salvar.');
            hideModal(document.getElementById('requisicao-item-form-modal'));
            return;
        }

        showLoadingOverlay('Salvando itens...');

        const savePromises = itemsParaAdicionar.map(item => {
            const body = {
                "Requisicoes": { "Id": parseInt(requisicaoId) },
                "Itens_Catalogo": { "Id": parseInt(item.itemId) },
                "Quantidade": item.quantidade
            };
            return nocoFetch('Requisicoes_Itens', { method: 'POST', body: JSON.stringify(body) });
        });

        try {
            await Promise.all(savePromises);
            hideLoadingOverlay();
            hideModal(document.getElementById('requisicao-item-form-modal'));
            await fetchRequisicoes();
            applyRequisicaoFilters();
        } catch (error) {
            hideLoadingOverlay();
            alert('Ocorreu um erro ao salvar um ou mais itens. Por favor, tente novamente.');
            console.error('Erro ao salvar itens da requisição:', error);
        }
    }
        const aM={
            'logout-button':()=>showModal(allElements.logoutConfirmModal),'cancel-logout-btn':()=>hideModal(allElements.logoutConfirmModal),'confirm-logout-btn':()=>{sessionStorage.clear(); location.reload();},
            'sidebar-toggle':toggleMobileSidebar,'show-insights-btn':()=>{generateInsights(); showModal(allElements.insightsModal);},'close-insights-modal':()=>hideModal(allElements.insightsModal),
            'show-report-modal-btn': openReportModal,'close-report-modal':()=>hideModal(allElements.reportModal),
            'show-rh-form':()=>setupFormToggle('rh-cards-container','rh-form-container'),'cancel-rh-form':()=>hideFormToggle('rh-cards-container','rh-form-container'),
            'show-cliente-form':()=>setupFormToggle('cliente-cards-container','cliente-form-container'),'cancel-cliente-form':()=>hideFormToggle('cliente-cards-container','cliente-form-container'),
            'show-visita-form':()=>openVisitaModal(),
            'generate-agenda-btn': generateAgendaPdf,
            'cancel-visita-form':()=>hideModal(allElements.visitaFormModal),
            'show-requisicao-form': handleCreateNewRequisition,
            'cancel-requisicao-item-form': () => hideModal(allElements.requisicaoItemFormModal),
            'show-new-item-btn': () => openItemModal(),
            'show-receita-form':()=>setupSubFormToggle('receitas-history-container','receita-form-container'),'cancel-receita-form':()=>hideSubFormToggle('receitas-history-container','receita-form-container'),
            'show-custo-form':()=>setupSubFormToggle('custos-history-container','custo-form-container'),'cancel-custo-form':()=>hideSubFormToggle('custos-history-container','custo-form-container'),
            'show-ferias-form': () => setupSubFormToggle('ferias-history-container', 'ferias-form-container'),
            'show-atestados-form': () => setupSubFormToggle('atestados-history-container', 'atestados-form-container'),
            'show-epis-form': () => setupSubFormToggle('epis-history-container', 'epis-form-container'),
            'show-ativos-form': () => setupSubFormToggle('ativos-history-container', 'ativos-form-container'),
            'cancel-item-form':()=>hideModal(allElements.itemFormModal),'apply-filters-btn':applyFilters,'clear-filters-btn':clearFilters,
            'apply-req-filters-btn':applyRequisicaoFilters,'clear-req-filters-btn':clearRequisicaoFilters,
            'delete-btn':()=>{hideModal(allElements.detailsModal); showModal(allElements.deleteConfirmModal);},
            'cancel-delete-btn':()=>{hideModal(allElements.deleteConfirmModal); if(activeCard||activeTableRow)showModal(allElements.detailsModal); activeDeleteItem={id:null,type:null,element:null};},
            'edit-btn':handleCardEdit,'close-modal':()=>hideModal(allElements.detailsModal),
        }; 
        if(aM[btn.id]){aM[btn.id](); return;} 
        
        if (btn.classList.contains('table-details-btn')) openDetailsModalForRow(btn);
        else if(btn.classList.contains('table-edit-btn'))handleTableEdit(btn); 
        else if(btn.classList.contains('table-delete-btn'))handleTableDelete(btn); 
        else if(btn.classList.contains('rh-tab-btn')||btn.classList.contains('requisicao-tab-btn')||btn.classList.contains('financeiro-tab-btn'))handleTabClick(btn);
    }
    
    function navigateTo(targetId, isInitial = false) { allElements.pages.forEach(page => page.classList.add('hidden')); const targetPage = document.getElementById(targetId); if (targetPage) { targetPage.classList.remove('hidden'); if (targetId === 'visitas' && calendar) setTimeout(() => calendar.render(), 1); if (targetId === 'dashboard') setTimeout(() => updateAllDashboards(), 1); } const navLink = document.querySelector(`.nav-link[data-target="${targetId}"]`); if (navLink) { document.querySelectorAll('.nav-link').forEach(l => { l.classList.remove('bg-brand-gold', 'text-white'); l.classList.add('text-gray-400', 'hover:bg-brand-gold', 'hover:text-white'); }); navLink.classList.add('bg-brand-gold', 'text-white'); navLink.classList.remove('text-gray-400'); if (document.getElementById('page-title')) document.getElementById('page-title').textContent = navLink.title; } }
    function handleNavClick(e) {
    const navLink = e.currentTarget;
    const targetId = navLink.dataset.target;
    sessionStorage.setItem('currentPage', targetId); // <-- ADICIONE ESTA LINHA
    navigateTo(targetId);
    if (window.innerWidth < 1024) toggleMobileSidebar();
}
    function toggleMobileSidebar() { allElements.sidebar.classList.toggle('-translate-x-full'); allElements.sidebarOverlay.classList.toggle('hidden'); }
    function handleDashboardNav(btn) { document.querySelectorAll('.dashboard-nav-btn').forEach(b=>{b.classList.remove('border-brand-gold','text-brand-gold'); b.classList.add('border-transparent');}); btn.classList.add('border-brand-gold','text-brand-gold'); document.querySelectorAll('.dashboard-content').forEach(c=>c.classList.add('hidden')); document.getElementById(btn.dataset.target).classList.remove('hidden');}
function handleViewToggle(e) {
        const btn = e.currentTarget;
        const viewId = btn.dataset.view;
        const pageContainer = document.getElementById('visitas');

        // --- INÍCIO DA ALTERAÇÃO ---
        // Pega o contêiner pai da área de conteúdo principal
        const mainContentWrapper = document.querySelector('main.flex-1')?.parentElement;

        if (mainContentWrapper) {
            // Remove a classe de controle de overflow antes de qualquer ação
            mainContentWrapper.classList.remove('is-overflowing-view');
            // Adiciona a classe de controle apenas se a visualização for lista ou calendário
            if (viewId === 'list-view' || viewId === 'calendar-view') {
                mainContentWrapper.classList.add('is-overflowing-view');
            }
        }
        // --- FIM DA ALTERAÇÃO ---

        document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('bg-white', 'dark:bg-gray-800', 'shadow-sm'));
        btn.classList.add('bg-white', 'dark:bg-gray-800', 'shadow-sm');
        document.querySelectorAll('.visitas-view').forEach(v => v.classList.add('hidden'));
        
        const targetView = document.getElementById(viewId);
        if (targetView) {
            targetView.classList.remove('hidden');
            if (viewId === 'calendar-view' && calendar) {
                setTimeout(() => calendar.render(), 1);
            }
        }
    }
function handleTabClick(btn) {
        const tC = btn.closest('ul');
        tC.querySelectorAll('button').forEach(b => {
            b.classList.remove('border-brand-gold', 'text-brand-gold');
            b.classList.add('border-transparent');
        });
        btn.classList.add('border-brand-gold', 'text-brand-gold');
        const cC = btn.classList.contains('rh-tab-btn') ? '.rh-tab-content' : btn.classList.contains('requisicao-tab-btn') ? '.requisicao-tab-content' : '.financeiro-tab-content';
        const pC = btn.closest('.page');
        if (pC && cC) {
            pC.querySelectorAll(cC).forEach(c => c.classList.add('hidden'));
            document.getElementById(btn.dataset.target)?.classList.remove('hidden');
        }

        // --- INÍCIO DA ALTERAÇÃO 1: Salvar a sub-aba ativa ---
        if (pC) {
            const pageId = pC.id;
            const targetId = btn.dataset.target;
            // Salva a sub-aba ativa usando uma chave única para a página atual (ex: 'activeSubTab_rh')
            sessionStorage.setItem(`activeSubTab_${pageId}`, targetId);
        }
        // --- FIM DA ALTERAÇÃO 1 ---

        const newItemButton = document.getElementById('show-new-item-btn');
        if (newItemButton) {
            if (btn.dataset.target === 'itens-requisicao-content' && loggedInUser && loggedInUser.Role === 'Admin') {
                newItemButton.style.display = 'block';
            } else {
                newItemButton.style.display = 'none';
            }
        }
    }
    
  function generateAgendaPdf() {
        const startDate = document.getElementById('filter-start-date').value;
        const endDate = document.getElementById('filter-end-date').value;
        const consultorId = document.getElementById('filter-consultor').value;
        const clienteId = document.getElementById('filter-cliente').value;

        if (!startDate || !endDate) {
            alert('Por favor, selecione o período (De e Até) para gerar a agenda.');
            return;
        }

        const filteredVisits = visitsData.filter(v =>
            (v.DataVisita >= startDate) &&
            (v.DataVisita <= endDate) &&
            (!consultorId || v.Consultores?.Id == consultorId) &&
            (!clienteId || v.Clientes?.Id == clienteId)
        ).sort((a, b) => new Date(a.DataVisita + 'T' + a.HoraInicio) - new Date(b.DataVisita + 'T' + b.HoraInicio));

        if (filteredVisits.length === 0) {
            alert('Nenhuma visita encontrada para os filtros selecionados.');
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
const pageWidth = doc.internal.pageSize.getWidth();
        const logoWidth = 30; // Largura do logo em mm
        const logoHeight = 15; // Altura do logo em mm
        const pageMargin = 14;
        doc.addImage(logoBase64, 'PNG', pageWidth - logoWidth - pageMargin, 15, logoWidth, logoHeight);

        let finalY = 25;

        // Título Centralizado
        doc.setFontSize(24);
        doc.setFont('helvetica', 'bold');
        doc.text('Agenda de Visitas', doc.internal.pageSize.getWidth() / 2, finalY, { align: 'center' });
        finalY += 20;

        // Informações de Filtro
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text('Período:', 14, finalY);
        doc.setFont('helvetica', 'normal');
        doc.text(`${new Date(startDate+'T00:00:00').toLocaleDateString('pt-BR')} a ${new Date(endDate+'T00:00:00').toLocaleDateString('pt-BR')}`, 35, finalY);
        finalY += 7;

        const consultorName = consultorId ? consultoresData.find(c => c.Id == consultorId)?.Nome : 'Todos';
        doc.setFont('helvetica', 'bold');
        doc.text('Consultor:', 14, finalY);
        doc.setFont('helvetica', 'normal');
        doc.text(consultorName, 39, finalY);
        finalY += 7;

        const clienteName = clienteId ? clientesData.find(cl => cl.Id == clienteId)?.Nome : 'Todos';
        doc.setFont('helvetica', 'bold');
        doc.text('Cliente:', 14, finalY);
        doc.setFont('helvetica', 'normal');
        doc.text(clienteName, 34, finalY);
        finalY += 12;

        // Tabela de Visitas
        const tableHead = [['Horário', 'Atividades']];
        const tableBody = filteredVisits.map(visita => {
            // 2. Ajuste do formato de hora para HH:mm
            const horaInicio = visita.HoraInicio ? visita.HoraInicio.substring(0, 5) : 'N/A';
            const horaFim = visita.HoraFim ? visita.HoraFim.substring(0, 5) : 'N/A';
            
            const horarioText = `Data: ${new Date(visita.DataVisita+'T00:00:00').toLocaleDateString('pt-BR')}\nInício: ${horaInicio}\nFim: ${horaFim}`;
            
            const atividadesText = (visita.Atividades || 'Nenhuma atividade.')
                .split('\n')
                .map(line => `- ${line.trim()}`)
                .join('\n');

            return [horarioText, atividadesText];
        });

        doc.autoTable({
            startY: finalY,
            head: tableHead,
            body: tableBody,
            theme: 'striped',
            headStyles: {
                fillColor: [243, 244, 246], // Cor de fundo claro para o cabeçalho
                textColor: [55, 55, 55], // Texto escuro
                fontStyle: 'bold',
                halign: 'left',
                fontSize: 12,
                lineColor: [229, 231, 235],
                lineWidth: 0.2
            },
            columnStyles: {
                0: { cellWidth: 45, fontStyle: 'bold' }, 
                1: { cellWidth: 'auto' }
            },
            styles: {
                valign: 'top',
                lineColor: [229, 231, 235],
                lineWidth: 0.2
            },
            didDrawPage: function (data) {
                // Adiciona footer com número da página
                doc.setFontSize(9);
                doc.setTextColor(150);
                doc.text('Página ' + doc.internal.getCurrentPageInfo().pageNumber, data.settings.margin.left, doc.internal.pageSize.height - 10);
            }
        });

        // --- FIM DA ALTERAÇÃO ---

        doc.save(`Agenda_Lumi_${startDate}_a_${endDate}.pdf`);
    }

function handleTableEdit(btn) {
    const dataContainer = btn.closest('[data-id]');
    if (!dataContainer) return;
    const id = parseInt(dataContainer.dataset.id);
    const type = btn.dataset.type;
    switch (type) {
        case 'visita': { const v = visitsData.find(d => d.Id === id); if (v) openVisitaModal(v); break; }
        case 'receita': { const r = receitasData.find(d => d.Id === id); if (r) { setupSubFormToggle('receitas-history-container', 'receita-form-container'); const f = document.getElementById('receita-form'); f.dataset.id = r.Id; f.querySelector('#receita-cliente-form').value = r.Clientes?.Id; f.querySelector('#receita-vencimento').value = r.Vencimento; f.querySelector('#receita-valor').value = r.Valor; f.querySelector('#receita-status-form').value = r.Status; f.querySelector('#receita-obs').value = r.Observacao || ''; } break; }
        case 'custo': { const c = custosData.find(d => d.Id === id); if (c) { setupSubFormToggle('custos-history-container', 'custo-form-container'); const f = document.getElementById('custo-form'); f.dataset.id = c.Id; f.querySelector('#custo-credor').value = c.Credor; f.querySelector('#custo-vencimento').value = c.Vencimento; f.querySelector('#custo-valor').value = c.Valor; f.querySelector('#custo-status-form').value = c.Status; f.querySelector('#custo-obs').value = c.Observacao || ''; } break; }
        case 'ferias': { const data = feriasData.find(d => d.Id === id); if (data) { setupSubFormToggle('ferias-history-container', 'ferias-form-container'); const form = document.getElementById('ferias-form'); form.dataset.id = data.Id; form.querySelector('#ferias-consultor').value = data.Consultores?.Id; form.querySelector('#ferias-inicio').value = data.DataInicio; form.querySelector('#ferias-retorno').value = data.DataRetorno; } break; }
        case 'atestado': { const data = atestadosData.find(d => d.Id === id); if (data) { setupSubFormToggle('atestados-history-container', 'atestados-form-container'); const form = document.getElementById('atestados-form'); form.dataset.id = data.Id; form.querySelector('#atestados-consultor').value = data.Consultores?.Id; form.querySelector('#atestados-inicio').value = data.DataInicio; form.querySelector('#atestados-retorno').value = data.DataRetorno; } break; }
        case 'epi': { const data = episEntreguesData.find(d => d.Id === id); if (data) { setupSubFormToggle('epis-history-container', 'epis-form-container'); const form = document.getElementById('epis-form'); form.dataset.id = data.Id; form.querySelector('#epis-consultor').value = data.Consultores?.Id; form.querySelector('#epis-item').value = data.Item; form.querySelector('#epis-qtd').value = data.Quantidade; form.querySelector('#epis-data').value = data.DataEntrega; form.querySelector('#epis-obs').value = data.Observacao || ''; } break; }
        case 'ativo': { const data = ativosData.find(d => d.Id === id); if (data) { setupSubFormToggle('ativos-history-container', 'ativos-form-container'); const form = document.getElementById('ativos-form'); form.dataset.id = data.Id; form.querySelector('#ativos-consultor').value = data.Consultores?.Id; form.querySelector('#ativos-item').value = data.Item; form.querySelector('#ativos-entrega').value = data.DataEntrega; form.querySelector('#ativos-devolucao').value = data.DataDevolucao || ''; form.querySelector('#ativos-obs').value = data.Observacao || ''; } break; }
    }
}
    function handleCardEdit() { if (!activeCard) return; hideModal(allElements.detailsModal); const isConsultor = activeCard.classList.contains('rh-card'); const formContainerId = isConsultor ? 'rh-form-container' : 'cliente-form-container'; const cardsContainerId = isConsultor ? 'rh-cards-container' : 'cliente-cards-container'; const form = document.getElementById(formContainerId).querySelector('form'); const data = activeCard.dataset; form.reset(); let hiddenIdInput = form.querySelector('input[type="hidden"]'); if (!hiddenIdInput) { hiddenIdInput = document.createElement('input'); hiddenIdInput.type = 'hidden'; hiddenIdInput.id = isConsultor ? 'rh-id' : 'cliente-id'; form.prepend(hiddenIdInput); } hiddenIdInput.value = data.id;  const fieldMapping = isConsultor 
        ? {'rh-nome':'nome', 'rh-nasc':'datanascimento', 'rh-tel':'telefone', 'rh-email':'email', 'rh-login':'login', 'rh-inicio':'iniciovinculo', 'rh-fim':'fimvinculo', 'rh-cnpj':'cnpj', 'rh-razao':'razaosocial', 'rh-valor':'valorhora', 'rh-status':'status', 'rh-role':'role', 'rh-endereco':'endereco', 'rh-obs':'observacao'} 
        : {'cliente-nome':'nome', 'cliente-razao':'razaosocial', 'cliente-cnpj':'cnpj', 'cliente-tel':'telefone', 'cliente-email':'email', 'cliente-horas':'horascontratadas', 'cliente-status':'status', 'cliente-responsavel':'responsavel', 'cliente-cpf':'cpfresponsavel', 'cliente-iptu':'iptu', 'cliente-senha-portal':'senhaportal', 'cliente-endereco':'endereco', 'cliente-obs':'observacao'};  for (const [fieldId, dataKey] of Object.entries(fieldMapping)) { const input = form.querySelector(`#${fieldId}`); if (input) { if (dataKey === 'role' && !data[dataKey]) {
        input.value = 'Consultor'; } else { input.value = data[dataKey] || ''; } } } if (isConsultor) { const passwordInput = form.querySelector('#rh-senha'); if (passwordInput) { passwordInput.value = ''; passwordInput.placeholder = "Deixe em branco para não alterar"; } } const imgPreview = form.querySelector('img'); if (imgPreview) { let fotoData; try { fotoData = data.foto ? JSON.parse(data.foto) : null; } catch(e) { fotoData = null; } imgPreview.src = (fotoData && fotoData[0]?.signedPath) ? `${NocoDB_BaseURL}/${fotoData[0].signedPath}` : `https://placehold.co/100x100/e2e8f0/cbd5e0?text=${isConsultor ? 'Foto' : 'Logo'}`; } document.getElementById(cardsContainerId).classList.add('hidden'); document.getElementById(formContainerId).classList.remove('hidden'); }
    const setupSearch=(iId,cS)=>{document.getElementById(iId)?.addEventListener('input',e=>{const sT=e.target.value.toLowerCase(); document.querySelectorAll(cS).forEach(c=>{const n=c.dataset.nome||''; c.style.display=n.toLowerCase().includes(sT)?'flex':'none';});});};
    const setupFormToggle=(cId,fId)=>{activeCard=null; const f=document.getElementById(fId).querySelector('form'); f?.reset(); let hId=f.querySelector('input[type="hidden"]'); if(hId)hId.value=''; document.getElementById(cId)?.classList.add('hidden'); document.getElementById(fId)?.classList.remove('hidden');};
    const hideFormToggle=(cId,fId)=>{document.getElementById(fId).classList.add('hidden'); document.getElementById(cId).classList.remove('hidden');}
    const setupSubFormToggle=(hId,fId)=>{ const form = document.getElementById(fId).querySelector('form'); if(form) { form.reset(); delete form.dataset.id; } document.getElementById(hId)?.classList.add('hidden'); document.getElementById(fId)?.classList.remove('hidden');};
    const hideSubFormToggle=(hId,fId)=>{document.getElementById(fId).classList.add('hidden'); document.getElementById(hId).classList.remove('hidden');}
    const hideModal=(m)=>m?.classList.replace('flex','hidden');
    const showModal=(m)=>m?.classList.replace('hidden','flex');
    const openDetailsModal=(card)=>{activeCard=card; activeDeleteItem={id:card.dataset.id, type:card.classList.contains('rh-card')?'consultor':'cliente', element:card}; document.getElementById('details-modal-actions').style.display='flex'; const data=card.dataset; const fm={datanascimento:v=>v?new Date(v+'T00:00:00').toLocaleDateString('pt-BR'):'N/A', valorhora:v=>v?parseFloat(v).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}):'N/A', iniciovinculo:v=>v?new Date(v+'T00:00:00').toLocaleDateString('pt-BR'):'N/A', fimvinculo:v=>v?new Date(v+'T00:00:00').toLocaleDateString('pt-BR'):'N/A'}; document.getElementById('modal-title').textContent=data.nome; document.getElementById('modal-content').innerHTML=Object.keys(data).map(k=>{if(k==='id'||k.toLowerCase().includes('foto')||k.toLowerCase().includes('senha'))return''; const l=k.replace(/([A-Z])/g,' $1').replace(/^./,s=>s.toUpperCase()); const v=fm[k]?fm[k](data[k]):(data[k]||'N/A'); return`<p><strong>${l}:</strong> ${v}</p>`;}).join(''); showModal(allElements.detailsModal);};
    function applyClienteFilters() {
        const searchTerm = document.getElementById('cliente-search').value.toLowerCase();
        const statusFilterBtn = document.querySelector('#cliente-status-filters .filter-btn-active');
        const statusFilter = statusFilterBtn ? statusFilterBtn.dataset.status : 'Todos';

        const filteredData = clientesData.filter(cliente => {
            const nameMatch = cliente.Nome.toLowerCase().includes(searchTerm);
            const statusMatch = (statusFilter === 'Todos') || (cliente.Status === statusFilter);
            return nameMatch && statusMatch;
        });

        renderClientes(filteredData);
    }
function openDetailsModalForRow(btn) {
    // CORREÇÃO: Altera de .closest('tr') para .closest('[data-id]')
    // para funcionar tanto na tabela (tr) quanto nos cards (div).
    const dataContainer = btn.closest('[data-id]');
    if (!dataContainer) return;

    const id = parseInt(dataContainer.dataset.id);
    const type = btn.dataset.type;
    let dataArray, title;

    const actionsContainer = document.getElementById('details-modal-actions');

    // --- INÍCIO DA ALTERAÇÃO ---
    // Verifica o tipo de modal. Se for 'visita', esconde os botões de ação.
    // Para todos os outros tipos, garante que os botões estejam visíveis.
    const typesWithoutActions = ['visita', 'ferias', 'atestado', 'epi', 'ativo'];

if (typesWithoutActions.includes(type)) {
    actionsContainer.style.display = 'none'; // Esconde os botões se o tipo estiver na lista
} else {
    actionsContainer.style.display = 'flex'; // Mostra os botões para todos os outros tipos
}
    // --- FIM DA ALTERAÇÃO ---

    switch (type) {
        case 'visita': dataArray = visitsData; title = 'Detalhes da Visita'; break;
        case 'receita': dataArray = receitasData; title = 'Detalhes da Receita'; break;
        case 'custo': dataArray = custosData; title = 'Detalhes do Custo'; break;
        case 'ferias': dataArray = feriasData; title = 'Detalhes das Férias'; break;
        case 'atestado': dataArray = atestadosData; title = 'Detalhes do Atestado'; break;
        case 'epi': dataArray = episEntreguesData; title = 'Detalhes da Entrega de EPI'; break;
        case 'ativo': dataArray = ativosData; title = 'Detalhes do Ativo'; break;
        case 'requisicao': dataArray = requisicoesData; title = 'Detalhes da Requisição'; break;
        default: return;
    }
    const data = dataArray.find(d => d.Id === id);
    if (!data) return;
    
    activeTableRow = dataContainer; 
    activeDeleteItem = { id, type, element: dataContainer };

    document.getElementById('modal-title').textContent = title;

    let contentHTML = '';
    if (type === 'requisicao') {
        actionsContainer.style.display = 'none'; // Lógica específica para requisição (mantida)

        const itensFiltrados = requisicoesItensData.filter(item => item.Requisicoes_id === id);
        const showActions = loggedInUser.IsAdmin || data.Status === 'Pendente';

        const actionsHeader = showActions ? '<th scope="col" class="px-6 py-3 text-center">Ações</th>' : '';
        let tableRowsHTML = '';
        if (itensFiltrados.length > 0) {
            itensFiltrados.forEach(itemJoin => {
                const itemInfo = allItems.find(i => i.Id === itemJoin.Itens_Catalogo?.Id);
                const itemName = itemInfo ? itemInfo.Nome : 'Item não encontrado';
                const itemFotoUrl = itemInfo?.Foto?.[0]?.signedPath ? `${NocoDB_BaseURL}/${itemInfo.Foto[0].signedPath}` : 'https://placehold.co/80x80/e2e8f0/cbd5e0?text=Item';
                const safeItemName = itemName.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                
                const actionsCell = showActions ? `
                    <td class="px-6 py-4 text-center space-x-3">
                        <button onclick="handleEditItemQuantity(${itemJoin.Id}, ${itemJoin.Quantidade}, '${safeItemName}', ${id})" class="text-blue-500 hover:text-blue-700" title="Editar Quantidade"><i class="fas fa-edit"></i></button>
                        <button onclick="handleDeleteItemFromRequisition(${itemJoin.Id}, ${id})" class="text-red-500 hover:text-red-700" title="Apagar Item"><i class="fas fa-trash"></i></button>
                    </td>` : '';

                tableRowsHTML += `
                    <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                        <td class="p-2">
                            <img src="${itemFotoUrl}" alt="${itemName}" class="w-12 h-12 object-contain rounded cursor-pointer" onclick="showImageModal(this.src)">
                        </td>
                        <td class="px-6 py-4 font-medium text-gray-900 dark:text-white whitespace-nowrap">${itemName}</td>
                        <td class="px-6 py-4 text-center" id="item-qty-table-${itemJoin.Id}">${itemJoin.Quantidade}</td>
                        ${actionsCell}
                    </tr>`;
            });
        } else {
            const colspan = showActions ? 4 : 3;
            tableRowsHTML = `<tr><td colspan="${colspan}" class="px-6 py-4 text-center">Nenhum item adicionado.</td></tr>`;
        }

        const tableHTML = `
            <div class="mt-4 relative overflow-x-auto shadow-md sm:rounded-lg hidden md:block">
                <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                        <tr>
                            <th scope="col" class="px-4 py-3">Foto</th>
                            <th scope="col" class="px-6 py-3">Item</th>
                            <th scope="col" class="px-6 py-3 text-center">Qtd.</th>
                            ${actionsHeader}
                        </tr>
                    </thead>
                    <tbody>${tableRowsHTML}</tbody>
                </table>
            </div>`;
        
        let cardsHTML = '';
        if (itensFiltrados.length > 0) {
            itensFiltrados.forEach(itemJoin => {
                const itemInfo = allItems.find(i => i.Id === itemJoin.Itens_Catalogo?.Id);
                const itemName = itemInfo ? itemInfo.Nome : 'Item não encontrado';
                const itemFotoUrl = itemInfo?.Foto?.[0]?.signedPath ? `${NocoDB_BaseURL}/${itemInfo.Foto[0].signedPath}` : 'https://placehold.co/80x80/e2e8f0/cbd5e0?text=Item';
                const safeItemName = itemName.replace(/'/g, "\\'").replace(/"/g, "&quot;");

                const actionsButtons = showActions ? `
                    <div class="flex items-center space-x-4">
                        <button onclick="handleEditItemQuantity(${itemJoin.Id}, ${itemJoin.Quantidade}, '${safeItemName}', ${id})" class="text-blue-500 hover:text-blue-700 p-2" title="Editar Quantidade"><i class="fas fa-edit fa-lg"></i></button>
                        <button onclick="handleDeleteItemFromRequisition(${itemJoin.Id}, ${id})" class="text-red-500 hover:text-red-700 p-2" title="Apagar Item"><i class="fas fa-trash fa-lg"></i></button>
                    </div>` : '';

                cardsHTML += `
                    <div class="flex items-center p-2 bg-white dark:bg-gray-800 border-b dark:border-gray-700 last:border-b-0">
                        <img src="${itemFotoUrl}" alt="${itemName}" class="w-16 h-16 object-contain rounded cursor-pointer mr-4 flex-shrink-0" onclick="showImageModal(this.src)">
                        <div class="flex-grow">
                            <p class="font-semibold text-gray-900 dark:text-white">${itemName}</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400" id="item-qty-card-${itemJoin.Id}">Quantidade: ${itemJoin.Quantidade}</p>
                        </div>
                        ${actionsButtons}
                    </div>`;
            });
        } else {
            cardsHTML = `<p class="text-center text-gray-500 py-4">Nenhum item adicionado.</p>`;
        }

        const mobileCardsContainerHTML = `<div class="mt-4 border dark:border-gray-700 rounded-lg md:hidden">${cardsHTML}</div>`;

        contentHTML = `<p><strong>Data:</strong> ${new Date(data.DataRequisicao).toLocaleString('pt-BR')}</p>
                       <p><strong>Consultor:</strong> ${data.Consultores?.Nome || 'N/A'}</p>
                       <p><strong>Status:</strong> ${data.Status}</p>
                       ${tableHTML}
                       ${mobileCardsContainerHTML}`;
    } else {
        if (type === 'visita') {
            const { color, label } = sConf[data.Status] || { color: 'gray', label: data.Status };
            contentHTML = `<p><strong>Cliente:</strong> ${data.Clientes?.Nome || 'N/A'}</p> <p><strong>Consultor:</strong> ${data.Consultores?.Nome || 'N/A'}</p> <p><strong>Data:</strong> ${new Date(data.DataVisita + 'T00:00:00').toLocaleDateString('pt-BR')}</p> <p><strong>Horário:</strong> ${data.HoraInicio} - ${data.HoraFim}</p> <p><strong>Atividades:</strong> ${data.Atividades || 'N/A'}</p> <p><strong>Status:</strong> <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-${color}-200 text-${color}-800">${label}${data.Remarcada ? ' (Remarcado)' : ''}</span></p> ${data.CheckIn ? `<p><strong>Check-in:</strong> ${new Date(data.CheckIn).toLocaleString('pt-BR')}</p>` : ''} ${data.CheckOut ? `<p><strong>Check-out:</strong> ${new Date(data.CheckOut).toLocaleString('pt-BR')}</p>` : ''}`;
        } else if (type === 'receita' || type === 'custo') {
            contentHTML = type === 'receita' ? `<p><strong>Cliente:</strong> ${data.Clientes?.Nome || 'N/A'}</p>` : `<p><strong>Credor:</strong> ${data.Credor}</p>`;
            contentHTML += `<p><strong>Vencimento:</strong> ${new Date(data.Vencimento + 'T00:00:00').toLocaleDateString('pt-BR')}</p> <p><strong>Valor:</strong> ${(data.Valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p> <p><strong>Status:</strong> ${data.Status}</p> <p><strong>Observação:</strong> ${data.Observacao || 'N/A'}</p>`;
        } else {
            let ignoredKeys = ['Id', 'id', 'startTime', 'endTime', 'nc_created_by', 'nc_updated_by', 'nc_order'];
            contentHTML = Object.entries(data).map(([key, value]) => {
                if (ignoredKeys.includes(key) || typeof value === 'object' && value !== null && !Array.isArray(value)) return '';
                let label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                let displayValue = value || 'N/A';
                if (key.toLowerCase().includes('data')) { displayValue = value ? new Date(value + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'; }
                if (Array.isArray(value) && value[0]?.signedPath) { return `<p><strong>${label}:</strong> <a href="${NocoDB_BaseURL}/${value[0].signedPath}" target="_blank" class="text-brand-gold hover:underline">Ver Anexo</a></p>`;}
                return `<p><strong>${label}:</strong> ${displayValue}</p>`;
            }).join('');
            if (data.Consultores) { contentHTML = `<p><strong>Consultor:</strong> ${data.Consultores.Nome}</p>` + contentHTML; }
            if (data.Clientes) { contentHTML = `<p><strong>Cliente:</strong> ${data.Clientes.Nome}</p>` + contentHTML; }
        }
    }
    
    document.getElementById('modal-content').innerHTML = contentHTML;
    showModal(allElements.detailsModal);
}

    function updateAllDashboards(){
        updateFinanceDashboard(); // Mantém a chamada para a aba "Balanço"
        updateReceitasDashboard(); // Adiciona a chamada para a nova aba "Receitas"
        updateCustosDashboard(); // Adiciona a chamada para a nova aba "Custos"
        updateVisitsDashboard();
    }
    function setDateFilter(e, p) { const period=e.target.dataset.period; document.querySelectorAll(`.dash-${p}-quick-filter`).forEach(b=>b.classList.remove('filter-btn-active')); e.target.classList.add('filter-btn-active'); const endI=document.getElementById(`dash-${p}-end`), startI=document.getElementById(`dash-${p}-start`), today=new Date(); endI.valueAsDate=today; let sD=new Date(); if(period==='week')sD.setDate(today.getDate()-today.getDay()); else if(period==='month')sD=new Date(today.getFullYear(),today.getMonth(),1); else if(period==='year')sD=new Date(today.getFullYear(),0,1); startI.valueAsDate=sD; if(p==='fin')updateFinanceDashboard(); else updateVisitsDashboard();}
    function updateFinanceDashboard() { const s=document.getElementById('dash-fin-status').value, st=document.getElementById('dash-fin-start').value, e=document.getElementById('dash-fin-end').value; const fR=receitasData.filter(r=>(!s||r.Status===s)&&(!st||r.Vencimento>=st)&&(!e||r.Vencimento<=e)); const fC=custosData.filter(c=>(!s||c.Status===s)&&(!st||c.Vencimento>=st)&&(!e||c.Vencimento<=e)); const tR=fR.reduce((sum,r)=>sum+(r.Valor||0),0), tC=fC.reduce((sum,c)=>sum+(c.Valor||0),0), bal=tR-tC; const tRP=receitasData.filter(r=>r.Status==='Pendente'&&(!st||r.Vencimento>=st)&&(!e||r.Vencimento<=e)).reduce((sum,r)=>sum+(r.Valor||0),0); const tCP=custosData.filter(c=>c.Status==='Pendente'&&(!st||c.Vencimento>=st)&&(!e||c.Vencimento<=e)).reduce((sum,c)=>sum+(c.Valor||0),0); const f=v=>v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); document.getElementById('dash-revenue').textContent=f(tR); document.getElementById('dash-costs').textContent=f(tC); document.getElementById('dash-balance').textContent=f(bal); document.getElementById('dash-revenue-pending').textContent=f(tRP); document.getElementById('dash-costs-pending').textContent=f(tCP); document.getElementById('dash-balance').classList.toggle('text-green-500',bal>=0); document.getElementById('dash-balance').classList.toggle('text-red-500',bal<0); updateFinanceChart(fR,fC); }
        function updateTopClientsByCount(visits) {
        const comp = visits.filter(v => v.Status === 'Concluída');
        const stats = comp.reduce((acc, v) => {
            const clientName = v.Clientes?.Nome || 'N/A';
            acc[clientName] = (acc[clientName] || 0) + 1;
            return acc;
        }, {});

        const sortedClients = Object.entries(stats).sort((a, b) => b[1] - a[1]);

        // Renderiza o ranking
        const listContainer = document.getElementById('dash-top-clients-list');
        listContainer.innerHTML = sortedClients.map(([name, count]) =>
            `<li class="flex justify-between items-center text-sm">
                <span>${name}</span>
                <span class="font-bold text-brand-gold">${count} visita(s)</span>
            </li>`
        ).join('') || '<li>Nenhum dado para exibir.</li>';

        // Renderiza o gráfico
        const top5 = sortedClients.slice(0, 5);
        const labels = top5.map(item => item[0]);
        const data = top5.map(item => item[1]);

        const ctx = document.getElementById('clients-visits-chart').getContext('2d');
        const isDark = document.documentElement.classList.contains('dark');
        const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        const labelColor = isDark ? '#e5e7eb' : '#373737';

        if (clientsVisitsChart) {
            clientsVisitsChart.data.labels = labels;
            clientsVisitsChart.data.datasets[0].data = data;
            clientsVisitsChart.options.scales.x.ticks.color = labelColor;
            clientsVisitsChart.options.scales.y.ticks.color = labelColor;
            clientsVisitsChart.update();
        } else {
            clientsVisitsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Nº de Visitas',
                        data: data,
                        backgroundColor: '#BFA16A',
                        borderColor: '#a68a5a',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', // Gráfico de barras horizontais
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: labelColor, stepSize: 1 }, grid: { color: gridColor } },
                        y: { ticks: { color: labelColor }, grid: { display: false } }
                    }
                }
            });
        }
    }
    function updateTopClientsByHours(visits) {
        const comp = visits.filter(v => v.Status === 'Concluída');
        const stats = comp.reduce((acc, v) => {
            const clientName = v.Clientes?.Nome || 'N/A';
            // Em vez de contar, somamos a duração em minutos
            acc[clientName] = (acc[clientName] || 0) + calculateDuration(v);
            return acc;
        }, {});

        const sortedClients = Object.entries(stats).sort((a, b) => b[1] - a[1]); // Ordena por minutos
        const fM = m => `${Math.floor(m / 60)}h ${Math.round(m % 60)}m`;

        // Renderiza o novo ranking por horas
        const listContainer = document.getElementById('dash-top-clients-hours-list');
        listContainer.innerHTML = sortedClients.map(([name, minutes]) =>
            `<li class="flex justify-between items-center text-sm">
                <span>${name}</span>
                <span class="font-bold text-brand-gold">${fM(minutes)}</span>
            </li>`
        ).join('') || '<li>Nenhum dado para exibir.</li>';

        // Renderiza o novo gráfico de barras por horas
        const top5 = sortedClients.slice(0, 5);
        const labels = top5.map(item => item[0]);
        const data = top5.map(item => (item[1] / 60).toFixed(2)); // Converte minutos para horas com 2 casas decimais

        const ctx = document.getElementById('clients-hours-chart').getContext('2d');
        const isDark = document.documentElement.classList.contains('dark');
        const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        const labelColor = isDark ? '#e5e7eb' : '#373737';

        if (clientsHoursChart) {
            clientsHoursChart.data.labels = labels;
            clientsHoursChart.data.datasets[0].data = data;
            clientsHoursChart.update();
        } else {
            clientsHoursChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Horas',
                        data: data,
                        backgroundColor: '#a68a5a', // Um tom diferente de dourado para diferenciar
                        borderColor: '#8b6e4b',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { title: { display: true, text: 'Horas', color: labelColor }, ticks: { color: labelColor }, grid: { color: gridColor } },
                        y: { ticks: { color: labelColor }, grid: { display: false } }
                    }
                }
            });
        }
    }
    function updateVisitsDashboard() { 
    const st=document.getElementById('dash-visit-start').value, e=document.getElementById('dash-visit-end').value; 
    consultorId = document.getElementById('dash-visit-consultor')?.value, // Adicionado
    clienteId = document.getElementById('dash-visit-cliente')?.value;     // Adicionado
    const fV = visitsData.filter(v =>
            (!st || v.DataVisita >= st) &&
            (!e || v.DataVisita <= e) &&
            (!consultorId || v.Consultores?.Id == consultorId) && // Adicionado
            (!clienteId || v.Clientes?.Id == clienteId)         // Adicionado
        ); 
    const cM=vs=>vs.reduce((t,v)=>t+calculateDuration(v),0); 
    
    // --- INÍCIO DA ALTERAÇÃO ---
    // Adicionado Math.round() para arredondar os minutos
    const fM=m=>`${Math.floor(m/60)}h ${Math.round(m%60)}m`; 
    // --- FIM DA ALTERAÇÃO ---

    document.getElementById('dash-hours-completed').textContent=fM(cM(fV.filter(v=>v.Status==='Concluída'))); 
    document.getElementById('dash-hours-scheduled').textContent=fM(cM(fV.filter(v=>v.Status==='Agendada'))); 
    updateVisitsStatusChart(fV); 
    updateTopConsultants(fV); 
    updateTopClientsByCount(fV); // <-- Chamada para a função renomeada
        updateTopClientsByHours(fV); // <-- Chamada para a nova função
}
    function updateTopConsultants(visits) { 
    const comp=visits.filter(v=>v.Status==='Concluída'); 
    const stats=comp.reduce((acc,v)=>{
        const name = v.Consultores?.Nome || 'N/A'; 
        acc[name]=acc[name]||{count:0,minutes:0}; 
        acc[name].count++; 
        acc[name].minutes+=calculateDuration(v); 
        return acc;
    },{}); 
    const sH=Object.entries(stats).sort((a,b)=>b[1].minutes-a[1].minutes); 
    const sC=Object.entries(stats).sort((a,b)=>b[1].count-a[1].count); 
    
    // --- INÍCIO DA ALTERAÇÃO ---
    // Adicionado Math.round() para arredondar os minutos
    const fM=m=>`${Math.floor(m/60)}h ${Math.round(m%60)}m`; 
    // --- FIM DA ALTERAÇÃO ---

    const tHL=document.getElementById('dash-top-consultants-hours'); 
    tHL.innerHTML=sH.map(([n,s])=>`<li class="flex justify-between items-center"><span>${n}</span><span class="font-bold">${fM(s.minutes)}</span></li>`).join('')||`<li>Nenhum dado.</li>`; 
    const tCL=document.getElementById('dash-top-consultants-count'); 
    tCL.innerHTML=sC.map(([n,s])=>`<li class="flex justify-between items-center"><span>${n}</span><span class="font-bold">${s.count} visitas</span></li>`).join('')||`<li>Nenhum dado.</li>`; 
}
    function calculateDuration(v) { if(v.Status==='Concluída'&&v.CheckIn&&v.CheckOut)return(new Date(v.CheckOut)-new Date(v.CheckIn))/60000; if(v.HoraInicio&&v.HoraFim){const[sH,sM]=v.HoraInicio.split(':'),[eH,eM]=v.HoraFim.split(':'); return(new Date(0,0,0,eH,eM)-new Date(0,0,0,sH,sM))/60000;} return 0;}
    function updateFinanceChart(r,c) { const ctx=document.getElementById('finance-chart').getContext('2d'), iD=document.documentElement.classList.contains('dark'), gC=iD?'rgba(255,255,255,0.1)':'rgba(0,0,0,0.1)', lC=iD?'#e5e7eb':'#373737', dM={}; const p=(d,t)=>{d.forEach(i=>{const m=new Date(i.Vencimento+'T00:00:00').toLocaleString('pt-BR',{month:'short',year:'2-digit'}); dM[m]=dM[m]||{receitas:0,custos:0}; dM[m][t]+=(i.Valor||0);});}; p(r,'receitas'); p(c,'custos'); const sM=Object.keys(dM).sort((a,b)=>{const[m1,y1]=a.split('/'),[m2,y2]=b.split('/'); return new Date(`20${y1}`,'jan,fev,mar,abr,mai,jun,jul,ago,set,out,nov,dez'.split(',').indexOf(m1.toLowerCase()),1)-new Date(`20${y2}`,'jan,fev,mar,abr,mai,jun,jul,ago,set,out,nov,dez'.split(',').indexOf(m2.toLowerCase()),1);}); const cD={labels:sM, datasets:[{label:'Receitas',data:sM.map(m=>dM[m].receitas),backgroundColor:'rgba(59,130,246,0.7)'},{label:'Custos',data:sM.map(m=>dM[m].custos),backgroundColor:'rgba(239,68,68,0.7)'}]}; if(financeChart){Object.assign(financeChart.data,cD); Object.assign(financeChart.options.scales.x.ticks,{color:lC}); Object.assign(financeChart.options.scales.y.ticks,{color:lC}); Object.assign(financeChart.options.scales.x.grid,{color:gC}); Object.assign(financeChart.options.scales.y.grid,{color:gC}); Object.assign(financeChart.options.plugins.legend.labels,{color:lC}); financeChart.update();}else{financeChart=new Chart(ctx,{type:'bar',data:cD,options:{responsive:true,scales:{x:{ticks:{color:lC},grid:{color:gC}},y:{ticks:{color:lC},grid:{color:gC}}},plugins:{legend:{labels:{color:lC}}}}});}}
    function updateVisitsStatusChart(v) { const ctx=document.getElementById('visits-status-chart').getContext('2d'), iD=document.documentElement.classList.contains('dark'), lC=iD?'#e5e7eb':'#373737', sC=v.reduce((a,v)=>{a[v.Status]=(a[v.Status]||0)+1; return a;},{}); const cD={labels:Object.keys(sC), datasets:[{data:Object.values(sC), backgroundColor:Object.keys(sC).map(s=>({'Agendada':'#3B82F6','Concluída':'#10B981','Em Andamento':'#F59E0B'}[s]||'#6B7280'))}]}; if(visitsStatusChart){Object.assign(visitsStatusChart.data,cD); Object.assign(visitsStatusChart.options.plugins.legend.labels,{color:lC}); visitsStatusChart.update();}else{visitsStatusChart=new Chart(ctx,{type:'doughnut',data:cD,options:{responsive:true,plugins:{legend:{position:'top',labels:{color:lC}}}}});}}
    const sConf={'Agendada':{color:'blue',label:'Agendada'},'Em Andamento':{color:'yellow',label:'Em Andamento'},'Concluída':{color:'green',label:'Concluída'}};
function applyFilters() {
    const s = document.getElementById('filter-start-date').value,
        e = document.getElementById('filter-end-date').value,
        c = document.getElementById('filter-consultor').value,
        cl = document.getElementById('filter-cliente').value,
        st = document.getElementById('filter-status').value;

    let dataToDisplay = visitsData;

    // --- INÍCIO DA CORREÇÃO ---
    // A verificação agora é explícita para o Role 'Consultor'.
    // Admin e Gestor não entrarão neste 'if'.
    if (loggedInUser && loggedInUser.Role === 'Consultor') {
        dataToDisplay = visitsData.filter(v => v.Consultores?.Id == loggedInUser.Id);
    }
    // --- FIM DA CORREÇÃO ---

    // Aplica os filtros da tela sobre os dados já permitidos (dataToDisplay)
    const f = dataToDisplay.filter(v =>
        (!s || v.DataVisita >= s) &&
        (!e || v.DataVisita <= e) &&
        (!c || v.Consultores?.Id == c) &&
        (!cl || v.Clientes?.Id == cl) &&
        (!st || v.Status === st)
    );

    f.sort((a, b) => {
        const dateComparison = new Date(b.DataVisita) - new Date(a.DataVisita);
        if (dateComparison !== 0) {
            return dateComparison;
        }
        return a.HoraInicio.localeCompare(b.HoraInicio);
    });

    renderAllVisits(f);
}
    function clearFilters(){
    document.getElementById('filter-start-date').value = '';
    document.getElementById('filter-end-date').value = '';
    document.getElementById('filter-consultor').value = '';
    document.getElementById('filter-cliente').value = '';
    document.getElementById('filter-status').value = '';
    
    // --- INÍCIO DA ALTERAÇÃO ---
    // Em vez de renderizar todos os dados diretamente, chamamos applyFilters,
    // que agora contém a lógica de permissão e vai filtrar corretamente
    // com base no perfil do usuário, mesmo com os campos de filtro vazios.
    applyFilters();
    // --- FIM DA ALTERAÇÃO ---
}
    function renderAllVisits(d=visitsData){renderKanbanBoard(d.filter(v=>v.Status!=='Remarcada')); renderVisitsList(d); renderCalendarEvents(d);}
    function renderKanbanBoard(d){ 
    const c={'agendada':[],'em-andamento':[],'concluida':[]}; 
    d.forEach(v=>{ 
        const sK = v.Status.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(' ','-'); 
        if(c[sK]) { 
            c[sK].push(createKanbanCard(v)); 
        } 
    }); 

    // --- INÍCIO DA ALTERAÇÃO ---
    // Modificamos o HTML do contador para usar parênteses e herdar o tamanho da fonte do título.
    // Usamos 'font-semibold' e uma cor mais suave para diferenciar o número do texto.
    const createCounterBadge = (count) => `<span class="ml-2 font-semibold text-gray-500 dark:text-gray-400">(${count})</span>`;

    // A lógica para aplicar o contador nos títulos das colunas permanece a mesma.
    document.querySelector('.kanban-column[data-status="Agendada"] h3').innerHTML = `Agendada ${createCounterBadge(c.agendada.length)}`;
    document.querySelector('.kanban-column[data-status="Em Andamento"] h3').innerHTML = `Em Andamento ${createCounterBadge(c['em-andamento'].length)}`;
    document.querySelector('.kanban-column[data-status="Concluída"] h3').innerHTML = `Concluída ${createCounterBadge(c.concluida.length)}`;
    // --- FIM DA ALTERAÇÃO ---

    // O restante da função, que renderiza os cards, permanece inalterado.
    document.getElementById('kanban-agendada').innerHTML=c.agendada.join(''); 
    document.getElementById('kanban-em-andamento').innerHTML=c['em-andamento'].join(''); 
    document.getElementById('kanban-concluida').innerHTML=c.concluida.join(''); 
}
function createKanbanCard(v){
    const{color,label}=sConf[v.Status] || {color: 'gray', label: v.Status}; 
    const dF=new Date(v.DataVisita+'T00:00:00').toLocaleDateString('pt-BR'); 

    // --- INÍCIO DA ALTERAÇÃO 2: CRIA O ÍCONE SE A VISITA FOR REMARCADA ---
    // Em vez de texto, agora criamos um ícone com uma dica de ferramenta (tooltip)
    const rescheduledIconHTML = v.Remarcada ? `<span title="Visita Remarcada"><i class="fas fa-history text-purple-500 ml-2"></i></span>` : '';
    // --- FIM DA ALTERAÇÃO 2 ---
    
    let acts = '';
    // Condição: O usuário é Admin OU o ID do consultor da visita é o mesmo do usuário logado.
    const canStartOrEnd = loggedInUser && (loggedInUser.Role === 'Admin' || v.Consultores?.Id == loggedInUser.Id);

    if (v.Status === 'Agendada') {
        // Só mostra o botão 'Iniciar' se a condição for verdadeira.
        if (canStartOrEnd) {
            acts += `<button data-id="${v.Id}" class="iniciar-visita-btn w-full bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600">Iniciar</button>`;
        }
        
        // O botão 'Remarcar' continua visível para todos que podem ver o card.
        // Adiciona uma margem superior apenas se o botão 'Iniciar' também estiver visível.
        acts += `<button data-id="${v.Id}" class="remarcar-visita-btn w-full ${acts ? 'mt-2' : ''} bg-gray-500 text-white px-3 py-1 rounded-md text-sm hover:bg-gray-600">Remarcar</button>`;
        
    } else if (v.Status === 'Em Andamento') {
        // Só mostra o botão 'Encerrar' se a condição for verdadeira.
        if (canStartOrEnd) {
            acts = `<button data-id="${v.Id}" class="encerrar-visita-btn w-full bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600">Encerrar</button>`;
        }
    }
    let dur=''; 
    if(v.Status==='Concluída'&&v.CheckIn&&v.CheckOut){
        const diff=(new Date(v.CheckOut)-new Date(v.CheckIn))/60000; 
        dur=`<div class="text-xs text-center font-bold text-brand-gold mt-2 p-1 bg-yellow-100 dark:bg-yellow-900 rounded">Duração: ${Math.floor(diff/60)}h ${Math.round(diff%60)}min</div>`;
    }
    
    let locInfo = '';
    const createMapLink = (label, color, locString) => {
        if (typeof locString !== 'string' || locString.indexOf(',') === -1) return '';
        return `<div><i class="fas fa-map-marker-alt text-${color}-500 mr-1"></i><strong>${label} Local:</strong> <a href="https://www.google.com/maps?q=${locString}" target="_blank" class="text-brand-gold hover:underline">Ver no Mapa</a></div>`;
    };
    
    const formatTime = (isoString) => {
        if (!isoString) return null;
        return new Date(isoString).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    };

    if (v.Status === 'Em Andamento' && (v.CheckInLocal || v.CheckIn)) {
        const checkInTime = formatTime(v.CheckIn);
        const checkInLink = createMapLink('Check-in', 'green', v.CheckInLocal);
        if (checkInLink || checkInTime) {
            locInfo = '<div class="text-xs text-left mt-2 border-t dark:border-gray-600 pt-2 space-y-1">';
            if (checkInTime) locInfo += `<div><i class="far fa-clock text-green-500 mr-1"></i><strong>Início:</strong> ${checkInTime}</div>`;
            locInfo += checkInLink;
            locInfo += '</div>';
        }
    } else if (v.Status === 'Concluída' && (v.CheckInLocal || v.CheckOutLocal || v.CheckIn || v.CheckOut)) {
        const checkInTime = formatTime(v.CheckIn);
        const checkOutTime = formatTime(v.CheckOut);
        const checkInLink = createMapLink('Check-in', 'green', v.CheckInLocal);
        const checkOutLink = createMapLink('Check-out', 'red', v.CheckOutLocal);
        
        if (checkInLink || checkOutLink || checkInTime || checkOutTime) {
            locInfo = '<div class="text-xs text-left mt-2 border-t dark:border-gray-600 pt-2 space-y-1">';
            if (checkInTime) locInfo += `<div><i class="far fa-clock text-green-500 mr-1"></i><strong>Início:</strong> ${checkInTime}</div>`;
            locInfo += checkInLink;
            if (checkOutTime) locInfo += `<div><i class="far fa-clock text-red-500 mr-1"></i><strong>Final:</strong> ${checkOutTime}</div>`;
            locInfo += checkOutLink;
            locInfo += '</div>';
        }
    }

    // A variável 'rescheduledIconHTML' é inserida aqui no título.
    return`<div class="kanban-card bg-white dark:bg-gray-700 p-4 rounded-lg shadow" data-id="${v.Id}"><div class="flex justify-between items-start mb-2"><h4 class="font-bold text-gray-800 dark:text-white">${v.Clientes?.Nome || 'N/A'}${rescheduledIconHTML}</h4><span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-${color}-200 text-${color}-800">${label}</span></div><p class="text-sm text-gray-600 dark:text-gray-300">${v.Consultores?.Nome || 'N/A'}</p><p class="text-sm text-gray-600 dark:text-gray-300">${dF} - ${v.HoraInicio}</p>${locInfo}${dur}<div class="mt-4 border-t pt-2 dark:border-gray-600 visit-actions">${acts}</div></div>`;
}
    function renderVisitsList(d){const tB=document.getElementById('visitas-table-body'); tB.innerHTML=''; d.forEach(v=>{const{color,label}=sConf[v.Status] || {color: 'gray', label: v.Status}; const s=label+(v.Remarcada&&v.Status==='Agendada'?' (Remarcado)':''); const r=tB.insertRow(); r.className='bg-white border-b dark:bg-gray-800 dark:border-gray-700'; r.dataset.id=v.Id; r.innerHTML=`<td class="px-6 py-4">${v.Clientes?.Nome || 'N/A'}</td><td class="px-6 py-4">${v.Consultores?.Nome || 'N/A'}</td><td class="px-6 py-4">${new Date(v.DataVisita+'T00:00:00').toLocaleDateString('pt-BR')}</td><td class="px-6 py-4">${v.HoraInicio} - ${v.HoraFim}</td><td class="px-6 py-4"><span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-${color}-200 text-${color}-800">${s}</span></td><td class="px-6 py-4 space-x-2"><button class="table-details-btn text-gray-500" data-type="visita"><i class="fas fa-eye"></i></button><button class="table-edit-btn text-blue-500" data-type="visita"><i class="fas fa-edit"></i></button><button class="table-delete-btn text-red-500" data-type="visita"><i class="fas fa-trash"></i></button></td>`;});}
    function renderCalendarEvents(d){if(!calendar)return; calendar.removeAllEvents(); calendar.addEventSource(d.map(v=>({id:v.Id, title:`${v.Clientes?.Nome || 'Cliente'} (${v.Consultores?.Nome || 'Consultor'})`, start:`${v.DataVisita}T${v.HoraInicio}`, end:`${v.DataVisita}T${v.HoraFim}`, color:(sConf[v.Status] || {color:'gray'}).color})));}
    async function handleStartVisit(vId){
        showLoadingOverlay('Iniciando e obtendo localização...');
        try {
            const location = await getCurrentLocation();
            const body = {
                Status: 'Em Andamento',
                CheckIn: new Date().toISOString(),
                CheckInLocal: `${location.lat},${location.lng}`
            };
            const result = await nocoFetch(`Visitas/${vId}`, { method: 'PATCH', body: JSON.stringify(body) });
            
            if (result) {
                await fetchVisitas();
                applyFilters();
            }
        } catch (error) {
            alert(`Erro ao iniciar visita: ${error.message}`);
        } finally {
            hideLoadingOverlay();
        }
    }
    async function handleEndVisit(vId){
        showLoadingOverlay('Encerrando e obtendo localização...');
        try {
            const location = await getCurrentLocation();
            const body = {
                Status: 'Concluída',
                CheckOut: new Date().toISOString(),
                CheckOutLocal: `${location.lat},${location.lng}`
            };
            const result = await nocoFetch(`Visitas/${vId}`, { method: 'PATCH', body: JSON.stringify(body) });

            if (result) {
                await fetchVisitas();
                applyFilters();
                updateAllDashboards();
            }
        } catch (error) {
            alert(`Erro ao encerrar visita: ${error.message}`);
        } finally {
            hideLoadingOverlay();
        }
    }
   
    function handleRescheduleVisit(vId){const v=visitsData.find(d=>d.Id==vId); if(v){document.getElementById('is-rescheduling').value='true'; openVisitaModal(v);}}
    function openVisitaModal(v=null){ const activeConsultores = consultoresData.filter(c => c.Status === 'Ativo');
        const activeClientes = clientesData.filter(c => c.Status === 'Ativo');

        populateSelectWithOptions('#visita-consultor', activeConsultores, 'Id', 'Nome', false);
        populateSelectWithOptions('#visita-cliente', activeClientes, 'Id', 'Nome', false); const f=allElements.visitaForm; f.reset(); document.getElementById('is-rescheduling').value='false'; if(v){document.getElementById('visita-modal-title').textContent="Editar Visita"; f.querySelector('#visita-id').value=v.Id; f.querySelector('#visita-consultor').value=v.Consultores?.Id; f.querySelector('#visita-cliente').value=v.Clientes?.Id; f.querySelector('#visita-data').value=v.DataVisita; f.querySelector('#visita-inicio').value=v.HoraInicio; f.querySelector('#visita-fim').value=v.HoraFim; f.querySelector('#visita-atividades').value=v.Atividades;}else{document.getElementById('visita-modal-title').textContent="Agendar Nova Visita"; f.querySelector('#visita-id').value=''; f.querySelector('#visita-consultor').value=loggedInUser.Id;} showModal(allElements.visitaFormModal);}
    
    function initializeCalendar(){if(document.getElementById('calendar')&&typeof FullCalendar!=='undefined'){calendar=new FullCalendar.Calendar(document.getElementById('calendar'),{initialView:'dayGridMonth',locale:'pt-br',buttonText:{today:'Hoje',month:'Mês',week:'Semana',list:'Lista'},headerToolbar:{left:'prev,next today',center:'title',right:'dayGridMonth,timeGridWeek,listWeek'},});}}
    
    // --- Funções da Tela de Requisição ---
    async function handleCreateNewRequisition() {
        if (!loggedInUser) {
            alert('Erro: Nenhum usuário logado.');
            return;
        }
        showLoadingOverlay('Criando nova requisição...');
        const body = {
            "Consultores": { "Id": loggedInUser.Id },
            "Status": "Pendente",
            "DataRequisicao": new Date().toISOString()
        };
        const result = await nocoFetch('Requisicoes', { method: 'POST', body: JSON.stringify(body) });
        if (result) {
            await fetchRequisicoes();
            applyRequisicaoFilters();
        }
        hideLoadingOverlay();
    }

      function populateRequisitionItemSelect(category = 'Todos') {
        let itemsToPopulate = allItems; 
        if (category !== 'Todos') {
            itemsToPopulate = itemsToPopulate.filter(i => i.Categoria === category);
        }
        populateSelectWithOptions('#requisicao-item-catalogo', itemsToPopulate, 'Id', 'Nome', false);
    }
function renderItemsParaAdicionarList() {
        const listContainer = document.getElementById('itens-para-adicionar-list');
        if (!listContainer) return;

        if (itemsParaAdicionar.length === 0) {
            listContainer.innerHTML = '<li class="text-sm text-gray-500 text-center">Nenhum item incluído.</li>';
            return;
        }

        listContainer.innerHTML = itemsParaAdicionar.map((item, index) => `
            <li class="flex justify-between items-center p-2 bg-white dark:bg-gray-800 rounded-md">
                <span class="text-sm">${item.itemName}</span>
                <span class="text-sm font-bold">Qtd: ${item.quantidade}</span>
                <button type="button" class="remover-item-temp-btn text-red-500 hover:text-red-700" data-index="${index}" title="Remover">
                    <i class="fas fa-times-circle"></i>
                </button>
            </li>
        `).join('');
    }
function openRequisicaoItemModal(requisicaoId) {
    itemsParaAdicionar = []; // Limpa a lista temporária
    document.getElementById('requisicao-item-form-modal').dataset.requisicaoId = requisicaoId;

    // Popula os botões de filtro do modal
    const filterContainer = document.getElementById('modal-item-category-filters');
    const categories = [...new Set(allItems.map(item => item.Categoria))].sort();
    filterContainer.innerHTML = '<button class="item-modal-category-filter-btn filter-btn-active flex-shrink-0 px-3 py-1 rounded-md shadow-sm" data-category="Todos">Todas</button>';
    categories.forEach(cat => {
        if(cat) { // Garante que categorias nulas não criem botões
            filterContainer.innerHTML += `<button class="item-modal-category-filter-btn flex-shrink-0 px-3 py-1 rounded-md" data-category="${cat}">${cat}</button>`;
        }
    });
    
    // Renderiza a grade de itens (inicialmente com "Todos")
    renderModalCatalogoGrid('Todos'); 
    
    renderItemsParaAdicionarList(); // Renderiza a lista (vazia) de itens a adicionar
    showModal(document.getElementById('requisicao-item-form-modal'));
}

    async function handleChangeRequisitionStatus(btn) {
        const id = btn.dataset.id;
        const currentStatus = btn.dataset.status;
        const newStatus = currentStatus === 'Pendente' ? 'Entregue' : 'Pendente';
        
        if (confirm(`Deseja realmente alterar o status desta requisição para "${newStatus}"?`)) {
            showLoadingOverlay('Alterando status...');
            const result = await nocoFetch(`Requisicoes/${id}`, {
                method: 'PATCH',
                body: JSON.stringify({ Status: newStatus })
            });
            hideLoadingOverlay();
            if (result) {
                await fetchRequisicoes();
                applyRequisicaoFilters();
            } else {
                alert('Não foi possível alterar o status.');
            }
        }
    }

function renderRequisicoes(data = requisicoesData) {
    const tbody = document.getElementById('requisicoes-table-body');
    const cardsContainer = document.getElementById('requisicoes-cards-container');

    if (!tbody || !cardsContainer) return;

    tbody.innerHTML = '';
    cardsContainer.innerHTML = '';

    data.forEach(r => {
        const addContentBtnHTML = r.Status === 'Pendente' ? `<button class="add-content-btn text-green-500 hover:text-green-700" data-id="${r.Id}" title="Adicionar Itens"><i class="fas fa-plus-circle"></i></button>` : '';
        const changeStatusBtnHTML = (loggedInUser && (loggedInUser.Role === 'Admin' || loggedInUser.Role === 'Gestor')) ? `<button class="change-status-btn text-orange-500 hover:text-orange-700" data-id="${r.Id}" data-status="${r.Status}" title="Mudar Status"><i class="fas fa-toggle-on"></i></button>` : '';
        const deleteRequisitionBtnHTML = ((loggedInUser && (loggedInUser.Role === 'Admin' || loggedInUser.Role === 'Gestor')) || r.Status === 'Pendente') ? `<button class="table-delete-btn text-red-500" data-type="requisicao" title="Apagar Requisição"><i class="fas fa-trash"></i></button>` : '';
        const actionsHTML = `
            ${addContentBtnHTML}
            <button class="table-details-btn text-gray-500" data-type="requisicao" title="Ver Detalhes"><i class="fas fa-eye"></i></button>
            ${changeStatusBtnHTML}
            ${deleteRequisitionBtnHTML}
        `;

        // 1. Popula a tabela (desktop)
        const tableRowHTML = `
            <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700" data-id="${r.Id}">
                <td class="px-6 py-4">${r.Consultores?.Nome || 'N/A'}</td>
                <td class="px-6 py-4">${new Date(r.DataRequisicao).toLocaleString('pt-BR')}</td>
                <td class="px-6 py-4"><span class="text-xs font-semibold px-2 py-0.5 rounded-full ${r.Status === 'Entregue' ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800'}">${r.Status}</span></td>
                <td class="px-6 py-4 space-x-2">${actionsHTML}</td>
            </tr>`;
        tbody.insertAdjacentHTML('beforeend', tableRowHTML);

        // 2. Popula os cards (mobile)
        const cardHTML = `
            <div class="p-4 bg-white rounded-lg shadow dark:bg-gray-800 border dark:border-gray-700" data-id="${r.Id}">
                <div class="flex justify-between items-center mb-2">
                    <p class="text-lg font-semibold text-gray-900 dark:text-white">${r.Consultores?.Nome || 'N/A'}</p>
                    <span class="px-2 py-1 text-xs font-medium rounded-full ${r.Status === 'Entregue' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' : 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300'}">
                        ${r.Status}
                    </span>
                </div>
                <div class="mb-3 text-sm text-gray-600 dark:text-gray-400">
                    <strong>Data:</strong> ${new Date(r.DataRequisicao).toLocaleString('pt-BR')}
                </div>
                <div class="flex justify-end pt-2 border-t dark:border-gray-600 space-x-2">
                    ${actionsHTML}
                </div>
            </div>
        `;
        cardsContainer.insertAdjacentHTML('beforeend', cardHTML);
    });
}
function renderItensDeRequisicao(filterCategory = 'Todos') {
        const container = document.getElementById('item-management-container');
        if(!container) return;
        container.innerHTML = '';
        const categoriesToRender = (filterCategory === 'Todos') ? Object.keys(itemData.consumo).sort() : [filterCategory];

        categoriesToRender.forEach(category => {
            if (!itemData.consumo[category] && category !== 'Todos') return;

            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'p-4 bg-white dark:bg-gray-800 rounded-lg shadow-md';
            categoryDiv.dataset.category = category;

            const header = document.createElement('div');
            header.className = 'flex justify-between items-center mb-4';
            
            // --- INÍCIO DA ALTERAÇÃO 1: Botão "Adicionar Item" condicional ---
            const addItemButtonHTML = (loggedInUser && loggedInUser.Role === 'Admin') ?  `<button class="add-item-btn bg-brand-gold text-white px-3 py-1 rounded-md text-sm hover:bg-brand-gold-dark" data-category="${category}">Adicionar Item</button>`
                : ''; // Se não for admin, o botão não é criado.

            header.innerHTML = `<h3 class="text-xl font-bold text-gray-800 dark:text-white">${category}</h3>${addItemButtonHTML}`;
            // --- FIM DA ALTERAÇÃO 1 ---

            categoryDiv.appendChild(header);

            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4';
            
            // --- INÍCIO DA ALTERAÇÃO 2: Botões de ação dos cards condicionais ---
            const itemActionsHTML = (loggedInUser && loggedInUser.Role === 'Admin') ? `<div class="mt-2 flex justify-center space-x-2">
                        <button class="item-action-btn edit-item-btn text-blue-500 hover:text-blue-700" title="Editar"><i class="fas fa-edit"></i></button>
                        <button class="item-action-btn delete-item-btn text-red-500 hover:text-red-700" title="Apagar"><i class="fas fa-trash"></i></button>
                    </div>`
                : ''; // Se não for admin, os botões não são criados.
            // --- FIM DA ALTERAÇÃO 2 ---
            
            const items = itemData.consumo[category] || [];
            if (items.length > 0) {
                grid.innerHTML = items.map(item => `
                    <div class="item-card border dark:border-gray-700 rounded-lg p-2 text-center flex flex-col justify-between" data-id="${item.id}" data-category="${item.categoria}">
                        <img src="${item.foto || 'https://placehold.co/100x100/e2e8f0/cbd5e0?text=Item'}" alt="${item.nome}" class="w-full h-24 object-contain mb-2 rounded cursor-pointer">
                        <div class="flex-grow flex flex-col justify-center">
                            <p class="text-sm font-semibold text-gray-800 dark:text-white">${item.nome}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${item.categoria}</p>
                        </div>
                        ${itemActionsHTML}
                    </div>
                `).join('');
            } else {
                grid.innerHTML = '<p class="text-gray-500 col-span-full">Nenhum item nesta categoria.</p>';
            }
            categoryDiv.appendChild(grid);
            container.appendChild(categoryDiv);
        });
    }

    function renderCategoryFilters(){
        const container = document.getElementById('item-category-filters');
        if(!container) return;
        const categories = Object.keys(itemData.consumo).sort();
        container.innerHTML = '<button class="item-category-filter-btn filter-btn-active px-3 py-1 rounded-md shadow-sm" data-category="Todos">Todas</button>';
        categories.forEach(cat => {
            container.innerHTML += `<button class="item-category-filter-btn px-3 py-1 rounded-md" data-category="${cat}">${cat}</button>`;
        });
    }

    function handleCategoryFilterClick(btn) {
        document.querySelectorAll('.item-category-filter-btn').forEach(b => b.classList.remove('filter-btn-active'));
        btn.classList.add('filter-btn-active');
        renderItensDeRequisicao(btn.dataset.category);
    }
    
    function handleAddNewCategory() {
       openItemModal();
    }
    
    function openItemModal(category = '', item = null) {
        const form = allElements.itemForm;
        form.reset();
        const modalTitle = document.getElementById('item-modal-title');
        const preview = document.getElementById('item-foto-preview');

        let categoryInput = form.querySelector('#item-category-input');
        if (!categoryInput) {
            const nameFieldDiv = form.querySelector('#item-name').parentElement;
            const categoryFieldHTML = `
                <div class="mt-4">
                    <label for="item-category-input" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Categoria</label>
                    <select id="item-category-input" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600" required>
                        <option value="Placas">Placas</option>
                        <option value="Planilhas">Planilhas</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
            `;
            nameFieldDiv.insertAdjacentHTML('afterend', categoryFieldHTML);
            categoryInput = form.querySelector('#item-category-input');
        }

        preview.classList.add('hidden');
        preview.src = '';
        
        if (item) {
            modalTitle.textContent = 'Editar Item';
            form.dataset.id = item.id || item.Id;
            form.querySelector('#item-name').value = item.Nome || item.nome;
            categoryInput.value = category; 
            const currentItem = allItems.find(i => i.Id === (item.id || item.Id));
            const photoUrl = currentItem?.Foto?.[0]?.signedPath ? `${NocoDB_BaseURL}/${currentItem.Foto[0].signedPath}` : item.foto;
            if (photoUrl) {
                preview.src = photoUrl;
                preview.classList.remove('hidden');
            }
        } else {
            modalTitle.textContent = 'Novo Item';
            delete form.dataset.id;
            categoryInput.value = category || 'Placas'; 
        }
        showModal(allElements.itemFormModal);
    }

function applyRequisicaoFilters(){ 
    const sD=document.getElementById('filter-req-start-date').value;
    const eD=document.getElementById('filter-req-end-date').value;
    const cId=document.getElementById('filter-req-consultor').value;
    const status=document.getElementById('filter-req-status').value;
    const item=document.getElementById('filter-req-item').value.toLowerCase(); 
    
    // --- INÍCIO DA ALTERAÇÃO ---
    let baseData = requisicoesData;

    // Se o usuário logado NÃO for um admin, pré-filtramos os dados para mostrar apenas os seus.
    if (loggedInUser && !loggedInUser.IsAdmin) {
        baseData = requisicoesData.filter(r => r.Consultores?.Id == loggedInUser.Id);
    }
    // --- FIM DA ALTERAÇÃO ---

    // O restante da filtragem agora opera sobre o conjunto de dados já permitido ('baseData')
    let filtered = baseData.filter(r => 
        (!sD || r.DataRequisicao >= sD) && 
        (!eD || r.DataRequisicao <= eD) && 
        (!cId || r.Consultores?.Id == cId) && 
        (!status || r.Status === status)
    ); 
    
    if(item){
        filtered = filtered.filter(r => {
            return r.ItensDaRequisicao && r.ItensDaRequisicao.some(it => {
                const itemInfo = allItems.find(i => i.Id === it['Itens_Catalogo-id']); 
                return itemInfo && itemInfo.Nome.toLowerCase().includes(item);
            });
        });
    } 
    filtered.sort((a, b) => new Date(b.DataRequisicao) - new Date(a.DataRequisicao));
    renderRequisicoes(filtered); 
}

    function clearRequisicaoFilters(){ 
        document.getElementById('requisicoes-filters').querySelectorAll('input, select').forEach(el => {
             el.value = '';
        }); 
        applyRequisicaoFilters(); 
    }
    
    function applyAndRenderFerias(){ const nome = document.getElementById('ferias-filter-name').value.toLowerCase(); const inicio = document.getElementById('ferias-filter-start').value; const fim = document.getElementById('ferias-filter-end').value; const filtered = feriasData.filter(f => (!nome || (f.Consultores?.Nome || '').toLowerCase().includes(nome)) && (!inicio || f.DataInicio >= inicio) && (!fim || f.DataRetorno <= fim) ); renderFerias(filtered); }
    function applyAndRenderAtestados(){ const nome = document.getElementById('atestados-filter-name').value.toLowerCase(); const inicio = document.getElementById('atestados-filter-start').value; const fim = document.getElementById('atestados-filter-end').value; const filtered = atestadosData.filter(a => (!nome || (a.Consultores?.Nome || '').toLowerCase().includes(nome)) && (!inicio || a.DataInicio >= inicio) && (!fim || a.DataRetorno <= fim) ); renderAtestados(filtered); }
    function applyAndRenderEpis(){ const nome = document.getElementById('epis-filter-name').value.toLowerCase(); const inicio = document.getElementById('epis-filter-start').value; const fim = document.getElementById('epis-filter-end').value; const filtered = episEntreguesData.filter(e => (!nome || (e.Consultores?.Nome || '').toLowerCase().includes(nome)) && (!inicio || e.DataEntrega >= inicio) && (!fim || e.DataEntrega <= fim) ); renderEpis(filtered); }
    function applyAndRenderAtivos(){ const nome = document.getElementById('ativos-filter-name').value.toLowerCase(); const inicio = document.getElementById('ativos-filter-start').value; const fim = document.getElementById('ativos-filter-end').value; const filtered = ativosData.filter(a => (!nome || (a.Consultores?.Nome || '').toLowerCase().includes(nome)) && (!inicio || a.DataEntrega >= inicio) && (!fim || a.DataEntrega <= fim) ); renderAtivos(filtered); }
    function applyAndRenderReceitas(){const s=document.getElementById('filter-receita-start-date').value,e=document.getElementById('filter-receita-end-date').value,c=document.getElementById('filter-receita-cliente').value,st=document.getElementById('filter-receita-status').value; const f=receitasData.filter(r=>(!s||r.Vencimento>=s)&&(!e||r.Vencimento<=e)&&(!c||r.Clientes?.Id==c)&&(!st||r.Status===st)); renderReceitas(f);}
    function applyAndRenderCustos(){const s=document.getElementById('filter-custo-start-date').value,e=document.getElementById('filter-custo-end-date').value,cr=document.getElementById('filter-custo-credor').value.toLowerCase(),st=document.getElementById('filter-custo-status').value; const f=custosData.filter(c=>(!s||c.Vencimento>=s)&&(!e||c.Vencimento<=e)&&(!cr||c.Credor.toLowerCase().includes(cr))&&(!st||c.Status===st)); renderCustos(f);}
    
function generateInsights() {
        const f = v => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const insightsContent = document.getElementById('insights-content');
        let insightsHTML = '';

        // --- INÍCIO DA ALTERAÇÃO ---
        // Apenas Admin pode ver insights financeiros.
        if (loggedInUser && loggedInUser.Role === 'Admin') {
            const totalReceitas = receitasData.reduce((sum, r) => sum + (r.Valor || 0), 0);
            const totalCustos = custosData.reduce((sum, c) => sum + (c.Valor || 0), 0);
            const balanco = totalReceitas - totalCustos;
            insightsHTML += `<p class="p-2 rounded-lg ${balanco >= 0 ? 'bg-green-100 dark:bg-green-900' : 'bg-red-100 dark:bg-red-900'}"><strong>Balanço Financeiro Geral:</strong> <span class="font-bold ${balanco >= 0 ? 'text-green-600 dark:text-green-300' : 'text-red-600 dark:text-red-300'}">${f(balanco)}</span>.</p>`;
            
            const receitasPendentes = receitasData.filter(r => r.Status === 'Pendente').reduce((sum, r) => sum + r.Valor, 0);
            if (receitasPendentes > 0) {
                insightsHTML += `<p class="p-2 rounded-lg bg-yellow-100 dark:bg-yellow-900"><strong>Atenção:</strong> Existem <strong>${f(receitasPendentes)}</strong> em receitas pendentes.</p>`;
            }
        }
        // --- FIM DA ALTERAÇÃO ---

        // Insights de visitas são visíveis para Admin e Gestor
        const visitasConcluidas = visitsData.filter(v => v.Status === 'Concluída');
        if (visitasConcluidas.length > 0) {
            const stats = visitasConcluidas.reduce((acc, v) => {
                const name = v.Consultores?.Nome || 'N/A';
                acc[name] = (acc[name] || 0) + calculateDuration(v);
                return acc;
            }, {});
            const [topConsultor, topHoras] = Object.entries(stats).sort((a, b) => b[1] - a[1])[0] || [null, 0];
            if (topConsultor) {
                insightsHTML += `<p class="p-2 rounded-lg bg-blue-100 dark:bg-blue-900"><strong>Destaque de Produtividade:</strong> O consultor <strong>${topConsultor}</strong> foi o que mais registrou horas (${Math.floor(topHoras/60)}h ${Math.round(topHoras%60)}m).</p>`;
            }
        } else {
            insightsHTML += `<p class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700">Nenhuma visita concluída para análise de produtividade.</p>`;
        }
        
        const totalVisitasAgendadas = visitsData.filter(v => v.Status === 'Agendada').length;
        if (totalVisitasAgendadas > 0) {
            insightsHTML += `<p class="p-2 rounded-lg bg-indigo-100 dark:bg-indigo-900">Existem <strong>${totalVisitasAgendadas}</strong> visitas agendadas no sistema.</p>`;
        }
        
        insightsContent.innerHTML = insightsHTML || '<p>Não há dados suficientes para gerar insights.</p>';
    }
    function openReportModal() {
        const reportTypeSelect = document.getElementById('report-type');
        const financeOption = reportTypeSelect.querySelector('option[value="financeiro"]');

        if (loggedInUser && loggedInUser.Role === 'Gestor') {
            // Esconde a opção "Financeiro"
            financeOption.style.display = 'none';
            // Força a seleção de "Visitas"
            reportTypeSelect.value = 'visitas';
            // Desabilita o campo para que o Gestor não possa trocar
            reportTypeSelect.disabled = true;
        } else {
            // Garante que para Admins a opção esteja visível e o campo habilitado
            financeOption.style.display = '';
            reportTypeSelect.value = 'financeiro'; // Volta ao padrão
            reportTypeSelect.disabled = false;
        }

        // Continua com a lógica original de abrir o modal
        toggleReportSubtype();
        showModal(allElements.reportModal);
    }
    function toggleReportSubtype(){ const reportType = document.getElementById('report-type').value; const visitsFilters = document.getElementById('report-visits-filters'); let financeFilters = document.getElementById('report-finance-filters'); if (!financeFilters) { financeFilters = document.createElement('div'); financeFilters.id = 'report-finance-filters'; visitsFilters.parentElement.insertBefore(financeFilters, visitsFilters); financeFilters.innerHTML = ` <div> <label for="report-finance-status" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Status</label> <select id="report-finance-status" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white"> <option value="">Todos</option> <option value="Pago">Pago</option> <option value="Pendente">Pendente</option> </select> </div>`; } let visitsStatusFilter = document.getElementById('report-visits-status'); if (!visitsStatusFilter) { const statusDiv = document.createElement('div'); visitsFilters.appendChild(statusDiv); statusDiv.innerHTML = ` <label for="report-visits-status" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Status da Visita</label> <select id="report-visits-status" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-gold focus:border-brand-gold block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white"> <option value="">Todos</option> <option value="Agendada">Agendada</option> <option value="Em Andamento">Em Andamento</option> <option value="Concluída">Concluída</option> </select> `; } document.getElementById('report-subtype').parentElement.style.display = 'none'; if (reportType === 'visitas') { visitsFilters.classList.remove('hidden'); financeFilters.classList.add('hidden'); } else { visitsFilters.classList.add('hidden'); financeFilters.classList.remove('hidden'); } }
    function generatePdfReport(e){ e.preventDefault(); const startDate = document.getElementById('report-start-date').value; const endDate = document.getElementById('report-end-date').value; if (!startDate || !endDate) { alert('Por favor, preencha as datas de início e fim do período para gerar o relatório.'); return; } const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' }); const type = document.getElementById('report-type').value; doc.setFontSize(18); doc.text(`Relatório de ${type.charAt(0).toUpperCase() + type.slice(1)}`, 14, 22); doc.setFontSize(11); doc.setTextColor(100); doc.text(`Período: ${new Date(startDate+'T00:00:00').toLocaleDateString('pt-BR')} a ${new Date(endDate+'T00:00:00').toLocaleDateString('pt-BR')}`, 14, 30); if (type === 'financeiro') { const status = document.getElementById('report-finance-status').value; generateFinanceReport(doc, { startDate, endDate, status }); } else if (type === 'visitas') { const consultorId = document.getElementById('report-consultor').value; const clienteId = document.getElementById('report-cliente').value; const status = document.getElementById('report-visits-status').value; generateVisitReport(doc, { startDate, endDate, consultorId, clienteId, status }); } doc.save(`relatorio_${type}_${new Date().toISOString().slice(0,10)}.pdf`); hideModal(allElements.reportModal); }
    function generateFinanceReport(doc, filters) { const { startDate, endDate, status } = filters; const f = v => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); let finalY = 40; const baseReceitas = receitasData.filter(r => (!startDate || r.Vencimento >= startDate) && (!endDate || r.Vencimento <= endDate)); const baseCustos = custosData.filter(c => (!startDate || c.Vencimento >= startDate) && (!endDate || c.Vencimento <= endDate)); const drawTable = (title, head, body) => { if (body.length > 0) { doc.setFontSize(12); doc.text(title, 14, finalY); finalY += 2; doc.autoTable({ startY: finalY, head: [head], body: body, theme: 'striped', headStyles: { fillColor: [55, 55, 55] } }); finalY = doc.autoTable.previous.finalY + 10; } }; if (status === "" || status === "Todos") { const receitasPagas = baseReceitas.filter(r => r.Status === 'Pago'); const receitasPendentes = baseReceitas.filter(r => r.Status === 'Pendente'); const custosPagos = baseCustos.filter(c => c.Status === 'Pago'); const custosPendentes = baseCustos.filter(c => c.Status === 'Pendente'); drawTable('Receitas Pagas', ['Cliente', 'Vencimento', 'Valor'], receitasPagas.map(r => [r.Clientes?.Nome || 'N/A', new Date(r.Vencimento+'T00:00:00').toLocaleDateString('pt-BR'), f(r.Valor)])); drawTable('Custos Pagos', ['Credor', 'Vencimento', 'Valor'], custosPagos.map(c => [c.Credor, new Date(c.Vencimento+'T00:00:00').toLocaleDateString('pt-BR'), f(c.Valor)])); drawTable('Receitas Pendentes', ['Cliente', 'Vencimento', 'Valor'], receitasPendentes.map(r => [r.Clientes?.Nome || 'N/A', new Date(r.Vencimento+'T00:00:00').toLocaleDateString('pt-BR'), f(r.Valor)])); drawTable('Custos Pendentes', ['Credor', 'Vencimento', 'Valor'], custosPendentes.map(c => [c.Credor, new Date(c.Vencimento+'T00:00:00').toLocaleDateString('pt-BR'), f(c.Valor)])); } else { const filteredReceitas = baseReceitas.filter(r => r.Status === status); const filteredCustos = baseCustos.filter(c => c.Status === status); drawTable(`Receitas com Status: ${status}`, ['Cliente', 'Vencimento', 'Valor'], filteredReceitas.map(r => [r.Clientes?.Nome || 'N/A', new Date(r.Vencimento+'T00:00:00').toLocaleDateString('pt-BR'), f(r.Valor)])); drawTable(`Custos com Status: ${status}`, ['Credor', 'Vencimento', 'Valor'], filteredCustos.map(c => [c.Credor, new Date(c.Vencimento+'T00:00:00').toLocaleDateString('pt-BR'), f(c.Valor)])); } if (finalY > 250) doc.addPage(); const totalReceitas = baseReceitas.reduce((sum, r) => sum + r.Valor, 0); const totalCustos = baseCustos.reduce((sum, c) => sum + c.Valor, 0); const balanco = totalReceitas - totalCustos; doc.setFontSize(12); doc.text('Resumo Financeiro do Período', 14, finalY); doc.setFontSize(10); doc.text(`Total de Receitas: ${f(totalReceitas)}`, 14, finalY + 7); doc.text(`Total de Custos: ${f(totalCustos)}`, 14, finalY + 14); doc.setFontSize(12); doc.setFont('helvetica', 'bold'); doc.text(`Balanço Final: ${f(balanco)}`, 14, finalY + 21); }
    function generateVisitReport(doc, filters) { const { startDate, endDate, consultorId, clienteId, status } = filters; let finalY = 40; let filteredVisitas = visitsData.filter(v => (!startDate || v.DataVisita >= startDate) && (!endDate || v.DataVisita <= endDate) && (!consultorId || v.Consultores?.Id == consultorId) && (!clienteId || v.Clientes?.Id == clienteId) ); if (consultorId) { const c = consultoresData.find(c => c.Id == consultorId); if(c) doc.text(`Consultor: ${c.Nome}`, 14, finalY); finalY += 8;} if (clienteId) { const c = clientesData.find(c => c.Id == clienteId); if(c) doc.text(`Cliente: ${c.Nome}`, 14, finalY); finalY += 8;} if (finalY > 40) finalY += 4; const drawTable = (title, data) => { if (data.length > 0) { doc.setFontSize(12); doc.text(title, 14, finalY); finalY += 2; doc.autoTable({ startY: finalY, head: [['Cliente', 'Consultor', 'Data', 'Horário']], body: data.map(v => [ v.Clientes?.Nome || 'N/A', v.Consultores?.Nome || 'N/A', new Date(v.DataVisita+'T00:00:00').toLocaleDateString('pt-BR'), `${v.HoraInicio} - ${v.HoraFim}`]), theme: 'striped', headStyles: { fillColor: [55, 55, 55] } }); finalY = doc.autoTable.previous.finalY + 10; } }; if (!status || status === "Todos") { const statusGroups = ['Agendada', 'Em Andamento', 'Concluída']; statusGroups.forEach(s => { const groupData = filteredVisitas.filter(v => v.Status === s); drawTable(`Visitas ${s}s`, groupData); }); } else { filteredVisitas = filteredVisitas.filter(v => v.Status === status); drawTable(`Visitas com Status: ${status}`, filteredVisitas); } if (filteredVisitas.length === 0) { doc.text('Nenhuma visita encontrada para os filtros selecionados.', 14, finalY); return; } if (finalY > 250) doc.addPage(); const totalMinutos = filteredVisitas.filter(v => v.Status === 'Concluída').reduce((sum, v) => sum + calculateDuration(v), 0); doc.setFontSize(12); doc.text('Resumo das Visitas', 14, finalY); doc.setFontSize(10); doc.text(`Total de Visitas no Relatório: ${filteredVisitas.length}`, 14, finalY + 7); doc.text(`Total de Horas Concluídas: ${Math.floor(totalMinutos/60)}h ${Math.round(totalMinutos%60)}m`, 14, finalY + 14); }
    function handleTableDelete(button) {
    const dataContainer = button.closest('[data-id]');
    if (!dataContainer) return;
    const id = parseInt(dataContainer.dataset.id);
    const type = button.dataset.type;
    if (type) {
        activeDeleteItem = { id, type, element: dataContainer };
        showModal(allElements.deleteConfirmModal);
    }
}

    // --- Inicialização ---
    function initializeApp() {
        ['dash-cos-status', 'dash-cos-credor', 'dash-cos-start', 'dash-cos-end'].forEach(id => document.getElementById(id)?.addEventListener('input', updateCustosDashboard));
        ['dash-rec-status', 'dash-rec-cliente', 'dash-rec-start', 'dash-rec-end'].forEach(id => document.getElementById(id)?.addEventListener('change', updateReceitasDashboard));
        document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
['dash-visit-start', 'dash-visit-end', 'dash-visit-consultor', 'dash-visit-cliente'].forEach(id => document.getElementById(id)?.addEventListener('change', updateVisitsDashboard));
        // Ajustes de UI via JS
        const reqTabButton = document.querySelector('#requisicao-tabs button[data-target="itens-requisicao-content"]');
        if(reqTabButton) {
            reqTabButton.firstChild.nodeValue = 'Catálogo de Itens '; 
        }
        const newItemButton = document.getElementById('show-category-form');
        if(newItemButton) {
            newItemButton.textContent = 'Novo Item';
            newItemButton.id = 'show-new-item-btn'; 
        }

        const filterReqTipo = document.getElementById('filter-req-tipo');
        if (filterReqTipo) filterReqTipo.parentElement.style.display = 'none';

        const formReqTipo = document.getElementById('requisicao-tipo');
        if (formReqTipo) formReqTipo.parentElement.style.display = 'none';
        
        const episFields = document.getElementById('epis-fields');
        if(episFields) episFields.style.display = 'none';

        const addCategoryBtn = document.getElementById('add-consumo-category-btn');
        if(addCategoryBtn) addCategoryBtn.style.display = 'none';


        allElements.loginForm?.addEventListener('submit', handleLogin);
        document.body.addEventListener('click', handleGlobalClick);
        document.querySelectorAll('form').forEach(form => { 
            if (form.id === 'report-form') { form.addEventListener('submit', generatePdfReport); } 
            else if (form.id !== 'login-form') { form.addEventListener('submit', handleFormSubmit); }
        });
        document.getElementById('confirm-delete-btn')?.addEventListener('click', handleDelete);
        
        document.querySelectorAll('.dash-fin-quick-filter').forEach(btn => btn.addEventListener('click', (e) => setDateFilter(e, 'fin')));
        document.querySelectorAll('.dash-visit-quick-filter').forEach(btn => btn.addEventListener('click', (e) => setDateFilter(e, 'visit')));
        ['dash-fin-status', 'dash-fin-start', 'dash-fin-end'].forEach(id => document.getElementById(id)?.addEventListener('change', updateFinanceDashboard));
        ['dash-visit-start', 'dash-visit-end'].forEach(id => document.getElementById(id)?.addEventListener('change', updateVisitsDashboard));
        document.getElementById('report-type')?.addEventListener('change', toggleReportSubtype);
        
        ['filter-receita-start-date', 'filter-receita-end-date', 'filter-receita-cliente', 'filter-receita-status'].forEach(id => document.getElementById(id)?.addEventListener('change', applyAndRenderReceitas));
        ['filter-custo-start-date', 'filter-custo-end-date', 'filter-custo-credor', 'filter-custo-status'].forEach(id => document.getElementById(id)?.addEventListener('change', applyAndRenderCustos));
        
        ['ferias-filter-name', 'ferias-filter-start', 'ferias-filter-end'].forEach(id => document.getElementById(id)?.addEventListener('input', applyAndRenderFerias));
        ['atestados-filter-name', 'atestados-filter-start', 'atestados-filter-end'].forEach(id => document.getElementById(id)?.addEventListener('input', applyAndRenderAtestados));
        ['epis-filter-name', 'epis-filter-start', 'epis-filter-end'].forEach(id => document.getElementById(id)?.addEventListener('input', applyAndRenderEpis));
        ['ativos-filter-name', 'ativos-filter-start', 'ativos-filter-end'].forEach(id => document.getElementById(id)?.addEventListener('input', applyAndRenderAtivos));

        document.getElementById('rh-search')?.addEventListener('input', applyConsultorFilters);
    document.getElementById('consultor-status-filters')?.addEventListener('click', e => {
        if(e.target.classList.contains('consultor-status-filter-btn')) {
            document.querySelectorAll('.consultor-status-filter-btn').forEach(btn => btn.classList.remove('filter-btn-active'));
            e.target.classList.add('filter-btn-active');
            applyConsultorFilters();
        }
    });
        document.getElementById('cliente-search')?.addEventListener('input', applyClienteFilters);
        document.getElementById('cliente-status-filters')?.addEventListener('click', e => {
            if(e.target.classList.contains('cliente-status-filter-btn')) {
                document.querySelectorAll('.cliente-status-filter-btn').forEach(btn => btn.classList.remove('filter-btn-active'));
                e.target.classList.add('filter-btn-active');
                applyClienteFilters();
            }
        });
        // Cole esta função e o event listener dentro da sua função initializeApp()

    function checkCalendarViewOnResize() {
        const isMobile = window.innerWidth < 1024;
        const calendarView = document.getElementById('calendar-view');
        const kanbanButton = document.querySelector('button[data-view="kanban-view"]');

        // Se estiver no modo mobile e a visualização de calendário estiver ativa...
        if (isMobile && calendarView && !calendarView.classList.contains('hidden')) {
            // ...muda para a visualização Kanban por padrão.
            document.querySelectorAll('.visitas-view').forEach(v => v.classList.add('hidden'));
            document.getElementById('kanban-view').classList.remove('hidden');

            // Atualiza o estilo dos botões para refletir a nova visualização ativa
            document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('bg-white', 'dark:bg-gray-800', 'shadow-sm'));
            if (kanbanButton) {
                kanbanButton.classList.add('bg-white', 'dark:bg-gray-800', 'shadow-sm');
            }
        }
    }

    // Adiciona o listener para executar a função sempre que a janela for redimensionada
    window.addEventListener('resize', checkCalendarViewOnResize);
    window.handleEditItemQuantity = handleEditItemQuantity;
    window.handleDeleteItemFromRequisition = handleDeleteItemFromRequisition;
    window.showImageModal = showImageModal;

        checkSession();

    }

    initializeApp();
});
</script>
</body>
</html>